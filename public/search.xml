<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>daily problems</title>
    <url>/2022/08/30/daily-problems/</url>
    <content><![CDATA[<h1 id="npm"><a href="#npm" class="headerlink" title="npm"></a>npm</h1><blockquote>
<p>npm run scripts</p>
</blockquote>
<p>  ä¸ºä½• npm æ‰§è¡Œ package.json ä¸­çš„ scripts å‘½ä»¤æ—¶,å³ä½¿å…¨å±€ç¯å¢ƒå˜é‡ä¸‹ä¸å­˜åœ¨çš„è„šæœ¬å‘½ä»¤ä¹Ÿèƒ½æ‰§è¡Œ?</p>
<p>  è§£: é¦–å…ˆ npm run package.json ä¸­çš„ scripts è„šæœ¬å‘½ä»¤æ—¶,ä¼šæ–°å»ºä¸€ä¸ª shell è„šæœ¬,å¹¶å°† scripts ä¸­çš„è„šæœ¬å‘½ä»¤æ”¾å…¥å…¶ä¸­æ‰§è¡Œ,å› æ­¤ shell å‘½ä»¤(ä¸€èˆ¬æ˜¯ bash)å®Œå…¨å¯ä»¥æ‰§è¡Œ;å…¶æ¬¡,shell å‘½ä»¤æ‰§è¡Œæ—¶,node_modules/.bin å­ç›®å½•ä¸‹çš„æ‰€æœ‰å¯æ‰§è¡Œè„šæœ¬å‘½ä»¤ä¼šæ”¾å…¥è‡³ $PATH å…¨å±€ç¯å¢ƒå˜é‡ä¸­,ç­‰åˆ° shell å‘½ä»¤æ‰§è¡Œå®Œæ¯•,$PATH æ‰ä¼šæ¢å¤åŸæ ·.æœ€å node_modules/.bin å­ç›®å½•ä¸‹çš„æ‰€æœ‰å¯æ‰§è¡Œè„šæœ¬å‘½ä»¤å®é™…ä¸Šæ˜¯ä¸ node_modules ä¸‹å¯æ‰§è¡Œæ¨¡å—å»ºç«‹äº†è½¯é“¾æ¥çš„,å› æ­¤åœ¨ node æ­¤ç±»é¡¹ç›®ä¸‹,å³ä½¿å…¨å±€ç¯å¢ƒå˜é‡ä¸‹ä¸å­˜åœ¨çš„è„šæœ¬å‘½ä»¤,ä¾ç„¶å¯ä»¥é€šè¿‡ node_modules ä¸­çš„å¯æ‰§è¡Œæ¨¡å—åœ¨å½“å‰é¡¹ç›®ä¸‹è½¬åŒ–æ‰§è¡Œ.</p>
<p>  çº¿æ€§å›¾: node_modules/(å¯æ‰§è¡Œæ¨¡å—) -&gt; é€šè¿‡è½¯é“¾æ¥ =&gt; node_modules/.bin/(å¯æ‰§è¡Œè„šæœ¬å‘½ä»¤) -&gt; é€šè¿‡ shell è„šæœ¬å‘½ä»¤æ‰§è¡Œ(æ·»åŠ è‡³ $PATH å…¨å±€ç¯å¢ƒå˜é‡) =&gt; å³ä½¿å…¨å±€ç¯å¢ƒå˜é‡ä¸‹ä¸å­˜åœ¨çš„è„šæœ¬å‘½ä»¤ä¹Ÿèƒ½æ‰§è¡Œ.</p>
<h1 id="javascript"><a href="#javascript" class="headerlink" title="javascript"></a>javascript</h1><blockquote>
<p>é—­åŒ…</p>
</blockquote>
<p>  ä»€ä¹ˆæ˜¯é—­åŒ…?</p>
<p>  è§£: A å‡½æ•°å†…åŒ…è£¹ B å‡½æ•°,B å‡½æ•°åœ¨é A å‡½æ•°ä½œç”¨åŸŸå†…å®è¡Œè°ƒç”¨,ä¾ç„¶èƒ½å¤Ÿä½¿ç”¨æˆ–è€…è°ƒç”¨ A å‡½æ•°å†…çš„å˜é‡æˆ–è€…å‡½æ•°,è¿™å°±æ˜¯é—­åŒ….</p>
<h1 id="webpack"><a href="#webpack" class="headerlink" title="webpack"></a>webpack</h1><blockquote>
<p>terser-webpack-plugin</p>
</blockquote>
<p>  ä¼—æ‰€å‘¨çŸ¥,åœ¨ webpack 4.xä»¥åŠä¹‹åçš„ç‰ˆæœ¬,å¼€å¯ mode: â€˜productionâ€™,ç›¸å½“äºé»˜è®¤æ·»åŠ äº† terser-webpack-plugin,ä¼šè‡ªåŠ¨ä¸ºæ„å»ºæ‰“åŒ…æ–‡ä»¶å‹ç¼©æ··æ·†.é‚£ä¹ˆæœ‰æ—¶ä¼šå‘ç°å¼€å¯äº† mode: â€˜productionâ€™,å´ä¸èƒ½å®ç°å‹ç¼©æ··æ·†,è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢?</p>
<p>  è§£: åŸå› å¾ˆæœ‰å¯èƒ½åœ¨ optimization.minimizer é‡Œ,æœ‰æ—¶ä¼šåœ¨é‡Œé¢é…ç½®ä¸€äº›å¯¹å…¶ä»–èµ„æºæ¨¡å—çš„å‹ç¼©ç­‰åŠŸèƒ½çš„æ’ä»¶,è€Œå¿˜è®° minimizer å±æ€§å€¼æœ¬èº«ä¼šå¯¹é»˜è®¤å€¼è¿›è¡Œè¦†ç›–,å¯¼è‡´é»˜è®¤å¼€å¯çš„ terser-webpack-plugin ä¸ç”Ÿæ•ˆ,é‚£ä¹ˆåœ¨è¿™æ—¶å€™éœ€è¦å¯¹é»˜è®¤å€¼è¿›è¡Œåˆå¹¶,åœ¨ minimizer çš„æœ€åæ·»åŠ  â€˜â€¦â€™ å…ƒç´ å°±å¯ç”Ÿæ•ˆ.</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">      <span class="attr">minimizer</span>: [</span><br><span class="line">          <span class="comment">//...</span></span><br><span class="line">          <span class="string">&#x27;...&#x27;</span></span><br><span class="line">      ]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ssr"><a href="#ssr" class="headerlink" title="ssr"></a>ssr</h1><blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>  ssr æœåŠ¡ç«¯æ¸²æŸ“ç›¸å¯¹äºæµè§ˆå™¨å®¢æˆ·ç«¯æ¸²æŸ“,å…¶ä½œç”¨æ˜¯ä»€ä¹ˆ?åˆæœ‰ä»€ä¹ˆä¼˜åŠ¿?</p>
<ul>
<li>HTML æ¨¡æ¿ä»¥åŠæ•°æ®ç­‰èµ„æºéƒ½å­˜æ”¾äºæœåŠ¡ç«¯,å†…ç½‘æ‹‰å–èµ„æºé€Ÿåº¦æ›´å¿«.</li>
<li>ç›¸æ¯”äºæµè§ˆå™¨åŠ è½½ HTML ä»¥åŠæ¥å£æ•°æ®ç­‰å¤šä¸ªèµ„æºè¯·æ±‚,ssr æœåŠ¡ç«¯æ¸²æŸ“åªéœ€è¦åŠ è½½æ‹¼è£…å¥½æ•°æ®çš„ä¸€ä¸ª HTML æ¨¡æ¿å³å¯,å¤§å¤§å‡å°‘äº†èµ„æºè¯·æ±‚æ¬¡æ•°.</li>
<li>å¯¹äºç”¨æˆ·æ¥è¯´,æœ€ç›´è§‚çš„å°±æ˜¯,å¤§å¤§å‡å°‘äº†é¡µé¢ç™½å±çš„æ—¶é—´;è€Œå¯¹äºå¼€å‘ä¸€æ–¹æ¥è®²,SEO çˆ¬è™«é¡µé¢è§£ææ›´å‹å¥½.</li>
</ul>
<h1 id="node"><a href="#node" class="headerlink" title="node"></a>node</h1><blockquote>
<p>__dirname</p>
</blockquote>
<p>  __dirname ä¸ process.cwd() çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: __dirname æŒ‡çš„æ˜¯å½“å‰æ–‡ä»¶æ‰€åœ¨çš„ä½ç½®ç›®å½•. process.cwd() æŒ‡çš„æ˜¯ node æ‰€ä½œç”¨çš„ä½ç½®ç›®å½•.é»˜è®¤å€¼ä¸ºå½“å‰é¡¹ç›®çš„æ ¹ç›®å½•,å¯ä»¥å®è¡Œä¿®æ”¹: process.chdir(//â€¦),ä¿®æ”¹å process.cwd() å°±ä¼šå‘ç”Ÿæ”¹å˜.</p>
]]></content>
      <categories>
        <category>problems</category>
      </categories>
      <tags>
        <tag>problems</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo next</title>
    <url>/2022/08/30/hexo-next/</url>
    <content><![CDATA[<h1 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h1><p><b>æ­¤åšå®¢ç”¨äºæ­å»º hexo next ä¸»é¢˜çš„å­—å…¸å·¥å…·ç±»åšå®¢.åŸºæœ¬ä¸ä¼šæ¢ç´¢æ·±ç©¶é…ç½®çš„åŸå› ,æ•¬è¯·çŸ¥æ‚‰~</b></p>
<h1 id="hexo-å®‰è£…"><a href="#hexo-å®‰è£…" class="headerlink" title="hexo å®‰è£…"></a>hexo å®‰è£…</h1><blockquote>
<p>æ­¥éª¤</p>
</blockquote>
<p>é¦–å…ˆè¦ç”¨ npm èµ„æºä¾èµ–ç®¡ç†å·¥å…·å®‰è£…å…¨å±€å‘½ä»¤ hexo-cli.</p>
<pre><code>npm install hexo-cli -g
</code></pre>
<p>ç„¶åä½¿ç”¨ hexo åˆå§‹åŒ–åšå®¢ç›®å½•,æ¯”å¦‚ blog ç›®å½•,ç›®å½•åè¦ä¸åç»­ä¸ªäººå»ºç«‹çš„ github ä¸Š hexo æ‰˜ç®¡ä»£ç çš„ repository åº“åŒå.</p>
<pre><code>hexo init blog
</code></pre>
<p>æ¥ç€ github å»ºåº“: å»ºç«‹ä¸€ä¸ªä»¥ w-t-w(æˆ‘çš„è´¦å·).github.io ç»“å°¾çš„ repository åº“,ä½œä¸º hexo æ‰˜ç®¡ä»£ç çš„åº“, github é»˜è®¤<br>.github.io ç»“å°¾ä½œä¸ºç”¨æˆ·çš„ç½‘ç«™äºŒçº§åŸŸå,å»ºç«‹ä¸€ä¸ªæ–°çš„åˆ†æ”¯ä½œä¸ºåˆ›ä½œåˆ†æ”¯(å› ä¸ºä¸»åˆ†æ”¯æ˜¯ç”¨æ¥å‘å¸ƒå‘ˆç°ç½‘ç«™çš„); ä¹‹å,è¿›å…¥ç”Ÿæˆçš„ blog<br>æ–‡ä»¶å¤¹,åœ¨æœ¬åœ°æ·»åŠ ä¸è¿œç¨‹ repository åº“é“¾æ¥å…³è”çš„å¥æŸ„ç®€ç§°,å¹¶è®¾ç½®æœ¬åœ°å¥æŸ„ç®€ç§°æ¨é€/åŒæ­¥è¿œç¨‹åº“ä¸Šæ¸¸çš„åˆ†æ”¯,ä¸è¿œç¨‹åº“å»ºç«‹å®‰å…¨å…³è”,æœ€ååŒæ­¥è¿œç¨‹æœ€æ–°èµ„æº.</p>
<pre><code>git remote add origin git@github.com:w-t-w/w-t-w.github.io.git
git pull --set-upstream origin master
</code></pre>
<p>å† npm ä¸‹è½½å¤–éƒ¨èµ„æºä¾èµ–åŒ….</p>
<pre><code>npm i/npm install
</code></pre>
<p>æˆ–è€…ä½¿ç”¨ yarn ä¸‹è½½å¤–éƒ¨èµ„æºä¾èµ–åŒ….</p>
<pre><code>yarn
</code></pre>
<p>æœ€åå¯åŠ¨ hexo è‡ªèº«æ­å»ºçš„æœåŠ¡,ç”Ÿæˆæœ¬åœ°çš„åšå®¢ç½‘ç«™æœåŠ¡,é»˜è®¤ç«¯å£åœ¨æœ¬åœ° ip åœ°å€ä¸‹çš„ 4000 ç«¯å£,å‡å¦‚ä½ ä¸æƒ³å¯åŠ¨åœ¨ 4000 ç«¯å£,ä¹Ÿå¯ä½¿ç”¨-p<br>å…¶ä»–ç«¯å£å·è¿›è¡Œé…ç½®,æ¯”å¦‚-p 9777.</p>
<pre><code>hexo server
hexo server -p 9777
</code></pre>
<p>PS: æœ€å¥½å…ˆå°†æœ¬åœ°ä»£ç ä¸Šä¼ è‡³è¿œç¨‹ä¹‹å,å†æ‰§è¡Œ hexo é…ç½®.</p>
<pre><code>git add .
git commit &#39;build:hexo next&#39;
git push
</code></pre>
<p>é»˜è®¤çš„ä¸»é¢˜é£æ ¼ theme æ˜¯ landscape<br>,å‡å¦‚ä½ æƒ³æ›´æ¢,å¯ä»¥é€šè¿‡<a href='https://hexo.io/themes/'>https://hexo.io/themes</a>è¿›è¡Œç­›é€‰,ç­›é€‰ä¹‹åè¿›è¡Œé…ç½®,ä¸»é¢˜é…ç½®è§ä¸‹æ–‡<br>.</p>
<h1 id="hexo-é…ç½®"><a href="#hexo-é…ç½®" class="headerlink" title="hexo é…ç½®"></a>hexo é…ç½®</h1><p>PS: ä»¥ä¸‹æ‰€è¯´çš„â€æ ¹ç›®å½•â€æŒ‡çš„å°±æ˜¯å½“å‰åˆ›ä½œçš„ repository ç›®å½•,â€ä¸»é¢˜ç›®å½•â€å°±æ˜¯æ ¹ç›®å½•ä¸‹/themesç›®å½•ä¸‹çš„ä¸»é¢˜ç¯å¢ƒ.</p>
<h4 id="hexo-deploy-å‘å¸ƒé…ç½®"><a href="#hexo-deploy-å‘å¸ƒé…ç½®" class="headerlink" title="hexo deploy å‘å¸ƒé…ç½®"></a>hexo deploy å‘å¸ƒé…ç½®</h4><p>å‘å¸ƒéƒ¨ç½²å¯ä»¥éƒ¨ç½²è‡³ Github Page ä¸ªäººç½‘ç«™,ä¹Ÿå¯ä»¥éƒ¨ç½²è‡³ä¸ªäººç”³è¯·è´­ä¹°çš„äº‘æœåŠ¡å™¨ä¸­.</p>
<p>ä¸€. éƒ¨ç½²è‡³ Github Page ä¸ªäººç½‘ç«™.</p>
<blockquote>
<p>æ­¥éª¤</p>
</blockquote>
<p>è¦æƒ³éƒ¨ç½²åˆ° Github Page ä¸ªäººç½‘ç«™,é¦–å…ˆè¦ä¸‹è½½ hexo-deployer-git æ’ä»¶.</p>
<pre><code>npm install hexo-deployer-git --save
</code></pre>
<p>ç„¶ååœ¨æ ¹ç›®å½•åº•ä¸‹çš„ _config.yml æ–‡ä»¶ä¸­æ›´æ”¹ deploy å‘å¸ƒé…ç½®,å°† source ç›®å½•ä¸‹é¢çš„å†…å®¹è¿›è¡Œæ„å»ºå‘å¸ƒåˆ° repository github<br>åœ°å€çš„ä¸»åˆ†æ”¯ä¸Š.</p>
<pre><code>deploy:
    type: git
    #ä½ çš„ä¸ªäººç½‘ç«™ github åº“çš„é“¾æ¥åœ°å€,æœ€å¥½ä½¿ç”¨ git@ å¼€å¤´çš„, https@ å¼€å¤´çš„ä¼šæŠ¥é”™
    repo: git@github.com:w-t-w/w-t-w.github.io.git
    #åˆ†æ”¯å
    branch: master
</code></pre>
<p>äºŒ. éƒ¨ç½²è‡³ä¸ªäººç”³è¯·è´­ä¹°çš„äº‘æœåŠ¡å™¨.</p>
<blockquote>
<p>æ­¥éª¤</p>
</blockquote>
<p>å°†ç”Ÿæˆçš„ç½‘ç«™åšå®¢é¡¹ç›®ç›´æ¥é€šè¿‡ <a href='https://filezilla-project.org' />Filezilla</a> è¿œç¨‹æœåŠ¡æ–‡ä»¶ä¼ è¾“å·¥å…·æ”¾å…¥äº‘æœåŠ¡å™¨ä¸­;æ¥ç€é€šè¿‡ <a href='https://macwk.com/soft/royal-tsx'>Royal TSX(ç ´è§£ç‰ˆğŸ˜œ)</a> è¿œç¨‹æœåŠ¡ç®¡ç†å·¥å…·å¯¹æœåŠ¡å™¨è¿›è¡Œæ·±åº¦ç®¡ç†,é“¾æ¥æˆåŠŸå,ä¸‹è½½ nginx ä»£ç†.</p>
<pre><code># è¿™é‡Œç›´æ¥ä½¿ç”¨é˜¿é‡Œäº‘CentOSæœåŠ¡å™¨ä¸­é»˜è®¤çš„åŸºäºRPMçš„è½¯ä»¶åŒ…ç®¡ç†å™¨yumæ¥ä¸‹è½½nginx
yum install nginx
</code></pre>
<p>ä¸‹è½½ä¹‹åæŸ¥çœ‹å…¨å±€å‘½ä»¤ nginx æ˜¯å¦å­˜åœ¨,æŸ¥çœ‹ nginx çš„ç‰ˆæœ¬.</p>
<pre><code>nginx -v
</code></pre>
<p>å¦‚æœå…¨å±€å‘½ä»¤ä¸å­˜åœ¨ nginx,åˆ™è¿è¡Œ source ~/.bash_profile,ä½¿å¾—é…ç½®åœ¨ä¿®æ”¹äº†ç¯å¢ƒå˜é‡çš„æƒ…å†µä¸‹è¿›è¡Œé‡ç½®.</p>
<pre><code>source ~/.bash_profile
</code></pre>
<p>å¯åŠ¨ nginx.</p>
<pre><code>nginx
</code></pre>
<ul>
<li><p>é¡ºä¾¿æä¸€ä¸‹ nginx çš„å…¶ä»–å‘½ä»¤.é‡å¯ nginx.</p>
<pre><code>nginx -s reload
</code></pre>
</li>
<li><p>åœæ­¢ nginx.</p>
<pre><code>nginx -s stop
</code></pre>
</li>
<li><p>é€šè¿‡æµ(pipe)æŸ¥è¯¢å…¨éƒ¨ç”¨æˆ·ç»„ nginx å®Œæ•´çš„è¿›ç¨‹çŠ¶æ€.</p>
<pre><code>ps -ef | grep nginx
</code></pre>
</li>
<li><p>å¼ºåˆ¶æ€æ‰ nginx è¿›ç¨‹.</p>
<pre><code>#28009æ˜¯ nginx è¿›ç¨‹å·,é€šè¿‡ ps -ef | grep nginx å¯ä»¥æŸ¥è¯¢åˆ°
kill -9 28009
</code></pre>
</li>
</ul>
<p>é…ç½® nginx,å°†æœåŠ¡å™¨ä»£ç† root é¡µé¢æŒ‡å‘åšå®¢ç½‘ç«™.</p>
<pre><code>#é€šè¿‡æµ‹è¯• nginx,æŸ¥è¯¢ nginx é…ç½®æ–‡ä»¶æ‰€åœ¨ç›®å½•
nginx -t
vim /etc/nginx/nginx.conf
</code></pre>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">...</span></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80 default_server;</span><br><span class="line">    listen       [::]:80 default_server;</span><br><span class="line">    #åŸŸåé…ç½®,éœ€è¦ç”³è¯·è´­ä¹°å¤‡æ¡ˆ(å›½å†…åŸŸåéœ€è¦å¤‡æ¡ˆ,å›½å¤–åŸŸååˆ™ä¸éœ€è¦)</span><br><span class="line">    server_name  localhost;</span><br><span class="line">    #ä¿®æ”¹rooté¡µé¢æŒ‡å‘ç½‘ç«™åšå®¢é¡¹ç›®</span><br><span class="line">    root         /root/w-t-w;</span><br><span class="line"></span><br><span class="line">    # Load configuration files for the default server block.</span><br><span class="line">    include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index index.html index.htm;</span><br><span class="line">        # å°† router è·¯ç”±ä¸­ä¸å­˜åœ¨çš„é¡µé¢é‡å®šå‘è‡³ index.html.</span><br><span class="line">        try_files $uri $uri/ /index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 404 /404.html;</span><br><span class="line">        location = /40x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page 500 502 503 504 /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">...</span></span><br></pre></td></tr></table></figure>

<p>é€šè¿‡é˜¿é‡Œäº‘å¹³å°å‘äº‘æœåŠ¡å™¨æ·»åŠ å®‰å…¨ç»„,å¼€æ”¾ 80(HTTP) ç«¯å£å’Œ 443(HTTPS) ç«¯å£.</p>
<p><img src="https://image.white-than-wood.zone/hexo/security_group.png"></p>
<p>é…ç½®å®Œä¹‹å,åŸºæœ¬å¯ä»¥é€šè¿‡ ip æ¥è¿›è¡Œè®¿é—®åšå®¢ç½‘ç«™.ä½†è¦æƒ³å®ç°é€šè¿‡åŸŸåæ¥è®¿é—®è¿˜éœ€è¦å®è¡ŒåŸŸåè§£æ,é€šè¿‡ Aè®°å½• å°†åŸŸåæŒ‡å‘ä¸€ä¸ª IPV4 åœ°å€,ä¹Ÿå°±æ˜¯è´­ä¹°çš„é˜¿é‡Œäº‘æœåŠ¡å™¨ ECS ip.</p>
<p><img src="https://image.white-than-wood.zone/hexo/hexo_dns.png"></p>
<pre><code>&#39;@&#39; æ˜¯æºåŸŸå(ä¸»åŸŸå white-than-wood.zone).
&#39;www&#39; åˆ™æ˜¯ www.white-than-wood.zone.
</code></pre>
<p>è¿™æ ·å°±å¯ä»¥å®ç°é€šè¿‡åŸŸåæ¥è®¿é—®åšå®¢ç½‘ç«™,ä½†å¹¶æ²¡æœ‰å¼€å¯ SSL è¯ä¹¦,ä¹Ÿå°±æ˜¯å¹¶æ²¡æœ‰å¯åŠ¨ https,è¦æƒ³å®Œæ•´å®ç°å¼€å¯ SSL è¯ä¹¦çš„åŸŸåè¿˜éœ€è¦ç”³è¯· SSL è¯ä¹¦ä»¥åŠå†æ¬¡é…ç½® nginx.</p>
<p>ä¸€. SSL è¯ä¹¦</p>
<p>é€šè¿‡é˜¿é‡Œäº‘å¹³å°è´­ä¹°æˆ–è€…å…è´¹ç”³è¯·,å¯ä»¥è·å¾— SSL è¯ä¹¦,è¿™é‡Œç”³è¯·çš„æ˜¯ä¸€å¹´æœŸé™çš„æ™®é€šç‰ˆ DV SSL è¯ä¹¦.</p>
<p><img src="https://image.white-than-wood.zone/hexo/hexo_ssl.png"></p>
<p>å°†ç”³è¯·å¥½çš„ SSL è¯ä¹¦ä¸‹è½½å¹¶é€šè¿‡ Filezilla ä¼ è¾“è‡³è¿œç¨‹æœåŠ¡å™¨ä¸­,æ¥ç€é…ç½® nginx.</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">For more information on configuration, see:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  * Official English Documentation: http://nginx.org/en/docs/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  * Official Russian Documentation: http://nginx.org/ru/docs/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¿™é‡Œæ¯”è¾ƒç®€å•ç²—æš´çš„å°†ç”¨æˆ·ç»„ç½®ä¸º root root,ä½¿å¾— nginx å¯ä»¥è®¿é—®å¸¦æœ‰ root æƒé™çš„æ–‡ä»¶ä»¥åŠæ–‡ä»¶å¤¹.</span></span><br><span class="line">user root;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log /var/log/nginx/error.log;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.</span></span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">    &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">    &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile             on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    # Load modular configuration files from the /etc/nginx/conf.d directory.</span><br><span class="line">    # See http://nginx.org/en/docs/ngx_core_module.html#include</span><br><span class="line">    # for more information.</span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line">    </span><br><span class="line">    # http é…ç½®</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        listen       [::]:80 default_server;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        root         /root/w-t-w;</span><br><span class="line"></span><br><span class="line">        # Load configuration files for the default server block.</span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">	        index index.html;</span><br><span class="line">	        # å°† router è·¯ç”±ä¸­ä¸å­˜åœ¨çš„é¡µé¢é‡å®šå‘è‡³ index.html.</span><br><span class="line">	        try_files $uri /$uri /index.html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">            location = /40x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">            location = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # Settings for a TLS enabled server.</span><br><span class="line">    # https é…ç½®,æ·»åŠ  SSL è¯ä¹¦.</span><br><span class="line">    server &#123;</span><br><span class="line">        # https è®¿é—®ç«¯å£ä¸€èˆ¬ä¸º 443 ç«¯å£</span><br><span class="line">        listen       443 ssl http2 default_server;</span><br><span class="line">        listen       [::]:443 ssl http2 default_server;</span><br><span class="line">        # å¼€å¯ SSL è¯ä¹¦</span><br><span class="line">        ssl          on;</span><br><span class="line">        # SSL è¯ä¹¦ç»‘å®šçš„åŸŸå</span><br><span class="line">        server_name  white-than-wood.zone www.white-than-wood.zone;</span><br><span class="line">        root         /root/w-t-w;</span><br><span class="line">        </span><br><span class="line">        # SSL è¯ä¹¦å…·ä½“é…ç½®</span><br><span class="line">        # è¯ä¹¦æ–‡ä»¶é…ç½®,è¯ä¹¦æ–‡ä»¶ä½ç½®ç›®å½•å¿…é¡»ä¸ºç»å¯¹è·¯å¾„</span><br><span class="line">        ssl_certificate           &quot;/etc/nginx/cert/xxxx_white-than-wood.zone.pem&quot;;</span><br><span class="line">        ssl_certificate_key       &quot;/etc/nginx/cert/xxxx_white-than-wood.zone.key&quot;;</span><br><span class="line">        # SSL è¯ä¹¦ç¼“å­˜æœ‰æ•ˆæœŸ</span><br><span class="line">        ssl_session_timeout       5m;</span><br><span class="line">        # å®‰å…¨é“¾æ¥å¯é€‰çš„åŠ å¯†åè®®</span><br><span class="line">        ssl_protocols             TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">        # å®‰å…¨é“¾æ¥åŠ å¯†ç®—æ³•</span><br><span class="line">        ssl_ciphers               ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span><br><span class="line">        # ä½¿ç”¨æœåŠ¡å™¨ç«¯çš„é¦–é€‰ç®—æ³•</span><br><span class="line">        ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line">        # Load configuration files for the default server block.</span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">	        index index.html;</span><br><span class="line">	        # å°† router è·¯ç”±ä¸­ä¸å­˜åœ¨çš„é¡µé¢é‡å®šå‘è‡³ index.html.</span><br><span class="line">	        try_files $uri $uri/ /index.html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">	    location = /login/oauth/access_token &#123;</span><br><span class="line">            add_header Access-Control-Allow-Origin &#x27;https://white-than-wood.zone/&#x27;;</span><br><span class="line">            add_header Access-Control-Allow-Methods &#x27;GET, POST, OPTIONS&#x27;;</span><br><span class="line">            add_header Access-Control-Allow-Headers &#x27;DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization&#x27;;</span><br><span class="line">            if ($request_method = &#x27;OPTIONS&#x27;) &#123;</span><br><span class="line">                return 204;</span><br><span class="line">            &#125;</span><br><span class="line">            proxy_pass https://github.com/;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">            location = /40x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">            location = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡å¯ä¸€ä¸‹ nginx,æœ€åç›´æ¥è®¿é—® <a href="https://white-than-wood.zone/">https://white-than-wood.zone</a> ~ Bingo!!</p>
<p><img src="https://image.white-than-wood.zone/hexo/hexo_https_bingo.png"></p>
<h4 id="hexo-theme-ä¸»é¢˜é…ç½®"><a href="#hexo-theme-ä¸»é¢˜é…ç½®" class="headerlink" title="hexo theme ä¸»é¢˜é…ç½®"></a>hexo theme ä¸»é¢˜é…ç½®</h4><blockquote>
<p>ç¤ºä¾‹</p>
</blockquote>
<p>ç­›é€‰å¥½ä¸ªäººé€‰ä¸­çš„ä¸»é¢˜ä¹‹å,å°±éœ€è¦åœ¨é¡¹ç›®é‡Œé¢è¿›è¡Œé…ç½®æ›´æ¢ã€‚é¦–å…ˆéœ€è¦ä¸‹è½½è¿œç¨‹ github åº“é‡Œé¢çš„ä¸»é¢˜é¡¹ç›®åˆ°é¡¹ç›®æ ¹ç›®å½•é‡Œé¢çš„ themes<br>æ–‡ä»¶å¤¹åº•ä¸‹,æ¯”å¦‚æœ¬äººç”¨çš„æ˜¯ next ä¸»é¢˜çš„ hexo.</p>
<pre><code># æ³¨æ„ hexo 6.x ä¹‹å‰ä¸‹è½½ next ä¸»é¢˜è¿œç¨‹ github é“¾æ¥ä¸ hexo 6.x ä¹‹åä¸åŒ!
# hexo 6.x ä¹‹å‰
git clone https://github.com/iissnan/hexo-theme-next.git themes/next
# hexo 6.x ä¹‹å
git clone https://github.com/theme-next/hexo-theme-next themes/next
</code></pre>
<img src='https://image.white-than-wood.zone/hexo/next_theme.png' style='width: 100%; height: auto;'/>

<p>éšååœ¨æ ¹ç›®å½•é‡Œé¢çš„ _config.yml æ–‡ä»¶ä¸­æ›´æ”¹ theme é…ç½®.</p>
<pre><code>theme: next
</code></pre>
<p>æ¥ç€é€‰æ‹©ä¸»é¢˜å±•ç¤ºçš„æ–¹å¼,éœ€è¦åœ¨ä¸»é¢˜ç›®å½•ä¸‹,åœ¨ _config.yml æ–‡ä»¶ä¸­æ›´æ”¹ Scheme é…ç½®,æ¯”å¦‚ next ä¸»é¢˜åº•ä¸‹çš„ Scheme é…ç½®.</p>
<pre><code>scheme:
    #scheme: Muse
    #scheme: Mist
    scheme: Pisces
    #scheme: Gemini
</code></pre>
<h4 id="hexo-language-è¯­è¨€é…ç½®"><a href="#hexo-language-è¯­è¨€é…ç½®" class="headerlink" title="hexo language è¯­è¨€é…ç½®"></a>hexo language è¯­è¨€é…ç½®</h4><blockquote>
<p>æ­¥éª¤</p>
</blockquote>
<p>æ¯ä¸ªä¸»é¢˜çš„è¯­è¨€éƒ½æ˜¯æ ¹æ®åšå®¢ä½œè€…çš„æ¯è¯­æ¥é…ç½®çš„,è¦æƒ³é…ç½®å¼€å‘è€…ä¸ªäººå›½å®¶çš„è¯­è¨€,è¿˜æ˜¯åœ¨é¡¹ç›®æ ¹ç›®å½•åº•ä¸‹çš„ _config.yml æ–‡ä»¶ä¸­æ›´æ”¹<br>language é…ç½®.</p>
<pre><code>language: zh-CN
</code></pre>
<p>å†åœ¨ä¸»é¢˜ç›®å½•åº•ä¸‹çš„ _config.yml æ–‡ä»¶ä¸­æ›´æ”¹ language é…ç½®.</p>
<pre><code>language: zh-CN
</code></pre>
<h4 id="hexo-page-é¡µé¢é…ç½®"><a href="#hexo-page-é¡µé¢é…ç½®" class="headerlink" title="hexo page é¡µé¢é…ç½®"></a>hexo page é¡µé¢é…ç½®</h4><blockquote>
<p>æ­¥éª¤</p>
</blockquote>
<p>hexo æä¾›äº†å‡ ä¸ªå¯ä¾›ç­›é€‰çš„é¡µé¢,å¸¸ç”¨çš„æœ‰è¿™ä¹ˆå‡ ä¸ªï¼šhome(é¦–é¡µ)ã€tags(æ ‡ç­¾)ã€about(å…³äºæˆ‘)ã€archives(æ¡£æ¡ˆ)å’Œcategories(åˆ†ç±»)<br>,é¦–å…ˆè¦åˆ›å»ºé¡µé¢.</p>
<pre><code>hexo new page tags
hexo new page about
hexo new page archives
hexo new page categories
</code></pre>
<p>æ¥ç€åœ¨ä¸»é¢˜ç›®å½•ä¸‹,åœ¨ _config.yml æ–‡ä»¶ä¸­æ›´æ”¹ menu é…ç½®,å½“ç„¶æ¯ä¸ªä¸»é¢˜çš„é…ç½®ä¸å°½ç›¸åŒ.</p>
<pre><code>menu:
    home: / || fa fa-home
    about: /about/ || fa fa-user
    tags: /tags/ || fa fa-tags
    categories: /categories/ || fa fa-th
    archives: /archives/ || fa fa-archive
</code></pre>
<p>éšåæ›´æ”¹ source ç›®å½•åº•ä¸‹åˆ›å»ºçš„é¡µé¢é…ç½®,ä»¥ tags ä¸ºä¾‹.</p>
<pre><code>----------------------------
    title: æ ‡ç­¾
    date: 2018-04-24 17:57:26
    type: &quot;tags&quot;
    comments: false
----------------------------
</code></pre>
<h4 id="hexo-avatar-å¤´åƒé…ç½®"><a href="#hexo-avatar-å¤´åƒé…ç½®" class="headerlink" title="hexo avatar å¤´åƒé…ç½®"></a>hexo avatar å¤´åƒé…ç½®</h4><blockquote>
<p>æ­¥éª¤</p>
</blockquote>
<p>é…ç½®ä¸ªäººåšå®¢ç½‘ç«™çš„å¤´åƒ,éœ€è¦æ›´æ”¹ä¸»é¢˜ç›®å½•åº•ä¸‹çš„ _config.yml æ–‡ä»¶,æ·»åŠ  avatar é…ç½®.</p>
<pre><code>#å¤´åƒurlé“¾æ¥
avatar: https://avatars.githubusercontent.com/u/112366447?v=4
</code></pre>
<h4 id="hexo-search-å…¨ç«™æœç´¢é…ç½®"><a href="#hexo-search-å…¨ç«™æœç´¢é…ç½®" class="headerlink" title="hexo search å…¨ç«™æœç´¢é…ç½®"></a>hexo search å…¨ç«™æœç´¢é…ç½®</h4><blockquote>
<p>æ­¥éª¤</p>
</blockquote>
<p>å‡å¦‚æƒ³è¦é…ç½® hexo ä¸ªäººåšå®¢ç½‘ç«™çš„å…¨ç«™æœç´¢é…ç½®,é¦–å…ˆè¦ä¸‹è½½ hexo search å¤–éƒ¨ä¾èµ–åŒ….</p>
<pre><code>npm install hexo-generator-search --save
npm install hexo-generator-searchdb --save
</code></pre>
<p>æ›´æ”¹æ ¹ç›®å½•åº•ä¸‹çš„ _config.yml æ–‡ä»¶,æ·»åŠ  search é…ç½®.</p>
<pre><code>search:
    path: search.xml
    field: post
    format: html
    limit: 10000
</code></pre>
<p>å¼€å¯ä¸»é¢˜ç›®å½•åº•ä¸‹çš„ _config.yml æ–‡ä»¶ä¸­çš„ local_search é…ç½®.</p>
<pre><code>local_search:
    enable: true
</code></pre>
<h4 id="hexo-åšå®¢æ–‡ä»¶é…ç½®"><a href="#hexo-åšå®¢æ–‡ä»¶é…ç½®" class="headerlink" title="hexo åšå®¢æ–‡ä»¶é…ç½®"></a>hexo åšå®¢æ–‡ä»¶é…ç½®</h4><blockquote>
<p>æ­¥éª¤</p>
</blockquote>
<p>å‡å¦‚æƒ³è¦æ›´æ”¹æ¯ä¸€ç¯‡åšå®¢çš„æ–‡ä»¶åç§°,ä¸å†æ˜¯é»˜è®¤çš„:title.mdçš„æ–‡ä»¶å,éœ€è¦åœ¨æ ¹ç›®å½•åº•ä¸‹çš„ _config.yml æ–‡ä»¶ä¸­æ›´æ”¹ new_post_name<br>é…ç½®.</p>
<pre><code>new_post_name: :year-:month-:day-:title.md
</code></pre>
<h4 id="hexo-auto-excerpt-é˜…è¯»å…¨æ–‡é…ç½®"><a href="#hexo-auto-excerpt-é˜…è¯»å…¨æ–‡é…ç½®" class="headerlink" title="hexo auto_excerpt é˜…è¯»å…¨æ–‡é…ç½®"></a>hexo auto_excerpt é˜…è¯»å…¨æ–‡é…ç½®</h4><blockquote>
<p>æ­¥éª¤</p>
</blockquote>
<p>åšå®¢æ–‡ç« ä¸€èˆ¬éƒ½ä¼šå¾ˆé•¿çš„,æ‰€ä»¥åœ¨é¦–é¡µè¦å¯¹åšå®¢è¿›è¡Œè¶…é•¿çœç•¥,è¦æƒ³çœ‹æ‰€æœ‰çš„å†…å®¹,ç‚¹å‡»é˜…è¯»å…¨æ–‡æˆ–è€…æ–‡ç« æ ‡é¢˜è¿›å…¥å…¨æ–‡æŸ¥çœ‹.åœ¨<br>hexo-theme-next ä¸»é¢˜ç‰ˆæœ¬ 7.6 ä¹‹å‰éœ€è¦å†ä¸»é¢˜ç›®å½•åº•ä¸‹çš„ _config.yml æ–‡ä»¶ä¸­æ›´æ”¹ auto_excerpt é…ç½®.</p>
<pre><code>auto_excerpt:
    enable: true
    length: 200
</code></pre>
<p>åœ¨ hexo-theme-next ä¸»é¢˜ç‰ˆæœ¬ 7.6 ä¹‹å,ç”±äº auto_excerpt<br>è¿™ç§è¶…é•¿çœç•¥ä¸åº”è¯¥æ˜¯ä¸»é¢˜æ’ä»¶åº”è¯¥åšçš„,ä½œè€…å°†æ­¤é…ç½®ç§»é™¤,å¹¶ç»™å‡ºæ–°çš„ä¸“é—¨é’ˆå¯¹æ­¤é…ç½®çš„æ’ä»¶ <a href='https://github.com/chekun/hexo-excerpt'><br>hexo-excerpt</a>.</p>
<p><img src="https://image.white-than-wood.zone/hexo/remove_auto_excerpt.png"></p>
<pre><code>excerpt:
    #æ˜¾ç¤ºçš„ markdown ä»£ç å—å±‚æ•°
    depth: 5
    excerpt_excludes: []
    more_excludes: []
    #è®¾ç½®ä¸ºtrue: æ˜¾ç¤ºè¶…é•¿çœç•¥,åªå±•ç¤ºéƒ¨åˆ†,éšè—å…¨æ–‡
    #è®¾ç½®ä¸ºfalse: å±•ç¤ºå…¨æ–‡
    hideWholePostExcerpts: true
    excerpt_description: true
    #æ˜¯å¦æ˜¾ç¤ºé˜…è¯»å…¨æ–‡æŒ‰é’®
    read_more_btn: true
</code></pre>
<h4 id="hexo-browsersync-çƒ­åŠ è½½é…ç½®"><a href="#hexo-browsersync-çƒ­åŠ è½½é…ç½®" class="headerlink" title="hexo browsersync çƒ­åŠ è½½é…ç½®"></a>hexo browsersync çƒ­åŠ è½½é…ç½®</h4><blockquote>
<p>æ­¥éª¤</p>
</blockquote>
<p>åœ¨åˆ›ä½œåšå®¢æ—¶,éœ€è¦æ¯æ¬¡æ‰‹åŠ¨åˆ·æ–°é¡µé¢æ‰èƒ½çœ‹åˆ°ä¿®æ”¹åçš„ç»“æœ,æ„Ÿè§‰éå¸¸æ²¡æœ‰æ•ˆç‡,å¦‚æœå­˜åœ¨ç±»hrmçƒ­åŠ è½½è¿™ç§æ’ä»¶å°±å¤ªçˆ½äº†! <a href='https://github.com/hexojs/hexo-browsersync'><br>hexo-browsersync</a> å¯ä»¥ç›´æ¥è§£å†³è¿™ä¸ªé—®é¢˜.</p>
<pre><code>npm install hexo-browsersync --save
</code></pre>
<p>æ­¤æ’ä»¶åŸç†åŸºäº browser-sync ,ä¸ hexo å»ºç«‹å…³è”,å½“åˆ›ä½œçš„æ–‡ä»¶å†…å®¹å‘ç”Ÿæ”¹å˜æ—¶, browser-sync<br>å°±ä¼šç›‘å¬åˆ°å¹¶åˆ·æ–°æµè§ˆå™¨æ•´ä¸ªé¡µé¢çš„å†…å®¹,åšåˆ°ä¸éœ€æ‰‹åŠ¨åˆ·æ–°,å¤§å¤§æé«˜äº†åˆ›ä½œæ•ˆç‡.</p>
<pre><code>#æ›´æ”¹æ ¹ç›®å½•åº•ä¸‹çš„ _config.yml æ–‡ä»¶,æ·»åŠ  browsersync å±æ€§
#è®¾ç½®ç›‘å¬ watch å±æ€§ä¸º true å°±å¯ä»¥äº†!
browsersync:
    watch: true
    logLevel: &quot;warn&quot;
</code></pre>
<h4 id="hexo-busuanzi-count-åœç®—å­ç»Ÿè®¡é…ç½®"><a href="#hexo-busuanzi-count-åœç®—å­ç»Ÿè®¡é…ç½®" class="headerlink" title="hexo busuanzi_count åœç®—å­ç»Ÿè®¡é…ç½®"></a>hexo busuanzi_count åœç®—å­ç»Ÿè®¡é…ç½®</h4><blockquote>
<p>æ­¥éª¤</p>
</blockquote>
<p>ä¸Šçº¿ä¹‹å,éœ€è¦å¯¹ä¸ªäººåšå®¢è¿›è¡Œç®¡ç†,é˜…è¯»äººæ•°ä»¥åŠæ¬¡æ•°å¯¹äºåˆ›ä½œè€…æ¥è¯´æ˜¯å¾ˆé‡è¦åé¦ˆç‚¹.ç»Ÿè®¡é…ç½®éœ€è¦æ›´æ”¹ä¸»é¢˜ç›®å½•åº•ä¸‹çš„ _config.yml<br>æ–‡ä»¶,é…ç½® busuanzi_count åœç®—å­ç»Ÿè®¡.</p>
<pre><code>#å¯é…ç½®æŸ¥çœ‹ä¸ªäººåšå®¢çš„é˜…è¯»äººæ•°ã€æ¬¡æ•°ä»¥åŠæ¯ç¯‡åšå®¢æ–‡ç« çš„æ¬¡æ•°
busuanzi_count:
    enable: true
    total_visitors: true
    total_visitors_icon: fa fa-user
    total_views: true
    total_views_icon: fa fa-eye
    post_views: true
    post_views_icon: fa fa-eye
</code></pre>
<h4 id="hexo-baidu-analytics-ç™¾åº¦ç»Ÿè®¡é…ç½®"><a href="#hexo-baidu-analytics-ç™¾åº¦ç»Ÿè®¡é…ç½®" class="headerlink" title="hexo baidu_analytics ç™¾åº¦ç»Ÿè®¡é…ç½®"></a>hexo baidu_analytics ç™¾åº¦ç»Ÿè®¡é…ç½®</h4><blockquote>
<p>æ­¥éª¤</p>
</blockquote>
<p>åœç®—å­ç»Ÿè®¡æœ‰æ—¶å€™ä¼šå‡ºç°ä¸€äº›å¼‚å¸¸,æ¯”å¦‚pvè«åä¼šåŠ 100,uvä¸å†åŒºåˆ†å•ä¸ªip.ä¸ºäº†è¿½æ±‚æ›´ç²¾ç¡®ã€æ›´æ™ºèƒ½,è¿™é‡Œé‡‡ç”¨ç™¾åº¦ç»Ÿè®¡.<br>ç»Ÿè®¡é…ç½®éœ€è¦æ›´æ”¹ä¸»é¢˜ç›®å½•åº•ä¸‹çš„ _config.yml æ–‡ä»¶,é…ç½® baidu_analytics ç™¾åº¦ç»Ÿè®¡.</p>
<p>æ ¹æ®<a href='https://tongji.baidu.com/main/setting/10000339309/home/site/getjs?siteId=18040501'><br>ç™¾åº¦ç»Ÿè®¡-ä½¿ç”¨é…ç½®-ä»£ç è·å–</a>,å°† hm.js åæ–¹è‡ªåŠ¨ç”Ÿæˆçš„ id é…ç½®è‡³ baidu_analytics.</p>
<p><img src="https://image.white-than-wood.zone/hexo/baidu_analytics.png"></p>
<pre><code># Baidu Analytics
# See: https://tongji.baidu.com
baidu_analytics: 31f07c2ec89d10385ec28e8eea5bbc3a
</code></pre>
<h4 id="hexo-Gitalk-ç•™è¨€æ¿é…ç½®"><a href="#hexo-Gitalk-ç•™è¨€æ¿é…ç½®" class="headerlink" title="hexo Gitalk ç•™è¨€æ¿é…ç½®"></a>hexo Gitalk ç•™è¨€æ¿é…ç½®</h4><blockquote>
<p>æ­¥éª¤</p>
</blockquote>
<p>ç•™è¨€æ¿ comments æ˜¯åˆ›ä½œè€…ä¸é˜…è¯»è€…è¿›è¡Œäº’åŠ¨åé¦ˆçš„çª—å£,å¯ä»¥ä½¿é˜…è¯»è€…ä¸åˆ›ä½œè€…å…±åŒè¿›æ­¥.å¯¹äº hexo æ¥è¯´,æ”¯æŒçš„ç•™è¨€æ¿æ¨¡å¼æœ‰å¾ˆå¤šç§: â€˜disqus | disqusjs | changyan | livere | gitalk | utterancesâ€™,æ¯”è¾ƒå¸¸è§ã€ç”¨æˆ·é‡æ¯”è¾ƒå¤§ä¸”ä¸ github å…³è”æ€§æ¯”è¾ƒå¼ºçš„å°±æ˜¯ gitalk ä»¥åŠ disqus,disqusjs éœ€è¦â€™æ¢¯å­â€™ğŸ¶æ‰èƒ½è¯„è®º,é‚£ä¹ˆè¿˜æ˜¯é€‰ç”¨ gitalk .ç•™è¨€æ¿é…ç½®éœ€è¦æ›´æ”¹ä¸»é¢˜ç›®å½•ä¸‹çš„ _config.yml æ–‡ä»¶.</p>
<p>é…ç½®comments:</p>
<pre><code># Multiple Comment System Support
comments:
    # Available values: tabs | buttons
    style: tabs
    # Choose a comment system to be displayed by default.
    # Available values: disqus | disqusjs | changyan | livere | gitalk | utterances
    active: gitalk
    # Setting `true` means remembering the comment system selected by the visitor.
    storage: true
    # Lazyload all comment systems.
    lazyload: false
    # Modify texts or order for any naves, here are some examples.
    nav:
        gitalk:
            order: -2
        disqus:
            text: Load Disqus
            order: -1
</code></pre>
<p>é…ç½®gitalk:</p>
<pre><code># Gitalk
# For more information: https://gitalk.github.io
gitalk:
    enable: true
    github_id: w-t-w # GitHub repo owner
    repo: w-t-w.github.io # Repository name to store issues
    client_id: 1191ab5290535c1acb09 # GitHub Application Client ID
    client_secret: 8d2cbebac1ae1230f84d1f9f7a36f8008a42c14b # GitHub Application Client Secret
    admin_user: w-t-w # GitHub repo owner and collaborators, only these guys can initialize gitHub issues
    distraction_free_mode: true # Facebook-like distraction free mode
    # When the official proxy is not available, you can change it to your own proxy address
    proxy: https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token
    # proxy: login/oauth/access_token # This is official proxy address
    # Gitalk&#39;s display language depends on user&#39;s browser or system environment
    # If you want everyone visiting your site to see a uniform language, you can set a force language value
    # Available values: en | es-ES | fr | ru | zh-CN | zh-TW
    language: zh-CN
</code></pre>
<p>ä¸Šé¢çš„é…ç½®é¡¹ä¸­æœ‰å‡ ä¸ªéœ€è¦è¯´æ˜çš„ï¼š</p>
<ul>
<li>client_id ä¸ client_secret æ˜¯ Github çš„ OAuth è®¤è¯(ä¸‹ä¸€ä¸ªéƒ¨åˆ†ä¼šä»‹ç»).</li>
<li>github_id ä¸ admin_user è¿™é‡Œå»ºè®®å¡«ä¸€æ ·,å¡«æˆä¸ªäººçš„ github è´¦å·å(ä¸æ˜¯é‚®ç®±,ä¹Ÿä¸æ˜¯ç”¨æˆ·å).</li>
<li>proxy é»˜è®¤å³æ˜¯ä¸Šé¢çš„åœ°å€,å®ƒå…¶å®ä¼šå›è°ƒåˆ°è¿™é‡Œ <a href='https://github.com/login/oauth/access_token'>https://github.com/login/oauth/access_token</a>.</li>
<li>æ— è®ºæ˜¯éƒ¨ç½²è‡³ GitHub Page ä¸ªäººç½‘ç«™,è¿˜æ˜¯éƒ¨ç½²è‡³ä¸ªäººç”³è¯·è´­ä¹°çš„äº‘æœåŠ¡å™¨,ä¸Šé¢ä¸‰ç‚¹æ˜¯å¿…é¡»è¦å®è¡Œçš„,proxy 403 é—®é¢˜ä¸»è¦æ˜¯åœ¨éƒ¨ç½²è‡³ä¸ªäººç”³è¯·è´­ä¹°çš„äº‘æœåŠ¡å™¨ä¸­æ—¶ä¼šé‡åˆ°,è€Œéƒ¨ç½²è‡³ GitHub Page ä¸ªäººç½‘ç«™ä¸èƒ½è¿›è¡Œè‡ªå®šä¹‰é…ç½®åå‘ä»£ç†,æ‰€ä»¥åªèƒ½ä½¿ç”¨ Gitalk å®˜æ–¹æ­å»ºçš„ä»£ç†.</li>
</ul>
<p>ä¸€. Github çš„ OAuth è®¤è¯.</p>
<p>å‰ææ˜¯å¾—æœ‰ä¸€ä¸ª github è´¦å·,æ‰èƒ½æ³¨å†Œ OAuth application ,è¿™æ˜¯<a href='https://github.com/settings/applications/new'> OAuth åº”ç”¨æ³¨å†Œåœ°å€</a>.</p>
<p><img src="https://image.white-than-wood.zone/hexo/github_auth_registers.png"></p>
<p>PS: å¦‚æœæœ‰è‡ªå®šä¹‰åŸŸå(å¦‚ä¸ªäººç”³è¯·çš„é˜¿é‡Œäº‘åŸŸå),åˆ™åœ¨ä¸Šå›¾ä¸­å¡«å…¥è‡ªå®šä¹‰åŸŸå.</p>
<p>æ³¨å†Œä¹‹å,ç‚¹å‡»ä¸‹å›¾ä¸­â€™Generate a new client secretâ€™æŒ‰é’®,åœ¨ä¸ªäººè´¦å·ä¸‹çš„Settings -&gt; Developer settings -&gt; OAuth Appsä¸‹é¢å¯ä»¥æŸ¥çœ‹ OAuth è®¤è¯ client_id ä¸ client_secret.</p>
<p><img src="https://image.white-than-wood.zone/hexo/developer_setting.png"></p>
<p>äºŒ. Gitalk è‡ªåŠ¨åˆå§‹åŒ–.</p>
<p>åŸç†: é€šè¿‡ sitemap ä¸­çš„ä¿¡æ¯,è¯·æ±‚ github å¼€æ”¾ api è¾¾åˆ°è‡ªåŠ¨äº§ç”Ÿ issues çš„ç›®çš„.<br>åŸºæœ¬çš„è¦æ±‚: github API éœ€è¦è¯·æ±‚ token.</p>
<ul>
<li><p>ç”³è¯· github Token.</p>
<p>éœ€è¦ä½¿ç”¨ Personal access tokens æ–¹å¼,è¿™ç§æ–¹å¼é™åˆ¶æ¯å°æ—¶5000æ¬¡,ç»“åˆç¼“å­˜åŠŸèƒ½,åŸºæœ¬æ»¡è¶³éœ€æ±‚.<br>ä» Github çš„ <a href='https://github.com/settings/tokens'>Personal access tokens</a> é¡µé¢,ç‚¹å‡» <a href='https://github.com/settings/tokens/new'>Generate new token</a>.</p>
</li>
</ul>
<p><img src="https://image.white-than-wood.zone/hexo/access_tokens.png"></p>
<ul>
<li><p>å®‰è£… npm ä¾èµ–é¡¹.</p>
<pre><code>npm i -D md5 moment request xml-parser
npm i -S hexo-generator-sitemap
</code></pre>
</li>
<li><p>é…ç½® sitemap.</p>
<p>åœ¨æ ¹ç›®å½•ä¸­åˆ›å»º sitemap_template.xml.</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">urlset</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.sitemaps.org/schemas/sitemap/0.9&quot;</span>&gt;</span></span><br><span class="line">  &#123;% for post in posts %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loc</span>&gt;</span>&#123;&#123; post.permalink | uriencode &#125;&#125;<span class="tag">&lt;/<span class="name">loc</span>&gt;</span></span><br><span class="line">    &#123;% if post.updated %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">lastmod</span>&gt;</span>&#123;&#123; post.updated.toISOString() &#125;&#125;<span class="tag">&lt;/<span class="name">lastmod</span>&gt;</span></span><br><span class="line">    &#123;% elif post.date %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">lastmod</span>&gt;</span>&#123;&#123; post.date.toISOString() &#125;&#125;<span class="tag">&lt;/<span class="name">lastmod</span>&gt;</span></span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">date</span>&gt;</span>&#123;&#123; post.date &#125;&#125;<span class="tag">&lt;/<span class="name">date</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;&#123; post.title + &#x27; | &#x27; + config.title &#125;&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    &#123;# nunjucks æ¨¡ç‰ˆè¯­æ³• https://github.com/mozilla/nunjucks #&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">desc</span>&gt;</span>&#123;&#123; post.description | default(post.excerpt) | default(post.content) | default(config.description) | striptags | truncate(200, true, &#x27;&#x27;) &#125;&#125;<span class="tag">&lt;/<span class="name">desc</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">urlset</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>ä¿®æ”¹æ ¹ç›®å½•ä¸‹çš„ _config.yml.</p>
<pre><code>#Sitemap
sitemap:
  path: sitemap.xml
  template: ./sitemap_template.xml
  rel: false
  tag: true
  category: false
</code></pre>
</li>
<li><p>ç”Ÿæˆ sitemap.xml ç”Ÿäº§ç¯å¢ƒæ–‡ä»¶.</p>
<pre><code>hexo clean &amp;&amp; hexo generate
</code></pre>
</li>
<li><p>æ ¹ç›®å½•æ·»åŠ  talk-auto-init.js (æ³¨æ„è¿˜æ˜¯ä¸è¦å°†æ­¤æ–‡ä»¶ç½®äºgithubä¸­,å»ºè®®ignore).</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">&#x27;url&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">&#x27;request&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> xmlParser = <span class="built_in">require</span>(<span class="string">&#x27;xml-parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> md5 = <span class="built_in">require</span>(<span class="string">&#x27;md5&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é…ç½®ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">  <span class="attr">username</span>: <span class="string">&#x27;w-t-w&#x27;</span>, <span class="comment">// GitHub repository æ‰€æœ‰è€…ï¼Œå¯ä»¥æ˜¯ä¸ªäººæˆ–è€…ç»„ç»‡ã€‚å¯¹åº” Gitalk é…ç½®ä¸­çš„ owner</span></span><br><span class="line">  <span class="attr">repo</span>: <span class="string">&quot;w-t-w.github.io&quot;</span>, <span class="comment">// å‚¨å­˜è¯„è®º issue çš„ github ä»“åº“åï¼Œä»…éœ€è¦ä»“åº“åå­—å³å¯ã€‚å¯¹åº” Gitalk é…ç½®ä¸­çš„ repo</span></span><br><span class="line">  <span class="attr">token</span>: <span class="string">&#x27;ghp_EuXHDkOxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#x27;</span>, <span class="comment">// å‰é¢ç”³è¯·çš„ personal access token</span></span><br><span class="line">  <span class="attr">sitemap</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;./public/sitemap.xml&#x27;</span>), <span class="comment">// ä¸ªäººç«™ç‚¹çš„ sitemap æ–‡ä»¶åœ°å€</span></span><br><span class="line">  <span class="attr">cache</span>: <span class="literal">true</span>, <span class="comment">// æ˜¯å¦å¯ç”¨ç¼“å­˜ï¼Œå¯ç”¨ç¼“å­˜ä¼šå°†å·²ç»åˆå§‹åŒ–çš„æ•°æ®å†™å…¥é…ç½®çš„ gitalkCacheFile æ–‡ä»¶ï¼Œä¸‹ä¸€æ¬¡ç›´æ¥é€šè¿‡ç¼“å­˜æ–‡ä»¶åˆ¤æ–­</span></span><br><span class="line">  <span class="attr">gitalkCacheFile</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;./gitalk-init-cache.json&#x27;</span>), <span class="comment">// ç”¨äºä¿å­˜ gitalk å·²ç»åˆå§‹åŒ–çš„ id åˆ—è¡¨</span></span><br><span class="line">  <span class="attr">gitalkErrorFile</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;./gitalk-init-error.json&#x27;</span>), <span class="comment">// ç”¨äºä¿å­˜ gitalk åˆå§‹åŒ–æŠ¥é”™çš„æ•°æ®</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> api = <span class="string">&#x27;https://api.github.com/repos/&#x27;</span> + config.<span class="property">username</span> + <span class="string">&#x27;/&#x27;</span> + config.<span class="property">repo</span> + <span class="string">&#x27;/issues&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¯»å– sitemap æ–‡ä»¶</span></span><br><span class="line"><span class="comment">   * è¿œç¨‹ sitemap æ–‡ä»¶è·å–å¯å‚è€ƒ https://www.npmjs.com/package/sitemapper</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">sitemapXmlReader</span> = (<span class="params">file</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> data = fs.<span class="title function_">readFileSync</span>(file, <span class="string">&#x27;utf8&#x27;</span>);</span><br><span class="line">      <span class="keyword">const</span> sitemap = <span class="title function_">xmlParser</span>(data);</span><br><span class="line">      <span class="keyword">let</span> ret = [];</span><br><span class="line">      sitemap.<span class="property">root</span>.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">url</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> loc = url.<span class="property">children</span>.<span class="title function_">find</span>(<span class="keyword">function</span> (<span class="params">item</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> item.<span class="property">name</span> === <span class="string">&#x27;loc&#x27;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">if</span> (!loc) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> title = url.<span class="property">children</span>.<span class="title function_">find</span>(<span class="keyword">function</span> (<span class="params">item</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> item.<span class="property">name</span> === <span class="string">&#x27;title&#x27;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">const</span> desc = url.<span class="property">children</span>.<span class="title function_">find</span>(<span class="keyword">function</span> (<span class="params">item</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> item.<span class="property">name</span> === <span class="string">&#x27;desc&#x27;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">const</span> date = url.<span class="property">children</span>.<span class="title function_">find</span>(<span class="keyword">function</span> (<span class="params">item</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> item.<span class="property">name</span> === <span class="string">&#x27;date&#x27;</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        ret.<span class="title function_">push</span>(&#123;</span><br><span class="line">          <span class="attr">url</span>: loc.<span class="property">content</span>,</span><br><span class="line">          <span class="attr">title</span>: title.<span class="property">content</span>,</span><br><span class="line">          <span class="attr">desc</span>: desc.<span class="property">content</span>,</span><br><span class="line">          <span class="attr">date</span>: date.<span class="property">content</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span> ret;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å– gitalk ä½¿ç”¨çš„ id</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getGitalkId</span> = (<span class="params">&#123;</span></span><br><span class="line"><span class="params">                       url: u,</span></span><br><span class="line"><span class="params">                       date</span></span><br><span class="line"><span class="params">                     &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> link = url.<span class="title function_">parse</span>(u);</span><br><span class="line">  <span class="comment">// é“¾æ¥ä¸å­˜åœ¨ï¼Œä¸éœ€è¦åˆå§‹åŒ–</span></span><br><span class="line">  <span class="keyword">if</span> (!link || !link.<span class="property">pathname</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!date) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">md5</span>(link.<span class="property">pathname</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šè¿‡ä»¥è¯·æ±‚åˆ¤æ–­æ˜¯å¦å·²ç»åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; gitalk åˆå§‹åŒ–çš„id</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> &#123;<span class="type">[boolean, boolean]</span>&#125; ç¬¬ä¸€ä¸ªå€¼è¡¨ç¤ºæ˜¯å¦å‡ºé”™ï¼Œç¬¬äºŒä¸ªå€¼ false è¡¨ç¤ºæ²¡åˆå§‹åŒ–ï¼Œ true è¡¨ç¤ºå·²ç»åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getIsInitByRequest</span> = (<span class="params">id</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> options = &#123;</span><br><span class="line">      <span class="attr">headers</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">&#x27;token &#x27;</span> + config.<span class="property">token</span>,</span><br><span class="line">        <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">url</span>: api + <span class="string">&#x27;?labels=&#x27;</span> + id + <span class="string">&#x27;,Gitalk&#x27;</span>,</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">request</span>(options, <span class="keyword">function</span> (<span class="params">err, response, body</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">resolve</span>([err, <span class="literal">false</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (response.<span class="property">statusCode</span> != <span class="number">200</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">resolve</span>([response, <span class="literal">false</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(body);</span><br><span class="line">        <span class="keyword">if</span> (res.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">resolve</span>([<span class="literal">false</span>, <span class="literal">true</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">resolve</span>([<span class="literal">false</span>, <span class="literal">false</span>]);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šè¿‡ç¼“å­˜åˆ¤æ–­æ˜¯å¦å·²ç»åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; gitalk åˆå§‹åŒ–çš„id</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> &#123;<span class="type">boolean</span>&#125; false è¡¨ç¤ºæ²¡åˆå§‹åŒ–ï¼Œ true è¡¨ç¤ºå·²ç»åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"><span class="keyword">const</span> getIsInitByCache = (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ç¼“å­˜æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">let</span> gitalkCache = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      gitalkCache = <span class="built_in">require</span>(config.<span class="property">gitalkCacheFile</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">id</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!gitalkCache) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (gitalkCache.<span class="title function_">find</span>(<span class="function">(<span class="params">&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                              id: itemId</span></span></span><br><span class="line"><span class="params"><span class="function">                            &#125;</span>) =&gt;</span> (itemId === id))) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®ç¼“å­˜ï¼Œåˆ¤æ–­é“¾æ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">// ç¬¬ä¸€ä¸ªå€¼è¡¨ç¤ºæ˜¯å¦å‡ºé”™ï¼Œç¬¬äºŒä¸ªå€¼ false è¡¨ç¤ºæ²¡åˆå§‹åŒ–ï¼Œ true è¡¨ç¤ºå·²ç»åˆå§‹åŒ–</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">idIsInit</span> = <span class="keyword">async</span> (<span class="params">id</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!config.<span class="property">cache</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">getIsInitByRequest</span>(id);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¦‚æœé€šè¿‡ç¼“å­˜æŸ¥è¯¢åˆ°çš„æ•°æ®æ˜¯æœªåˆå§‹åŒ–ï¼Œåˆ™å†é€šè¿‡è¯·æ±‚åˆ¤æ–­æ˜¯å¦å·²ç»åˆå§‹åŒ–ï¼Œé˜²æ­¢å¤šæ¬¡åˆå§‹åŒ–</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">getIsInitByCache</span>(id) === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">getIsInitByRequest</span>(id);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> [<span class="literal">false</span>, <span class="literal">true</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">gitalkInit</span> = (<span class="params">&#123;</span></span><br><span class="line"><span class="params">                      url,</span></span><br><span class="line"><span class="params">                      id,</span></span><br><span class="line"><span class="params">                      title,</span></span><br><span class="line"><span class="params">                      desc</span></span><br><span class="line"><span class="params">                    &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">//åˆ›å»ºissue</span></span><br><span class="line">  <span class="keyword">const</span> reqBody = &#123;</span><br><span class="line">    <span class="string">&#x27;title&#x27;</span>: title,</span><br><span class="line">    <span class="string">&#x27;labels&#x27;</span>: [id, <span class="string">&#x27;Gitalk&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;body&#x27;</span>: url + <span class="string">&#x27;\r\n\r\n&#x27;</span> + desc</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> options = &#123;</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">&#x27;token &#x27;</span> + config.<span class="property">token</span>,</span><br><span class="line">      <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json;charset=UTF-8&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">url</span>: api,</span><br><span class="line">    <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(reqBody),</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">request</span>(options, <span class="keyword">function</span> (<span class="params">err, response, body</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">resolve</span>([err, <span class="literal">false</span>]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (response.<span class="property">statusCode</span> != <span class="number">201</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">resolve</span>([response, <span class="literal">false</span>]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">resolve</span>([<span class="literal">false</span>, <span class="literal">true</span>]);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å†™å…¥å†…å®¹</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; fileName æ–‡ä»¶å</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; content å†…å®¹</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">write</span> = <span class="keyword">async</span> (<span class="params">fileName, content, flag = <span class="string">&#x27;w+&#x27;</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">      fs.<span class="title function_">open</span>(fileName, flag, <span class="keyword">function</span> (<span class="params">err, fd</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          <span class="title function_">resolve</span>([err, <span class="literal">false</span>]);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        fs.<span class="title function_">writeFile</span>(fd, content, <span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="title function_">resolve</span>([err, <span class="literal">false</span>]);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          fs.<span class="title function_">close</span>(fd, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">              <span class="title function_">resolve</span>([err, <span class="literal">false</span>]);</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="title function_">resolve</span>([<span class="literal">false</span>, <span class="literal">true</span>]);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">init</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> urls = <span class="title function_">sitemapXmlReader</span>(config.<span class="property">sitemap</span>);</span><br><span class="line">  <span class="comment">// æŠ¥é”™çš„æ•°æ®</span></span><br><span class="line">  <span class="keyword">const</span> errorData = [];</span><br><span class="line">  <span class="comment">// å·²ç»åˆå§‹åŒ–çš„æ•°æ®</span></span><br><span class="line">  <span class="keyword">const</span> initializedData = [];</span><br><span class="line">  <span class="comment">// æˆåŠŸåˆå§‹åŒ–æ•°æ®</span></span><br><span class="line">  <span class="keyword">const</span> successData = [];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> item <span class="keyword">of</span> urls) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      url,</span><br><span class="line">      date,</span><br><span class="line">      title,</span><br><span class="line">      desc</span><br><span class="line">    &#125; = item;</span><br><span class="line">    <span class="keyword">const</span> id = <span class="title function_">getGitalkId</span>(&#123;</span><br><span class="line">      url,</span><br><span class="line">      date</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!id) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`id: ç”Ÿæˆå¤±è´¥ [ <span class="subst">$&#123;id&#125;</span> ] `</span>);</span><br><span class="line">      errorData.<span class="title function_">push</span>(&#123;</span><br><span class="line">        ...item,</span><br><span class="line">        <span class="attr">info</span>: <span class="string">&#x27;id ç”Ÿæˆå¤±è´¥&#x27;</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> [err, res] = <span class="keyword">await</span> <span class="title function_">idIsInit</span>(id);</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Error: æŸ¥è¯¢è¯„è®ºå¼‚å¸¸ [ <span class="subst">$&#123;title&#125;</span> ] , ä¿¡æ¯ï¼š`</span>, err || <span class="string">&#x27;æ— &#x27;</span>);</span><br><span class="line">      errorData.<span class="title function_">push</span>(&#123;</span><br><span class="line">        ...item,</span><br><span class="line">        <span class="attr">info</span>: <span class="string">&#x27;æŸ¥è¯¢è¯„è®ºå¼‚å¸¸&#x27;</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (res === <span class="literal">true</span>) &#123;</span><br><span class="line">      <span class="comment">// console.log(`--- Gitalk å·²ç»åˆå§‹åŒ– --- [ $&#123;title&#125; ] `);</span></span><br><span class="line">      initializedData.<span class="title function_">push</span>(&#123;</span><br><span class="line">        id,</span><br><span class="line">        url,</span><br><span class="line">        title,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Gitalk åˆå§‹åŒ–å¼€å§‹... [ <span class="subst">$&#123;title&#125;</span> ] `</span>);</span><br><span class="line">    <span class="keyword">const</span> [e, r] = <span class="keyword">await</span> <span class="title function_">gitalkInit</span>(&#123;</span><br><span class="line">      id,</span><br><span class="line">      url,</span><br><span class="line">      title,</span><br><span class="line">      desc</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (e || !r) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Error: Gitalk åˆå§‹åŒ–å¼‚å¸¸ [ <span class="subst">$&#123;title&#125;</span> ] , ä¿¡æ¯ï¼š`</span>, e || <span class="string">&#x27;æ— &#x27;</span>);</span><br><span class="line">      errorData.<span class="title function_">push</span>(&#123;</span><br><span class="line">        ...item,</span><br><span class="line">        <span class="attr">info</span>: <span class="string">&#x27;åˆå§‹åŒ–å¼‚å¸¸&#x27;</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    successData.<span class="title function_">push</span>(&#123;</span><br><span class="line">      id,</span><br><span class="line">      url,</span><br><span class="line">      title,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Gitalk åˆå§‹åŒ–æˆåŠŸ! [ <span class="subst">$&#123;title&#125;</span> ] - <span class="subst">$&#123;id&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;&#x27;</span>); <span class="comment">// ç©ºè¾“å‡ºï¼Œç”¨äºæ¢è¡Œ</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;--------- è¿è¡Œç»“æœ ---------&#x27;</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;&#x27;</span>); <span class="comment">// ç©ºè¾“å‡ºï¼Œç”¨äºæ¢è¡Œ</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (errorData.<span class="property">length</span> !== <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`æŠ¥é”™æ•°æ®ï¼š <span class="subst">$&#123;errorData.length&#125;</span> æ¡ã€‚å‚è€ƒæ–‡ä»¶ <span class="subst">$&#123;config.gitalkErrorFile&#125;</span>ã€‚`</span>);</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">write</span>(config.<span class="property">gitalkErrorFile</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(errorData, <span class="literal">null</span>, <span class="number">2</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`æœ¬æ¬¡æˆåŠŸï¼š <span class="subst">$&#123;successData.length&#125;</span> æ¡ã€‚`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å†™å…¥ç¼“å­˜</span></span><br><span class="line">  <span class="keyword">if</span> (config.<span class="property">cache</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`å†™å…¥ç¼“å­˜ï¼š <span class="subst">$&#123;(initializedData.length + successData.length)&#125;</span> æ¡ï¼Œå·²åˆå§‹åŒ– <span class="subst">$&#123;initializedData.length&#125;</span> æ¡ï¼Œæœ¬æ¬¡æˆåŠŸï¼š <span class="subst">$&#123;successData.length&#125;</span> æ¡ã€‚å‚è€ƒæ–‡ä»¶ <span class="subst">$&#123;config.gitalkCacheFile&#125;</span>ã€‚`</span>);</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">write</span>(config.<span class="property">gitalkCacheFile</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(initializedData.<span class="title function_">concat</span>(successData), <span class="literal">null</span>, <span class="number">2</span>));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`å·²åˆå§‹åŒ–ï¼š <span class="subst">$&#123;initializedData.length&#125;</span> æ¡ã€‚`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title function_">init</span>();</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>ä¿®æ”¹ package.json ä¸­ scripts ä¸­çš„è„šæœ¬,æ·»åŠ  â€œgitalkâ€:â€node talk-auto-init.jsâ€.</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;clean&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hexo clean&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;publish&quot;</span><span class="punctuation">:</span> <span class="string">&quot;git push &amp;&amp; yarn run clean &amp;&amp; hexo generate -d&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hexo server&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yarn run clean &amp;&amp; yarn run server -p 9777&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;gitalk&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node talk-auto-init.js&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li><p>æµ‹è¯• gitalk.</p>
<pre><code>yarn run gitalk
</code></pre>
</li>
<li><p>å·²ç»ç¼“å­˜è¿‡åçš„ç»“æœ:</p>
<pre><code>hexo-site@0.0.0 gitalk
node talk-auto-init.js
--------- è¿è¡Œç»“æœ ---------
æœ¬æ¬¡æˆåŠŸï¼š 0 æ¡ã€‚
å†™å…¥ç¼“å­˜ï¼š 7 æ¡ï¼Œå·²åˆå§‹åŒ– 7 æ¡ï¼Œæœ¬æ¬¡æˆåŠŸï¼š 0 æ¡ã€‚å‚è€ƒæ–‡ä»¶ /Users/wtw/frontEnd/w-t-w.github.io/gitalk-init-cache.json.
</code></pre>
</li>
</ul>
<blockquote>
<p>proxy 403é”™è¯¯</p>
</blockquote>
<p>éƒ¨ç½²è‡³ä¸ªäººç”³è¯·è´­ä¹°çš„äº‘æœåŠ¡å™¨æ—¶,ç”±äºè·¨åŸŸé—®é¢˜,ä¼šå‡ºç° proxy 403 forbidden.è§£å†³å®ƒä¸»è¦æœ‰è¿™ä¹ˆå‡ ä¸ªæ–¹æ¡ˆ.</p>
<ul>
<li><p>nginx åå‘ä»£ç†è§£å†³æ–¹æ¡ˆ(æ¨è).</p>
<p>åœ¨äº‘æœåŠ¡å™¨ nginx çš„åšå®¢é…ç½®ä¸­åŠ å…¥å¦‚ä¸‹å†…å®¹(æ³¨æ„ä¸ªäººåšå®¢çš„åŸŸåå¿…é¡»ç»è¿‡ https ssl å®‰å…¨è¯ä¹¦å¤‡æ¡ˆ).</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl http2 default_server;</span><br><span class="line">    #...</span><br><span class="line">    #è¿™é‡Œçœç•¥çš„éƒ¨åˆ†éƒ½æ˜¯å¯¹äº ssl http2 è¯ä¹¦çš„é…ç½®</span><br><span class="line">    location = /login/oauth/access_token &#123;</span><br><span class="line">        add_header Access-Control-Allow-Origin &#x27;https://white-than-wood.zone/&#x27;;  //è¿™é‡Œæ”¹æˆä¸ªäººçš„åŸŸå,å¹¶åˆ é™¤æ³¨é‡Š</span><br><span class="line">        add_header Access-Control-Allow-Methods &#x27;GET, POST, OPTIONS&#x27;;</span><br><span class="line">        add_header Access-Control-Allow-Headers &#x27;DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization&#x27;;</span><br><span class="line">        if ($request_method = &#x27;OPTIONS&#x27;) &#123;</span><br><span class="line">              return 204;</span><br><span class="line">        &#125;</span><br><span class="line">        proxy_pass https://github.com/;</span><br><span class="line">    &#125;</span><br><span class="line">    #...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PS: nginx åå‘ä»£ç†ä¹‹å,è¦å°† proxy æŒ‡å‘ä»£ç†åŸŸåä¸‹çš„é“¾æ¥å›è°ƒè¿›è¡Œä¿®æ”¹.</p>
<pre><code>proxy: https://white-than-wood.zone/https://github.com/login/oauth/access_token
</code></pre>
</li>
<li><p>è‡ªå»ºä¸€ä¸ª workers.</p>
<p>åœ°å€: <a href='https://workers.cloudflare.com/'>CloudFlare Workers</a>.<br>å‚è€ƒæ–‡ç« : <a href='https://blog.dsrkafuu.net/post/2020/cloudflare-worker-cors-anywhere/'>ä½¿ç”¨ CloudFlare Workers å®ç° CORS Anywhere</a>.</p>
</li>
<li><p>ä½¿ç”¨å…¶ä»–äººæ­å»ºçš„ä»£ç†.</p>
<p>æ¯”å¦‚è¿™ä¸ª <a href='https://github.com/gitalk/gitalk/issues/429#issuecomment-778291781'>issues</a> ä»‹ç»åˆ°çš„:</p>
<pre><code> proxy: https://shielded-brushlands-08810.herokuapp.com/https://github.com/login/oauth/access_token
</code></pre>
</li>
<li><p>ä½¿ç”¨ Gitalk å®˜æ–¹æ­å»ºçš„ä»£ç†.</p>
<p>æ®gitalk issue<a href='https://github.com/gitalk/gitalk/issues/433'> gitalk æˆæƒç™»å½•åæŠ¥é”™ 403</a>,ç›´æ¥å°†ä½¿ç”¨ Gitalk å®˜æ–¹æ­å»ºçš„ä»£ç†å°±å¯è§£å†³ 403 forbidden çš„é—®é¢˜,ä¹‹å‰ Gitalk å®˜æ–¹æ­å»ºçš„ä»£ç†ç”±äºå¤ªå¤šäººæ¥å…¥å¯¼è‡´è¢«å®˜æ–¹é™åˆ¶ä½¿ç”¨,ç”¨æˆ·ç»å¸¸å‘ç°ä¸èƒ½æ­£å¸¸ä½¿ç”¨,ç°åœ¨å·²ç»å¯¹ä»£ç†è¿›è¡Œä¼˜åŒ–æ”¹è¿›,ä¸ä¼šå‡ºç°é™åˆ¶ä½¿ç”¨çš„æƒ…å†µ.</p>
<p><img src="https://image.white-than-wood.zone/hexo/gitalk_403.png"></p>
<pre><code> https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token
</code></pre>
</li>
<li><p>æ›´æ–° gitalk ç‰ˆæœ¬è‡³1.7.2.</p>
<p>æ®gitalk issue<a href='https://github.com/gitalk/gitalk/issues/433'> gitalk æˆæƒç™»å½•åæŠ¥é”™ 403</a>,ç›´æ¥å°† gitalk ç‰ˆæœ¬å‡çº§è‡³ 1.7.2 å°±å¯è§£å†³ 403 forbidden çš„é—®é¢˜.</p>
<p><img src="https://image.white-than-wood.zone/hexo/gitalk_403.png"></p>
</li>
</ul>
<h4 id="hexo-GitHub-Page-ä¸ªäººç½‘ç«™è‡ªå®šä¹‰åŸŸå"><a href="#hexo-GitHub-Page-ä¸ªäººç½‘ç«™è‡ªå®šä¹‰åŸŸå" class="headerlink" title="hexo GitHub Page ä¸ªäººç½‘ç«™è‡ªå®šä¹‰åŸŸå"></a>hexo GitHub Page ä¸ªäººç½‘ç«™è‡ªå®šä¹‰åŸŸå</h4><p>éƒ¨ç½²è‡³ GitHub Page ä¸ªäººç½‘ç«™é…ç½®è‡ªå®šä¹‰åŸŸåæ—¶,éœ€è¦å°†ä¸ªäººç”³è¯·è´­ä¹°çš„åŸŸå(æœ€å¥½æ˜¯é€šè¿‡ https ssl å®‰å…¨è¯ä¹¦å¤‡æ¡ˆ)è¿›è¡ŒåŸŸåè§£æ,GitHub Page ä¹Ÿéœ€è¦ CNAME é…ç½®.</p>
<p>ä¸€. é˜¿é‡Œäº‘åŸŸåè§£æ.</p>
<blockquote>
<p>æ­¥éª¤</p>
</blockquote>
<p>åŸŸåè§£æç®€å•æ¥è¯´å®é™…ä¸Šå°±æ˜¯é€šè¿‡é…ç½®,å°†åŸŸåè§£æè‡³æŸä¸€ä¸ª IP åœ°å€æˆ–è€…åŸŸå.é¦–å…ˆè¿›å…¥é˜¿é‡Œäº‘æœåŠ¡ç®¡ç†å¹³å°,å¯¹å·²ç»ç”³è¯·è´­ä¹°çš„åŸŸåè¿›è¡Œè§£æ.</p>
<p><img src="https://image.white-than-wood.zone/hexo/website_host_analy.png"></p>
<p>æ·»åŠ è®°å½•æˆ–è€…å¯¹æŸä¸€ä¸ªåˆ—è¡¨é¡¹è¿›è¡Œä¿®æ”¹.å¯ä»¥ä½¿ç”¨ Aè®°å½• ä¹Ÿå¯ä»¥ä½¿ç”¨ CNAME.</p>
<pre><code>Aè®°å½• æ˜¯å°†åŸŸåæŒ‡å‘ä¸€ä¸ª IPV4 åœ°å€.
CNAME æ˜¯å°†åŸŸåæŒ‡å‘å¦å¤–ä¸€ä¸ªåŸŸå.
</code></pre>
<p><img src="https://image.white-than-wood.zone/hexo/website_host_analy_details.png"></p>
<p>è¿™é‡Œä½¿ç”¨çš„æ˜¯ Aè®°å½•,å°† w-t-w.github.io çš„ IP åœ°å€ä½œä¸ºè®°å½•å€¼.</p>
<pre><code>ping w-t-w.github.io
</code></pre>
<p><img src="https://image.white-than-wood.zone/hexo/website_host_analy_pings.png"></p>
<p>ä¸»æœºè®°å½•,è§£æåçš„åŸŸååŸºæœ¬ä¸Šå°±ä¸¤ç§,â€˜@â€™å’Œâ€™wwwâ€™.</p>
<pre><code>&#39;@&#39; æ˜¯æºåŸŸå(ä¸»åŸŸå white-than-wood.zone).
&#39;www&#39; åˆ™æ˜¯ www.white-than-wood.zone.
</code></pre>
<p>äºŒ. GitHub Pageä¸ªäººç½‘ç«™CNAMEé…ç½®.</p>
<p>åœ¨ source ç›®å½•ä¸‹æ–°å»º CNAME æ–‡ä»¶(ä¸å¸¦ä»»ä½•åç¼€),åœ¨æ–‡ä»¶å†…å†™å…¥ä½ çš„ä¸»åŸŸå.</p>
  <figure class="highlight text"><table><tr><td class="code"><pre><span class="line">white-than-wood.zone</span><br></pre></td></tr></table></figure>

<p>æˆ–è€…åœ¨ Github Page ä¸ªäººé…ç½®ä¸‹è®¾ç½®è‡ªå®šä¹‰åŸŸå,Github ä¼šè‡ªåŠ¨æ·»åŠ  CNAME æ–‡ä»¶.</p>
<p><img src="https://image.white-than-wood.zone/hexo/website_host_github_cnames.png"></p>
<p>è¿™ä¸¤ç§æ–¹å¼è¿™é‡Œæ˜¯å…¨éƒ¨ä½¿ç”¨çš„.å…¨éƒ¨æå®šä¹‹å,å°±å¯ä»¥é€šè¿‡ white-than-wood.zone è®¿é—® w-t-w.github.io GitHub Page ä¸ªäººç½‘ç«™.</p>
<blockquote>
<p>å»¶ä¼¸</p>
</blockquote>
<p>æ—¢ç„¶å·²ç»é€šè¿‡é˜¿é‡Œäº‘æœåŠ¡ Aè®°å½• æˆ–è€… CNAME è§£æåŸŸå,ä¸ºä»€ä¹ˆè¿˜éœ€è¦åœ¨ GitHub Page ä¸ªäººç½‘ç«™ä¸Šé…ç½® CNAME ?</p>
<p>è§£: äº‘æœåŠ¡ Aè®°å½• æˆ–è€… CNAME åŸŸåè§£æè‡³ GitHub Page,é€šè¿‡ white-than-wood.zone å¯ä»¥è®¿é—® GitHub Page ä¸ªäººç½‘ç«™,é‚£åŸæ¥çš„ w-t-w.github.io åŸŸåæ€ä¹ˆåŠå‘¢? GitHub Page ä¹Ÿé€šè¿‡ CNAME åŸŸåè§£æè‡³ white-than-wood.zone. ä½¿å¾— github.io åŸŸåä¹Ÿå¯ä»¥ç›´æ¥è®¿é—®ä¸ªäººç”³è¯·è´­ä¹°çš„åŸŸå.</p>
<h4 id="hexo-å…¶ä»–é…ç½®"><a href="#hexo-å…¶ä»–é…ç½®" class="headerlink" title="hexo å…¶ä»–é…ç½®"></a>hexo å…¶ä»–é…ç½®</h4><blockquote>
<p>ç¤ºä¾‹</p>
</blockquote>
<p>åœ¨æ ¹ç›®å½•åº•ä¸‹çš„ _config.yml æ–‡ä»¶ä¸­æ›´æ”¹ç½‘ç«™title(æ ‡é¢˜)ã€author(ä½œè€…)ã€keywords(å…³é”®å­—)ã€description(æè¿°)é…ç½®,æ¯”å¦‚æœ¬äººçš„é…ç½®.</p>
<pre><code>title: wtw&#39;s Frontend
author: wtw(æ¯”æœ¨ç™½)
keywords: hexo,hexo blog,webpack
subtitle: é“é˜»ä¸”é•¿,è¡Œåˆ™å°†è‡³
description: å‰ç«¯é¢†åŸŸå†…æ‰€ä¸çŸ¥é“çš„éƒ½æ¢ç´¢äºæ­¤!
</code></pre>
<p>å†ä¸»é¢˜ç›®å½•åº•ä¸‹çš„ _config.yml æ–‡ä»¶é‡è®¾ç½®ä¸ªäººçš„github(githubæ‰˜ç®¡ä»£ç ç½‘å€)ã€google(googleä¸ªäººèµ„æ–™ç½‘å€)ã€gmail(gmailé‚®ç®±ç½‘å€)<br>ã€twitter(twitterä¸ªäººå¾®åšç½‘å€)ç­‰ç­‰,æ¯”å¦‚æœ¬äººçš„é…ç½®.</p>
<pre><code>social:
  GitHub: https://github.com/w-t-w || fab fa-github
  E-Mail: https://dreamthen.00@gmail.com || fab fa-envelope
  Google: https://plus.google.com/u/0/103833130011211353424 || fab fa-google
</code></pre>
<p>å‘å¸ƒåˆ° GitHub Page ä¸Šä¹‹å,ä½ ä¼šå‘ç° README.md è«åçš„æ¶ˆå¤±,ä¸»è¦æ˜¯å› ä¸º hexo æ„å»ºå‘å¸ƒåˆ°è¿œç¨‹çš„ç›®å½•åªæ˜¯ source ç›®å½•,æ‰€ä»¥åªè¦å°†<br>README.md copy ä¸€ä»½æ”¾åˆ° source ç›®å½•ä¸‹,å¹¶ä¸”é…ç½®æ¸²æŸ“æ—¶éœ€è¦è·³è¿‡çš„æ–‡ä»¶å°±å¯ä»¥äº†.</p>
<pre><code>#hexo æ„å»ºæ¸²æŸ“æ—¶ä¼šå°† source ç›®å½•ä¸‹ markdown ç±»å‹æ–‡ä»¶è½¬è¯‘ä¸º html,ä¸éœ€è¦å°† README.md è½¬è¯‘,æ‰€ä»¥ç›´æ¥ skip render
#æ›´æ”¹æ ¹ç›®å½•åº•ä¸‹çš„ _config.yml æ–‡ä»¶,ä¿®æ”¹ skip_render å±æ€§
skip_render: README.md
</code></pre>
<p>å½“åˆ›ä½œä¸­å›¾ç‰‡è¿‡å°,é˜…è¯»è€…æ— æ³•çœ‹æ¸…çš„æƒ…å†µä¸‹,æ”¾å¤§é…ç½®å°±å·²ç„¶æˆä¸ºå¿…è¦ .fancybox<br>é…ç½®å¯ä»¥ç‚¹å‡»ä½¿å›¾ç‰‡æ”¾å¤§,å¹¶å¯åŒæ—¶æŸ¥çœ‹å…¨æ–‡çš„å›¾ç‰‡.æ›´æ”¹ä¸»é¢˜ç›®å½•ä¸‹çš„ _config.yml æ–‡ä»¶ fancybox å±æ€§.</p>
<pre><code># FancyBox is a tool that offers a nice and elegant way to add zooming functionality for images.
# For more information: https://fancyapps.com/fancybox/
fancybox: true
</code></pre>
]]></content>
      <categories>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>hexo blog</tag>
      </tags>
  </entry>
  <entry>
    <title>think of nodejs</title>
    <url>/2022/08/30/think-of-nodejs/</url>
    <content><![CDATA[<h1 id="npm"><a href="#npm" class="headerlink" title="npm"></a>npm</h1><h4 id="browserslist"><a href="#browserslist" class="headerlink" title="browserslist"></a>browserslist</h4><blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>ç”¨äºç¼–è¯‘è½¬åŒ–æ ·å¼æ–‡ä»¶ä»¥å…¼å®¹æµè§ˆå™¨çš„å¯¹äºå„ç±»æµè§ˆå™¨ç‰ˆæœ¬çš„ç­›é€‰.</p>
<blockquote>
<p>åˆ†ç±»</p>
</blockquote>
<p>[â€œ&gt;0.2%â€]: æŒ‡çš„æ˜¯ç°é˜¶æ®µçš„ç”¨æˆ·æ¯”ä¾‹&gt;0.2%çš„æ‰€æœ‰æµè§ˆå™¨ç‰ˆæœ¬.<br>[â€œlast 2 versionsâ€]: æŒ‡çš„æ˜¯ç°é˜¶æ®µæ‰€æœ‰æµè§ˆå™¨æœ€è¿‘å‘å¸ƒçš„ä¸¤ä¸ªç‰ˆæœ¬.<br>[â€œnot deadâ€]: æŒ‡çš„æ˜¯ç°é˜¶æ®µæ²¡æœ‰è¢«åˆ é™¤é”€æ¯çš„æ‰€æœ‰æµè§ˆå™¨ç‰ˆæœ¬.<br>[â€œdefaultsâ€]: ç›¸å½“äº â€œ&gt;0.2%â€ã€â€last 2 versionsâ€ä»¥åŠâ€not deadâ€ æµè§ˆå™¨ç‰ˆæœ¬çš„å¹¶é›†.<br>[â€œ&gt;0.2%â€,â€last 2 versionsâ€,â€not deadâ€]: ç›¸å½“äº â€œ&gt;0.2%â€ã€â€last 2 versionsâ€ä»¥åŠâ€not deadâ€ æµè§ˆå™¨ç‰ˆæœ¬çš„å¹¶é›†.<br>[â€œ&gt;0.2% and last 2 versions and not deadâ€]: ç›¸å½“äº â€œ&gt;0.2%â€ã€â€last 2 versionsâ€ä»¥åŠâ€not deadâ€ æµè§ˆå™¨ç‰ˆæœ¬çš„äº¤é›†.<br>[â€œ&gt;0.2% or last 2 versions or not deadâ€]: ç›¸å½“äº â€œ&gt;0.2%â€ã€â€last 2 versionsâ€ä»¥åŠâ€not deadâ€ æµè§ˆå™¨ç‰ˆæœ¬çš„å¹¶é›†.<br>[â€œnot &gt;0.2%â€]: æŒ‡çš„æ˜¯ç°é˜¶æ®µçš„ç”¨æˆ·æ¯”ä¾‹ &lt;=0.2% çš„æ‰€æœ‰æµè§ˆå™¨ç‰ˆæœ¬.</p>
<h4 id="version"><a href="#version" class="headerlink" title="version"></a>version</h4><blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>ç”¨äºå‘å¸ƒæ„å»º/ä¾èµ–/å·¥å…·æ—¶,å¯¹äºç‰ˆæœ¬å·çš„åˆ†ç±»ç®¡ç†.</p>
<blockquote>
<p>åˆ†ç±»</p>
</blockquote>
<ul>
<li>patch: æ˜¯å¯¹æ­¤æ„å»º/ä¾èµ–/å·¥å…·çš„è¡¥ä¸,å¸¸æŒ‡ä¿®å¤ä¸€äº›Bugã€ä»£ç æ ·å¼ç¾åŒ–ä»¥åŠå˜æ›´æ–‡æ¡£ç­‰.</li>
<li>minor: æ˜¯å¯¹æ­¤æ„å»º/ä¾èµ–/å·¥å…·åœ¨å½“å‰ API ä¸‹æ–°å¢ä¸€ä¸ªåŠŸèƒ½.</li>
<li>major: æ˜¯å¯¹æ­¤æ„å»º/ä¾èµ–/å·¥å…·ä¸å½“å‰ API å‡ºç°æ¯”è¾ƒå¤§çš„ä¸å…¼å®¹,ä¹Ÿå°±æ˜¯ BREAKING CHANGES çš„é‡æ„.</li>
</ul>
<h4 id="pre-version"><a href="#pre-version" class="headerlink" title="pre-version"></a>pre-version</h4><blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>å…ˆè¡Œç‰ˆæœ¬å·æ˜¯ä½œä¸ºæ„å»º/ä¾èµ–/å·¥å…·ç¨³å®šç‰ˆæœ¬ç”Ÿå‘½å‘¨æœŸçš„çº¿æ€§å›¾,å¯ç¡®ä¿å…¶ä¸Šçº¿çš„è´¨é‡ã€å®‰å…¨ä»¥åŠç¨³å®šæ€§.</p>
<blockquote>
<p>åˆ†ç±»</p>
</blockquote>
<ul>
<li>alpha: æ˜¯å†…æµ‹ç‰ˆæœ¬,ä¸€èˆ¬ä¼šæœ‰å¾ˆå¤š Bug,å†…æµ‹äººå‘˜ä½¿ç”¨.</li>
<li>beta: æµ‹è¯•ç‰ˆæœ¬,ä¼šå¼€æ”¾ä¸€éƒ¨åˆ†å¤–éƒ¨äººå‘˜æµ‹è¯•,è¿™é˜¶æ®µè¿˜æ˜¯ä¼šç»§ç»­å¼€å‘æ–°åŠŸèƒ½.</li>
<li>rc: å…¬æµ‹ç‰ˆæœ¬,ä¼šå®Œå…¨å¯¹å¤–å¼€æ”¾æµ‹è¯•,ä¸å†å¼€å‘æ·»åŠ æ–°åŠŸèƒ½.</li>
</ul>
<h4 id="npx"><a href="#npx" class="headerlink" title="npx"></a>npx</h4><blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>æ˜¯ npm è‡ªå¸¦çš„åŒ…æ‰§è¡Œå™¨.å…¶ä¸»è¦ä½œç”¨å°±æ˜¯å¯éšæ—¶æ‰§è¡Œé¡¹ç›®å†…å®‰è£…çš„å¯æ‰§è¡Œæ¨¡å—,ä¸”å¯åœ¨å…¨å±€ç¯å¢ƒå˜é‡ä¸‹è„šæœ¬å‘½ä»¤ä¸å­˜åœ¨æ—¶,è‡ªåŠ¨å®‰è£…æ‰§è¡Œ.</p>
<blockquote>
<p>åŸç†</p>
</blockquote>
<p>å…¶åŸç†éå¸¸ç®€å•,å°±æ˜¯è½®è¯¢ node_modules/.bin å­ç›®å½•ä»¥åŠ $PATH å…¨å±€ç¯å¢ƒå˜é‡ä¸‹æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„è„šæœ¬å‘½ä»¤,å¦‚æœå­˜åœ¨å°±æ‰§è¡Œ,æœ¬åœ°ä¸å­˜åœ¨åˆ™è‡ªåŠ¨å®‰è£…ä¸‹è½½æ‰§è¡Œ.</p>
<blockquote>
<p>å‚æ•°</p>
</blockquote>
<ul>
<li>â€“no-install: æŒ‡çš„æ˜¯å¼ºåˆ¶ä½¿ç”¨æœ¬åœ°æ¨¡å—,ç¦æ­¢ä¸‹è½½è¿œç¨‹æ¨¡å—.</li>
</ul>
<h4 id="inquirer"><a href="#inquirer" class="headerlink" title="inquirer"></a>inquirer</h4><blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>æ˜¯ç”¨äºä¸ç”¨æˆ·è¿›è¡Œç®€å•äº’åŠ¨çš„ä¾èµ–,å­˜åœ¨è¾“å…¥é€‰æ‹©ã€åˆ¤æ–­é€‰æ‹©ã€åˆ—è¡¨é€‰æ‹©ç­‰äº’åŠ¨æ–¹å¼.</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">const</span> inquirer = <span class="built_in">require</span>(<span class="string">&#x27;inquirer&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> prompt = inquirer.<span class="title function_">createPromptModule</span>();</span><br><span class="line"><span class="keyword">const</span> env = <span class="title function_">prompt</span>([&#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;list&#x27;</span>,</span><br><span class="line">    <span class="attr">message</span>: <span class="string">&#x27;è¯·é€‰æ‹© webpack æ„å»ºæ‰“åŒ…æ—¶æ‰€å±çš„ç¯å¢ƒ:&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;env&#x27;</span>,</span><br><span class="line">    <span class="attr">choices</span>: [</span><br><span class="line">        <span class="string">&#x27;development&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;production&#x27;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="title function_">filter</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> value.<span class="title function_">toLowerCase</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;]);</span><br><span class="line"><span class="keyword">const</span> _env = env[<span class="string">&#x27;env&#x27;</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(_env);</span><br></pre></td></tr></table></figure>

<h4 id="shelljs"><a href="#shelljs" class="headerlink" title="shelljs"></a>shelljs</h4><blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>æ˜¯é€šè¿‡ js æ–°å»º shell è„šæœ¬æ‰§è¡Œ shell å‘½ä»¤çš„ä¾èµ–,ç®€æ´æ˜“ç”¨.</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">const</span> &#123;exec&#125; = <span class="built_in">require</span>(<span class="string">&#x27;shelljs&#x27;</span>);</span><br><span class="line"><span class="title function_">exec</span>(<span class="string">&#x27;webpack&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="yargs"><a href="#yargs" class="headerlink" title="yargs"></a>yargs</h4><blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>æ˜¯ç”¨äºè§£æå‘½ä»¤è¡Œçš„ä¾èµ–,å¯å¯¹å‘½ä»¤è¡Œå‚æ•°é€ä¸ªè§£æ,åŠŸèƒ½æå…¶å¼ºå¤§.</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">const</span> yargs = <span class="built_in">require</span>(<span class="string">&#x27;yargs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> argv = process.<span class="property">argv</span>;</span><br><span class="line"><span class="keyword">const</span> env = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">yargs.<span class="title function_">parse</span>(argv.<span class="title function_">slice</span>(<span class="number">2</span>), <span class="function">(<span class="params">err, argv</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(err);</span><br><span class="line">    &#125;</span><br><span class="line">    env = argv[<span class="string">&#x27;env&#x27;</span>];</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(env);</span><br></pre></td></tr></table></figure>

<h4 id="rimraf"><a href="#rimraf" class="headerlink" title="rimraf"></a>rimraf</h4><blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>æ˜¯ç”¨äºé€’å½’å‰ƒæ‰åˆ é™¤é¡¹ç›®ç›®å½•çš„ä¾èµ–,å…¶ç»å¯¹æ ¹ç›®å½•æ˜¯ node æ‰€ä½œç”¨çš„ä½ç½®ç›®å½•,ä¹Ÿå°±æ˜¯ process.cwd().</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">const</span> rimraf = <span class="built_in">require</span>(<span class="string">&#x27;rimraf&#x27;</span>);</span><br><span class="line"><span class="comment">// é¦–å‚æ•°: ç›¸å¯¹äº node æ‰€ä½œç”¨çš„ä½ç½®ç›®å½•.</span></span><br><span class="line"><span class="comment">// å›è°ƒå‡½æ•°: åœ¨æ“ä½œè¿‡åæ‰§è¡Œçš„æ­¥éª¤.</span></span><br><span class="line"><span class="title function_">rimraf</span>(<span class="string">&#x27;./dist&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="spritesmith"><a href="#spritesmith" class="headerlink" title="spritesmith"></a>spritesmith</h4><blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>æ˜¯ç”¨äºåˆå¹¶å¤šä¸ªå›¾ç‰‡å½¢æˆé›ªç¢§å›¾çš„ä¾èµ–.</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">const</span> &#123;run&#125; = <span class="built_in">require</span>(<span class="string">&#x27;spritesmith&#x27;</span>);</span><br><span class="line"><span class="comment">// ä½ç½®ç›®å½•å¿…é¡»ä¸ºç»å¯¹è·¯å¾„</span></span><br><span class="line"><span class="title function_">run</span>(&#123;<span class="attr">src</span>: [<span class="string">&#x27;pic1.png&#x27;</span>, <span class="string">&#x27;pic2.png&#x27;</span>]&#125;, <span class="function">(<span class="params">err, image</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ä¼šç”Ÿæˆ 16è¿›åˆ¶ Buffer</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(image.<span class="property">image</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="jszip"><a href="#jszip" class="headerlink" title="jszip"></a>jszip</h4><blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>ç”¨äºä½¿ç”¨ js å®ç° zip å‹ç¼©æ‰“åŒ…çš„ä¾èµ–.</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">const</span> <span class="title class_">JsZip</span> = <span class="built_in">require</span>(<span class="string">&#x27;jszip&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> jszip = <span class="keyword">new</span> <span class="title class_">JsZip</span>();</span><br><span class="line"><span class="comment">// ç”Ÿæˆç©ºçš„å‹ç¼©æ‰“åŒ…æ–‡ä»¶</span></span><br><span class="line">jszip.<span class="title function_">folder</span>(<span class="string">&#x27;offline&#x27;</span>);</span><br><span class="line"><span class="comment">// ç”Ÿæˆå¡«å…¥å†…å®¹çš„å‹ç¼©æ‰“åŒ…æ–‡ä»¶</span></span><br><span class="line">jszip.<span class="title function_">file</span>(<span class="string">&#x27;index.js&#x27;</span>, <span class="string">&#x27;console.log(&quot;wtw&quot;)&#x27;</span>);</span><br><span class="line"><span class="comment">// å°†å‹ç¼©æ‰“åŒ…æ–‡ä»¶å®è¡Œå„ç§æ•°æ®ç±»å‹è½¬æ¢</span></span><br><span class="line">jszip.<span class="title function_">generatorAsync</span>(&#123;<span class="attr">type</span>: <span class="string">&#x27;nodebuffer&#x27;</span>&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">content</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(content);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è‡ªå®šä¹‰ webpack æ’ä»¶ä»¥ç”Ÿæˆç¦»çº¿å‹ç¼©åŒ…</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="keyword">const</span> &#123;resolve&#125; = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰çš„ç”Ÿæˆç¦»çº¿å‹ç¼©åŒ…çš„ webpack æ’ä»¶</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">JsZipPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;./lib/jsZipPlugin.js&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">OUTPUT_DIR</span> = <span class="title function_">resolve</span>(process.<span class="title function_">cwd</span>(), <span class="string">&#x27;./build&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> webpackConfig = &#123;</span><br><span class="line">    <span class="attr">mode</span>: <span class="string">&#x27;production&#x27;</span>,</span><br><span class="line">    <span class="attr">entry</span>: <span class="string">&#x27;./src/index.js&#x27;</span>,</span><br><span class="line">    <span class="attr">output</span>: &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="variable constant_">OUTPUT_DIR</span>,</span><br><span class="line">        <span class="attr">filename</span>: <span class="string">&#x27;index.js&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">plugins</span>: [</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">JsZipPlugin</span>(&#123;</span><br><span class="line">            <span class="attr">name</span>: <span class="string">&#x27;offline&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    ]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = wbpackConfig;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">JsZip</span> = <span class="built_in">require</span>(<span class="string">&#x27;jszip&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;<span class="title class_">RawSource</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;webpack-sources&#x27;</span>); </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JsZipPlugin</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">options</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">options</span> = options;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰€æœ‰çš„ webpack æ’ä»¶éƒ½éµå¾ªå…¶ tapable æ’ä»¶ä½“åˆ¶,ç±»ä¼¼äº EnventEmitter é‚£ç§è§‚å¯Ÿè®¢é˜…æ¨¡å¼</span></span><br><span class="line">    <span class="title function_">apply</span>(<span class="params">compiler</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;name = <span class="string">&#x27;&#x27;</span>&#125; = <span class="variable language_">this</span>.<span class="property">options</span>;</span><br><span class="line">        <span class="keyword">const</span> jszip = <span class="keyword">new</span> <span class="title class_">JsZipPlugin</span>();</span><br><span class="line">        <span class="comment">// è®¢é˜…ç”Ÿæˆæ–‡ä»¶æ—¶çš„ hooks äº‹ä»¶,emit æ˜¯ AsyncSeriesHook(å¼‚æ­¥ä¸²è¡Œ hook)</span></span><br><span class="line">        compiler.<span class="property">hooks</span>.<span class="property">emit</span>.<span class="title function_">tapAsync</span>(<span class="string">&#x27;JsZipPlugin&#x27;</span>, <span class="function">(<span class="params">compilation, callback</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// ç”Ÿæˆç©ºçš„å‹ç¼©æ‰“åŒ…æ–‡ä»¶</span></span><br><span class="line">            jszip.<span class="title function_">folder</span>(name);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> filename <span class="keyword">in</span> compilation.<span class="property">assets</span>) &#123;</span><br><span class="line">                <span class="comment">// ç”Ÿæˆå¡«å…¥ webpack æ„å»ºæ‰“åŒ…æºä»£ç çš„å‹ç¼©æ‰“åŒ…æ–‡ä»¶</span></span><br><span class="line">                jszip.<span class="title function_">file</span>(filename, compilation.<span class="property">assets</span>[filename].<span class="title function_">source</span>());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å®è¡Œ nodebuffer æ•°æ®ç±»å‹è½¬æ¢,å°†æºä»£ç è½¬æ¢ä¸º buffer,å¹¶æ”¾å…¥è‡³ webpack æ„å»ºæ‰“åŒ…ç”Ÿæˆçš„èµ„æºæ¨¡å—å†….</span></span><br><span class="line">            jszip.<span class="title function_">generatorAsync</span>(&#123;<span class="attr">type</span>: <span class="string">&#x27;nodebuffer&#x27;</span>&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">content</span>) =&gt;</span> &#123;</span><br><span class="line">                compilation.<span class="property">assets</span>[name] = <span class="keyword">new</span> <span class="title class_">RawSource</span>(content);</span><br><span class="line">                <span class="title function_">callback</span>();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>nodejs</category>
      </categories>
      <tags>
        <tag>npm</tag>
        <tag>nodejs</tag>
      </tags>
  </entry>
  <entry>
    <title>think of webpack</title>
    <url>/2022/08/30/think-of-webpack/</url>
    <content><![CDATA[<h1 id="webpack"><a href="#webpack" class="headerlink" title="webpack"></a>webpack</h1><h4 id="entry"><a href="#entry" class="headerlink" title="entry"></a>entry</h4><blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>  ä½œä¸º webpack æ„å»ºæ‰“åŒ…çš„å…¥å£,æœç´¢å…¨å±€èµ„æºçš„èµ·ç‚¹â€™.</p>
<blockquote>
<p>å±æ€§å€¼</p>
</blockquote>
<p>  ä¸ºä½•è®¾ç½® entry çš„å±æ€§å€¼å¿…é¡»ä¸ºç›¸å¯¹è·¯å¾„,è€Œç»å¯¹è·¯å¾„å´ä¼šæŠ¥é”™?</p>
<p>  è§£: entry æ˜¯ webpack æ„å»ºæ‰“åŒ…çš„å…¥å£,æ˜¯æœç´¢å…¨å±€èµ„æºçš„èµ·ç‚¹,å®ƒçš„å±æ€§å€¼æ˜¯è®¾ç½®ä¸ºç›¸å¯¹äºæ•´ä¸ªé¡¹ç›®è€Œè¨€çš„,ä¹Ÿå°±æ˜¯å½“å‰é¡¹ç›®æ ¹ç›®å½•,åœ¨ webpack context å±æ€§ä¸å˜çš„æƒ…å†µä¸‹, entry å±æ€§å€¼æ°¸è¿œç›¸å¯¹äºå½“å‰é¡¹ç›®æ ¹ç›®å½•,å½“ç„¶å¦‚è‹¥ context å±æ€§å€¼å‘ç”Ÿæ”¹å˜,entry æ˜¯å¯ä»¥è®¾ç½®ç»å¯¹è·¯å¾„çš„,å› ä¸º webpack æ‰€ä½œç”¨çš„æ„å»ºæ‰“åŒ…é¡¹ç›®æ ¹ç›®å½•å‘ç”Ÿäº†æ”¹å˜,å½“ç„¶ä¹Ÿå¯ä»¥å¼ºåˆ¶è®¾ç½® entry å±æ€§å€¼ä¸ºç»å¯¹è·¯å¾„,ä½†æ˜¯å…¶åªæ˜¯ç›¸å¯¹äºå½“å‰è®¾å¤‡ç›®å½•è€Œè¨€,æ˜¯å­˜åœ¨å¾ˆå¤§çš„é…ç½®é£é™©çš„.</p>
<h4 id="output"><a href="#output" class="headerlink" title="output"></a>output</h4><blockquote>
<p>filename</p>
</blockquote>
<p>  output.filename çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: ä½œä¸º webpack æ„å»ºæ‰“åŒ…å¯¼å‡ºæ–‡ä»¶çš„åç§°.  </p>
<blockquote>
<p>path</p>
</blockquote>
<p>  output.path çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: ä½œä¸º webpack æ„å»ºæ‰“åŒ…æ–‡ä»¶å¯¼å‡ºçš„ä½ç½®ç›®å½•.</p>
<blockquote>
<p>publicPath</p>
</blockquote>
<p>  output.publicPath çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: ä½œä¸º webpack æ„å»ºæ‰“åŒ…æ–‡ä»¶å¯¼å‡ºçš„ä½ç½®ç›®å½•å‰ç¼€.</p>
<blockquote>
<p>chunkFilename</p>
</blockquote>
<p>  output.chunkFilename çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: ä½œä¸º webpack æ„å»ºæ‰“åŒ…å¯¼å‡ºæ¨¡å—çš„åç§°.</p>
<blockquote>
<p>crossOriginLoading</p>
</blockquote>
<p>  output.crossOriginLoading çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: å…¶åªåœ¨ target: â€˜webâ€™ æ—¶ç”Ÿæ•ˆ,åˆ©ç”¨ JSONP å‘æ–‡ä»¶å†…è” &lt;script&gt; æ ‡ç­¾,å®ç°æŒ‰éœ€åŠ è½½æ¨¡å—.</p>
<h4 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h4><blockquote>
<p>åŸç†åˆ†æ</p>
</blockquote>
<p>  webpack â€“watch æ–‡ä»¶ç›‘å¬çš„åŸç†æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: è½®è¯¢å¯ç›‘å¬çš„ç¼–è¾‘æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´æ˜¯å¦å‘ç”Ÿå˜åŒ–,å¦‚æœå‘ç”Ÿäº†å˜åŒ–,åˆ™ä¼šå¼•èµ· webpack é‡æ–°æ„å»ºæ‰“åŒ….</p>
<blockquote>
<p>å‚æ•°</p>
</blockquote>
<p>  webpack â€“watch æ–‡ä»¶ç›‘å¬æœ‰å“ªäº›å‚æ•°?</p>
<p>  è§£: webpack â€“watch æ–‡ä»¶ç›‘å¬æœ‰ä¸€äº›å‚æ•°,å…¨éƒ½åœ¨å±æ€§ watchOptions ä¸­,å…¶ä¸­åŒ…å«ä¸‰ä¸ªä¸»è¦å‚æ•°: ignoredã€aggregateTimeoutå’Œpoll.</p>
<p>  webpack â€“watch æ–‡ä»¶ç›‘å¬é‡Œä¸»è¦å‚æ•°çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<ul>
<li>ignored =&gt; ç­›é€‰ä¸å®è¡Œç›‘å¬çš„ä½ç½®ç›®å½•.</li>
<li>aggregateTimeout =&gt; å½“è½®è¯¢åˆ°å¯ç›‘å¬çš„ç¼–è¾‘æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´å‘ç”Ÿäº†å˜åŒ–,ä¸ä¼šç«‹å³å‘ŠçŸ¥ç›‘å¬è€…å¼•èµ· webpack é‡æ–°æ„å»ºæ‰“åŒ…,è€Œæ˜¯ä¼šåŠ å…¥è‡³ç¼“å­˜ä¸­,åœ¨ aggregateTimeout æ—¶é—´æ®µå†…é‡å¤æ­¤ç±»æ“ä½œ,ç­‰æ—¶é—´æ®µç»“æŸä¹‹å,å°†ç¼“å­˜ä¸­çš„æ–‡ä»¶åˆ—è¡¨ç»Ÿä¸€å®è¡Œæ„å»ºæ‰“åŒ….</li>
<li>poll =&gt; åœ¨æŸä¸€ä¸ªæ—¶é—´æ®µå†…,è½®è¯¢çš„å¯ç›‘å¬çš„ç¼–è¾‘æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´æ˜¯å¦å‘ç”Ÿå˜åŒ–çš„æ¬¡æ•°.</li>
</ul>
<h4 id="devtool"><a href="#devtool" class="headerlink" title="devtool"></a>devtool</h4><blockquote>
<p>sourceMap</p>
</blockquote>
<p>  sourceMap çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: ç”¨äºå‰ç«¯å¼€å‘è€…æ ¹æ® sourceMap æ–‡ä»¶ç²¾ç¡®æ¢å¯»æºä»£ç çš„ä¸€äº›é—®é¢˜,å¼€å‘ç¯å¢ƒä¸€èˆ¬å¼€å¯,ç”Ÿäº§ç¯å¢ƒåˆ™å¿…é¡»å…³é—­.</p>
<blockquote>
<p>å‚æ•°</p>
</blockquote>
<p>  é¦–å…ˆäº†è§£å‡ ä¸ªæ¦‚å¿µ: cheapã€evalã€inlineã€moduleã€source-map</p>
<ul>
<li>cheap: æ„å»ºæ‰“åŒ…çš„ sourceMap æ–‡ä»¶åªèƒ½é€šè¿‡è¡Œè¿½è¸ª.</li>
<li>eval: è¡¨è¾¾å¼é€šè¿‡ eval è¯­æ³•åŒ…è£¹,æ³¨é‡Šç´§è·Ÿ eval è¯­æ³•å¤‡æ³¨æ‰€å‡ºäºçš„æºä»£ç ä½ç½®ç›®å½•.</li>
<li>inline: sourceMap é€šè¿‡å†…è” sourceMap dataURI è‡³æ„å»ºæ‰“åŒ…æ–‡ä»¶,ä¸ä¼šå•ç‹¬å¯¼å‡º .map æ–‡ä»¶.</li>
<li>module: ä¼šå¯¼å‡ºæœªè¢« loader å¤„ç†çš„æºä»£ç .</li>
<li>source-map: æ„å»ºæ‰“åŒ…ä¼šé¢å¤–å•ç‹¬å¯¼å‡º .map æ–‡ä»¶.</li>
</ul>
<p>  è¿™å‡ ä¸ªæ¦‚å¿µæŒ‰ç…§é€»è¾‘æ’åˆ—ç»„åˆ,è‡ªç„¶å½¢æˆäº†å„ç§å‚æ•°.ä¸¾å‡ ä¸ªğŸŒ°:</p>
<ul>
<li>source-map: ä¼šé¢å¤–å•ç‹¬å¯¼å‡º .map æ–‡ä»¶,å¯ç›´æ¥ç²¾ç¡®æ¢å¯»æºä»£ç .</li>
<li>cheap-source-map: ä¼šé¢å¤–å•ç‹¬å¯¼å‡º .map æ–‡ä»¶,å¯ç›´æ¥ç²¾ç¡®æ¢å¯»æºä»£ç ,ä½†å †æ ˆè¿½è¸ªé”™è¯¯åªèƒ½é€šè¿‡è¡Œ,ä¸ä¼šæ˜¾ç¤ºåˆ—.</li>
<li>inline-source-map: ä¸ä¼šé¢å¤–å•ç‹¬å¯¼å‡º .map æ–‡ä»¶,ä¼šé€šè¿‡å†…è” sourceMap dataURI è‡³æ„å»ºæ‰“åŒ…æ–‡ä»¶(ä½“ç§¯ä¼šæ˜æ˜¾å¢å¤§),å¯ç›´æ¥ç²¾ç¡®æ¢å¯»æºä»£ç .</li>
<li>cheap-module-source-map: ä¼šé¢å¤–å•ç‹¬å¯¼å‡º .mapæ–‡ä»¶,å¯ç›´æ¥ç²¾ç¡®æ¢å¯»æœªè¢« loader å¤„ç†æ—¶çš„æºä»£ç ,ä½†å †æ ˆè¿½è¸ªé”™è¯¯åªèƒ½é€šè¿‡è¡Œ,ä¸ä¼šæ˜¾ç¤ºåˆ—.</li>
<li>eval: ä¸ä¼šé¢å¤–å•ç‹¬å¯¼å‡º .map æ–‡ä»¶,è¡¨è¾¾å¼é€šè¿‡ eval è¯­æ³•åŒ…è£¹,æ³¨é‡Šç´§è·Ÿ eval è¯­æ³•å¤‡æ³¨æ‰€å‡ºäºçš„æºä»£ç ä½ç½®ç›®å½•,æ— æ³•ç›´æ¥ç²¾ç¡®æ¢å¯»æºä»£ç .</li>
</ul>
<h4 id="splitChunks"><a href="#splitChunks" class="headerlink" title="splitChunks"></a>splitChunks</h4><blockquote>
<p>å‚æ•°</p>
</blockquote>
<ul>
<li>chunks: æœ‰ä¸‰ä¸ªæšä¸¾é€‰é¡¹,â€asyncâ€ã€â€initial â€œä»¥åŠ â€œallâ€,é»˜è®¤ä¸º â€œasyncâ€,è¡¨ç¤ºå¯¹äºå¼‚æ­¥ã€éå¼‚æ­¥ä»¥åŠå…¨éƒ¨çš„æ¨¡å—ä»£ç åˆ†å‰²çš„é€‰æ‹©.</li>
<li>minChunks: è¡¨ç¤ºæ¨¡å—æœ€å°‘å¯è¢«å¯¼å…¥å®ç°åˆ†å‰²çš„æ¬¡æ•°,é»˜è®¤ä¸º 1.</li>
<li>minSize: è¡¨ç¤ºæ¨¡å—æœ€å°‘å¯è¢«åˆ†å‰²çš„ä½“ç§¯å¤§å°,é»˜è®¤ä¸º 30000,ä¹Ÿå°±æ˜¯ 30kb.</li>
<li>maxInitialRequests: è¡¨ç¤ºå…¥å£æ¨¡å—å¹¶å‘è¯·æ±‚çš„æœ€å¤§æ¬¡æ•°,é»˜è®¤ä¸º 3.</li>
<li>maxAsyncRequests: è¡¨ç¤ºæ¨¡å—æŒ‰éœ€åŠ è½½å¹¶å‘è¯·æ±‚çš„æœ€å¤§æ¬¡æ•°,é»˜è®¤ä¸º 5.</li>
<li>name: æ¨¡å—ä»£ç åˆ†å‰²åå¯¼å‡ºæ¨¡å—çš„åç§°.</li>
<li>cacheGroups: ç¼“å­˜ç»„å¯é…ç½®å¤šä¸ªç»„,ç»„ä¸­çš„å…ƒç´ ä¼šè¦†ç›–æˆ–è€…ç»§æ‰¿ç»„å¤–çš„å±æ€§å€¼,é™¤äº† testã€priority ä»¥åŠ reuseExistingChunk.</li>
<li>cacheGroups.test: ç­›é€‰è¦åˆ†å‰²å¯¼å‡ºçš„æ¨¡å—.</li>
<li>cacheGroups.priority: å¯é€šè¿‡ä¼˜å…ˆçº§æ¥æ”¹å˜æ„å»ºæ‰“åŒ…æ¨¡å—ä»£ç åˆ†å‰²çš„é¡ºåº,é»˜è®¤å€¼ä¸º -20.</li>
</ul>
<h4 id="TreeShaking"><a href="#TreeShaking" class="headerlink" title="TreeShaking"></a>TreeShaking</h4><blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>  å¯ç”¨äºå°†æ°¸è¿œæ‰§è¡Œä¸åˆ°çš„ã€æ— ç”¨çš„å˜é‡ä»¥åŠæ‰§è¡Œçš„ä»£ç ç»“æœä¸ä¼šè¢«ä½¿ç”¨çš„è¡¨è¾¾å¼,å‰”é™¤å‡ºæ„å»ºæ‰“åŒ…æ–‡ä»¶.<br>  PS: åªèƒ½ä½œç”¨äºå¯é™æ€åˆ†æçš„ ESM æ¨¡å—, commonjs æˆ–è€… commonjs2 æ¨¡å—éƒ½ä¸ä¼šç”Ÿæ•ˆ.</p>
<h4 id="Scope-Hoisting"><a href="#Scope-Hoisting" class="headerlink" title="Scope Hoisting"></a>Scope Hoisting</h4><blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>  å¯¹äºä¸å¼€å¯ Scope Hoisting çš„æ„å»ºæ‰“åŒ…æ–‡ä»¶æ¥è¯´,ä¼šå­˜åœ¨å¤§é‡çš„ IIFE è‡ªæ‰§è¡Œå‡½æ•°è¡¨è¾¾å¼é—­åŒ…,webpack ä¼šå¯¹æ¯ä¸ªå¯¼å…¥æ¨¡å—å¤–åŠ ä¸€å±‚åŒ…è£¹,ä¸”å°† import è½¬åŒ–æˆ <strong>webpack_require</strong>,è¿™æ ·å°±ä¼šå¯¼è‡´æ„å»ºæ‰“åŒ…æ–‡ä»¶ä½“ç§¯å¢å¤§,è€Œå¤§é‡çš„é—­åŒ…ä¹Ÿä¼šå¯¼è‡´è®¾å¤‡çš„å†…å­˜ç©ºé—´åƒç´§,è€Œ Scope Hoisting å°±æ˜¯ç”¨æ¥è§£å†³æ­¤ç±»é—®é¢˜çš„,Webpack 4.x å½“ä¸­åªè¦å°† mode è®¾ç½®ä¸º â€œproductionâ€,å°±ä¼šå¼€å¯ Scope Hoisting,è€Œåœ¨ Webpack 4.x ä¹‹å‰çš„ç‰ˆæœ¬åˆ™éœ€å¼•å…¥ new webpack.optimize.ModuleConcatenationPlugin(),Scope Hoisting ä¼šå°†å¯¼å…¥çš„æ¨¡å—å†…è”è¿›ä¸€ä¸ªå¤§çš„å‡½æ•°ä½œç”¨åŸŸä¸­,ä½¿æ¨¡å—æŒ‰ç…§å¼•ç”¨çš„é¡ºåºè¿›è¡Œæ’åˆ—,é€‚å½“çš„é‡å‘½åä¸€äº›å˜é‡ä»¥é˜²æ­¢å˜é‡åå†²çª,è¿™æ ·å°±ä¼šå¤§å¤§å‡å°‘æ–‡ä»¶ä»¥åŠå†…å­˜ç©ºé—´çš„ä½“ç§¯.</p>
<p>  PS: åªèƒ½ä½œç”¨äºå¯é™æ€åˆ†æçš„ ESM æ¨¡å—, commonjs æˆ–è€… commonjs2 æ¨¡å—éƒ½ä¸ä¼šç”Ÿæ•ˆ.</p>
<h4 id="resolve"><a href="#resolve" class="headerlink" title="resolve"></a>resolve</h4><blockquote>
<p>alias</p>
</blockquote>
<p>  resolve.alias çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: ä½¿ç”¨åˆ«åæ›¿ä»£å¤æ‚çš„æ¨¡å—å¯¼å…¥è·¯å¾„.</p>
<blockquote>
<p>mainFields</p>
</blockquote>
<p>  resolve.mainFields çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: è‡ªå®šä¹‰ä¾èµ–è¢«å¯¼å…¥çš„æ–‡ä»¶ä½ç½®.</p>
<blockquote>
<p>extensions</p>
</blockquote>
<p>  resolve.extensions çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: é€‰æ‹©çœç•¥å¯¼å…¥æ¨¡å—çš„åç¼€.</p>
<blockquote>
<p>modules</p>
</blockquote>
<p>  resolve.modules çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: æŒ‡å®šå¯¼å…¥ä¾èµ–çš„ä½ç½®ç›®å½•.</p>
<blockquote>
<p>enforceExtensions</p>
</blockquote>
<p>  resolve.enforceExtensions çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: å¼ºåˆ¶å¯¼å…¥æ¨¡å—å¿…é¡»æ·»åŠ åç¼€.</p>
<h4 id="module"><a href="#module" class="headerlink" title="module"></a>module</h4><blockquote>
<p>noParse</p>
</blockquote>
<p>  module.noParse çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: ç”¨äº webpack ç­›é€‰å¯å¿½ç•¥çš„æœªä½¿ç”¨æ ‡å‡†æ¨¡å—çš„ä¾èµ–,å¦‚ jQuery ç­‰,PS: ç­›é€‰å¯å¿½ç•¥çš„ä¾èµ–åº”è¯¥ä¸åŒ…å« import,define,require ç­‰æ ‡å‡†æ¨¡å—è¯­ä¹‰.</p>
<h4 id="externals"><a href="#externals" class="headerlink" title="externals"></a>externals</h4><blockquote>
<p>ä½œç”¨</p>
</blockquote>
<p>  ç”¨äº webpack ç­›é€‰ä¸å®è¡Œæ„å»ºæ‰“åŒ…çš„ä¾èµ–,æ¯”å¦‚ jQuery è¿™ç§ä½“ç§¯éå¸¸åºå¤§,æ„å»ºæ‰“åŒ…æ²¡æœ‰ä»»ä½•æ”¶ç›Šçš„ä¾èµ–,æœ€åç›´æ¥ä½œä¸ºå…¨å±€å˜é‡å†…è”å…¥æ„å»ºæ‰“åŒ…æ–‡ä»¶å†….</p>
<h4 id="loaders"><a href="#loaders" class="headerlink" title="loaders"></a>loaders</h4><blockquote>
<p>babel-loader</p>
</blockquote>
<p>  @babel/preset-env çš„å‚æ•° modules çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: modules =&gt; é€šè¿‡ babel è½¬åŒ–çš„æ¨¡å—å¯¼å‡ºæ˜¯å¦ä¸ºå…¶ä»–ç±»å‹,é»˜è®¤æ¨¡å—å¯¼å‡ºä¸º â€˜EsModuleâ€™,å…¶ä»–ç±»å‹å¦‚ â€˜commonjsâ€™,â€™commonjs2â€™,â€™amdâ€™ ç­‰,è®¾ç½®ä¸º false è¡¨æ˜ä¸æ”¹å˜æ¨¡å—å¯¼å‡ºç±»å‹.</p>
<p>  @babel/preset-env çš„å‚æ•° loose çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: loose =&gt; é€šè¿‡ babel è½¬åŒ–æ˜¯å¦å¼€å¯æ¾æ•£æ¨¡å¼.</p>
<ul>
<li><p>ä½•ä¸º loose æ¾æ•£æ¨¡å¼?</p>
<p>è§£: babel åœ¨è½¬æ¢æ—¶ä¸€èˆ¬æœ‰ä¸¤ç§è½¬æ¢æ¨¡å¼: æ¾æ•£æ¨¡å¼(loose)ä¸æ ‡å‡†æ¨¡å¼(normal),æ¾æ•£æ¨¡å¼ä¼šè½¬æ¢ä¸ºå‰ç«¯å¼€å‘è€…æœ€ç†Ÿæ‚‰çš„ç®€æ´çš„ ES5 ä»£ç ,è€Œæ ‡å‡†æ¨¡å¼è½¬æ¢å‡ºçš„ä»£ç åˆ™æ›´è´´è¿‘ ES6 çš„è¯­ä¹‰.</p>
</li>
<li><p>loose æ¾æ•£æ¨¡å¼çš„ä¼˜ç¼ºç‚¹?</p>
<ul>
<li>ä¼˜ç‚¹: è½¬æ¢å‡ºçš„ä»£ç æ›´åŠ æ˜“è¯»,ä½“ç§¯æ›´å°,æ‰§è¡Œæ•ˆç‡æ›´é«˜,å¯¹äºè€æµè§ˆå™¨å…¼å®¹æ€§æ›´å¥½.</li>
<li>ç¼ºç‚¹: å¯¹äºåŸç”Ÿ ES6 è¯­æ³•çš„ä»£ç è½¬æ¢æ—¶ç»å¸¸ä¼šå‡ºç°é—®é¢˜.</li>
<li>æ€»ç»“: åŸºæœ¬ä¸Šåœ¨ä½¿ç”¨æ—¶ä¸ä¼šå¼€å¯ loose æ¾æ•£æ¨¡å¼.</li>
</ul>
</li>
</ul>
<p>  @babel/preset-env çš„å‚æ•° useBuiltIns çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: æ˜¯ç”¨äºæ ¹æ® browserslist çš„æµè§ˆå™¨ç‰ˆæœ¬é›†åˆæ¥å…¼å®¹çš„åŠ¨æ€ polyfill ç­–ç•¥.</p>
<ul>
<li><p>â€˜entryâ€™</p>
<p>ä¼šå°† browserslist çš„æ‰€æœ‰æµè§ˆå™¨ç‰ˆæœ¬ä¸å…¼å®¹çš„ polyfill ä¼˜å…ˆå…¨éƒ¨å¯¼å…¥è‡³ chunks å…¥å£å¤„.é…åˆ <a href="mailto:&#x63;&#111;&#114;&#x65;&#x2d;&#106;&#115;&#64;&#x33;&#x2e;&#x78;">&#x63;&#111;&#114;&#x65;&#x2d;&#106;&#115;&#64;&#x33;&#x2e;&#x78;</a> å¯å®ç°æŒ‰éœ€åŠ è½½,å¯è‡ªå®šä¹‰å¯¼å…¥è‡³å…¥å£çš„ polyfill æ¨¡å—,PS: å¿…é¡»æ˜¯åœ¨ browserslist æ‰€æœ‰æµè§ˆå™¨ç‰ˆæœ¬ä¸å…¼å®¹çš„ polyfill èŒƒå›´å†….</p>
</li>
<li><p>â€˜usageâ€™</p>
<p>ä¼šå°† browserslist çš„æ‰€æœ‰æµè§ˆå™¨ç‰ˆæœ¬ä¸å…¼å®¹çš„ polyfill æ ¹æ®æ¨¡å—ä½¿ç”¨å¤„çš„ API ç‰¹å®šæŒ‰éœ€å¯¼å…¥.</p>
</li>
<li><p>false(æä¸æ¨è)</p>
<p>ä¼šæ— è§† browserslist å°†æ‰€æœ‰çš„ @babel/polyfill å¯¼å…¥è‡³ chunks å…¥å£å¤„.</p>
</li>
</ul>
<p>  @babel/preset-env çš„å‚æ•° corejs çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: å¿…é¡»é…åˆ useBuiltIns: â€˜entryâ€™ æˆ–è€… useBuiltIns: â€˜usageâ€™ ä½¿ç”¨,åŸºæœ¬ä¸Šç”¨äºå°†æœªçº³å…¥ ECMASCRIPT ç¨³å®šè¯­æ³•çš„ proposal æ–°ç‰¹æ€§æ³¨å…¥è‡³ polyfill ä¸­.</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="attr">presets</span>: [[</span><br><span class="line">      <span class="string">&#x27;@babel/preset-env&#x27;</span>, &#123;</span><br><span class="line">          <span class="attr">useBuiltIns</span>: <span class="string">&#x27;usage&#x27;</span>,</span><br><span class="line">          <span class="attr">corejs</span>: &#123;</span><br><span class="line">              <span class="attr">version</span>: <span class="number">3</span>,</span><br><span class="line">              <span class="attr">proposal</span>: <span class="literal">true</span></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  ]]</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>css-loader</p>
</blockquote>
<p>  ä¸ºä½• css-loader options å‚æ•° minimize å‹ç¼©åŠŸèƒ½å¤±æ•ˆ?</p>
<p>  è§£: é€šè¿‡æŸ¥è¯¢,webpack 3.x =&gt; 4.x &amp;&amp; css-loader 0.x =&gt; 1.x å·²ç»å°† options minimize å‚æ•°å‹ç¼©åŠŸèƒ½åˆ æ‰.</p>
<blockquote>
<p>postcss-loader</p>
</blockquote>
<p>  ä¸ºä½•é€‰ç”¨ postcss-preset-env æ›¿ä»£ autoprefixer æ¥ç¼–è¯‘è½¬åŒ–æ ·å¼æ–‡ä»¶å…¼å®¹æµè§ˆå™¨å‘¢?</p>
<p>  è§£: postcss æœ¬è´¨çš„ä½œç”¨å°±æ˜¯å°†æ›´å¤š css çš„æ–°æ ·å¼ã€æ–°ç‰¹æ€§å…¼å®¹æ›´å¤šçš„æµè§ˆå™¨.postcss-preset-env ä¸­å¼•ç”¨äº† autoprefixer,ä¸”å…¶æ¯” autoprefixer èƒ½ç¼–è¯‘è½¬åŒ– css çš„æ–°ç‰¹æ€§,è¿™æ˜¯ autoprefixer ä¸­ä¸å­˜åœ¨çš„åŠŸèƒ½,å¦‚ color: #12345678 è¿™æ ·åŒ…æ‹¬é€æ˜åº¦çš„åå…­è¿›åˆ¶ css é¢œè‰²æ–°ç‰¹æ€§,æ‰€ä»¥é€‰ç”¨ postcss-preset-env æ›¿ä»£ autoprefixer æ¥ç¼–è¯‘è½¬åŒ–æ ·å¼æ–‡ä»¶.</p>
<p>  ä¸ºä½• postcss.config.js &gt; plugins ä¸ postcss-loader &gt; postcssOptions &gt; plugins åŒæ—¶å­˜åœ¨çš„æƒ…å†µä¸‹,ä¸¤è€…åŒæ—¶ç”Ÿæ•ˆ?</p>
<p>  è§£: ä¸¤è€…åŒæ—¶å­˜åœ¨çš„æƒ…å†µä¸‹,postcss.config.js &gt; plugins ä¸ä¼šè¢«è¦†ç›–,è€Œæ˜¯ä¼šè¢«ç»§æ‰¿åˆå¹¶åŒæ—¶ç”Ÿæ•ˆ.</p>
<p>  ç°åœ¨ç§»åŠ¨ç«¯åˆ†è¾¨ç‡é€‚é…ä½¿ç”¨çš„æ˜¯ vw/vh çš„ç­–ç•¥,é‚£ä¹ˆå¦‚ä½•å°† UI å›¾ä¸Šçš„ç»å¯¹åƒç´ å€¼( px )åŠ¨æ€è½¬åŒ–ä¸º vw å‘¢?</p>
<p>  é¦–å…ˆè¦äº†è§£å‡ ä¸ªæ¦‚å¿µ: </p>
<ul>
<li>vw/vh: ç±»ä¼¼äºç™¾åˆ†æ¯”,ä¸è¿‡æ˜¯ç›¸å¯¹äºç†æƒ³è§†å£è®¾ç½®çš„å®½åº¦ä»¥åŠé«˜åº¦.</li>
<li>ç†æƒ³è§†å£: åœ¨ä¸å®è¡Œç¼©æ”¾çš„æƒ…å†µä¸‹,å°†ç‰©ç†åƒç´ ç²¾ç¡®è½¬åŒ–ä¸ºå„ä¸ªè®¾å¤‡çš„ CSS åƒç´ (dpr)çš„ç¯å¢ƒ.</li>
<li>DPR: DPR = ç‰©ç†åƒç´ /åˆ†è¾¨ç‡.</li>
</ul>
<p>  ä½¿ç”¨ postcss-px-to-viewport æ¥å°† px åŠ¨æ€è½¬åŒ–ä¸º vw.</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//postcss.config.js</span></span><br><span class="line"><span class="keyword">const</span> postcssConfig = &#123;</span><br><span class="line">    <span class="attr">plugins</span>: [</span><br><span class="line">        <span class="string">&#x27;postcss-preset-env&#x27;</span>,</span><br><span class="line">        [</span><br><span class="line">            <span class="string">&#x27;postcss-px-to-viewport&#x27;</span>,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">unitToConvert</span>: <span class="string">&#x27;px&#x27;</span>,</span><br><span class="line">                <span class="attr">unitPrecision</span>: <span class="number">8</span>,</span><br><span class="line">                <span class="attr">viewportUnit</span>: <span class="string">&#x27;vw&#x27;</span>,</span><br><span class="line">                <span class="attr">viewportWidth</span>: <span class="number">750</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    ]</span><br><span class="line">&#125;;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = postcssConfig;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>url-loader</p>
</blockquote>
<p>  url-loader ä¸ file-loader çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: url-loader ä¸ file-loader åœ¨å¤„ç†æ–‡ä»¶èµ„æºåŠŸèƒ½ä¸Šé¢å¹¶æ²¡æœ‰å¾ˆå¤§çš„åŒºåˆ«,url-loader ä¸­æ˜¯å¼•ç”¨äº† file-loader çš„,ä½†æ˜¯ url-loader æ ¹æ®å‚æ•°é™åˆ¶èƒ½å¤Ÿè½¬åŒ–ä¸ºæ›´å°çš„æ–‡ä»¶èµ„æº dataURI,æ¯”å¦‚å›¾ç‰‡ Base64.</p>
<blockquote>
<p>Asset Module</p>
</blockquote>
<p>  webpack 5.x ä¸­å¯¹äºèµ„æºæ¨¡å—çš„å¤„ç†è¿›è¡Œäº†å‡çº§ä¼˜åŒ–,æ— éœ€é¢å¤–é…ç½®å³å¯å¤„ç†èµ„æºæ–‡ä»¶(å­—ä½“ï¼Œå›¾æ ‡ç­‰).</p>
<p>  èµ„æºæ¨¡å—ç±»å‹(asset module type),é€šè¿‡æ·»åŠ  4 ç§æ–°çš„æ¨¡å—ç±»å‹,æ¥æ›¿æ¢æ‰€æœ‰è¿™äº› loader:</p>
<ul>
<li>asset/resource å‘é€ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶å¹¶å¯¼å‡º URL.ä¹‹å‰é€šè¿‡ä½¿ç”¨ file-loader å®ç°.</li>
<li>asset/inline å¯¼å‡ºä¸€ä¸ªèµ„æºçš„ data URI.ä¹‹å‰é€šè¿‡ä½¿ç”¨ url-loader å®ç°.</li>
<li>asset/source å¯¼å‡ºèµ„æºçš„æºä»£ç .ä¹‹å‰é€šè¿‡ä½¿ç”¨ raw-loader å®ç°.</li>
<li>asset åœ¨å¯¼å‡ºä¸€ä¸ª data URI å’Œå‘é€ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ä¹‹é—´è‡ªåŠ¨é€‰æ‹©.ä¹‹å‰é€šè¿‡ä½¿ç”¨ url-loader,å¹¶ä¸”é…ç½®èµ„æºä½“ç§¯é™åˆ¶å®ç°.</li>
</ul>
<p>  asset å®é™…ä¸Šå¯ä»¥ç†è§£ä¸ºæ¯”è¾ƒé€šç”¨çµæ´»çš„é…ç½®,é€šå¸¸å¼€å‘æ—¶åŸºæœ¬ä¸Šä½¿ç”¨ type: â€˜assetâ€™.</p>
<ul>
<li><p>generator</p>
<p>åœ¨é…ç½® module.rules æ—¶,å¯é…ç½® generator æ¥å¯¹èµ„æºæ¨¡å—å¤„ç†è¿›è¡Œè¿›ä¸€æ­¥æ§åˆ¶,è¯¥é…ç½®æœ‰ä»¥ä¸‹å‡ ä¸ªå±æ€§:</p>
<ul>
<li><p>filename</p>
<ul>
<li>å€¼å¿…é¡»ä¸ºç›¸å¯¹è·¯å¾„,å¯æ”¹å˜èµ„æºè¾“å‡ºçš„ç›®å½•;</li>
<li>å¦‚æœåŒæ—¶æŒ‡å®šäº†è¯¥å±æ€§å’Œ output.assetModuleFilename,å°†å¿½ç•¥ output.assetModuleFilename çš„å€¼;</li>
<li>è¯¥å±æ€§ä»…é€‚ç”¨äº asset å’Œ asset/resource èµ„æºç±»å‹.</li>
</ul>
</li>
<li><p>dataUrl</p>
<ul>
<li>åœ¨å¤„ç† inline ç±»å‹çš„èµ„æºæ—¶,è¯¥èµ„æºé»˜è®¤å¯¹èµ„æºè¿›è¡Œ base64 ç¼–ç ,å¯é€šè¿‡è¯¥å±æ€§æ¥æ”¹å˜å…¶ç¼–ç æ–¹å¼;</li>
<li>è¯¥å±æ€§å€¼ä¸ºå‡½æ•°,å…¶ç­¾åä¸º (content: string) =&gt; string;</li>
<li>è¯¥å±æ€§ä»…é€‚ç”¨äº asset å’Œ asset/inline èµ„æºç±»å‹.</li>
</ul>
</li>
</ul>
</li>
<li><p>parser</p>
<ul>
<li><p>dataUrlCondition.maxSize:</p>
<ul>
<li>å½“ type ä¸º asset æ—¶,å¦‚æœèµ„æºå¤§å°å°äº 8kb,æŒ‰ç…§ asset/inline çš„è§„åˆ™å¤„ç†èµ„æº,å¦åˆ™æŒ‰ç…§ asset/resource çš„è§„åˆ™å¤„ç†èµ„æº;</li>
<li>å¯é€šè¿‡æŒ‡å®šè¯¥å±æ€§æ¥æ”¹å˜å…¶ç•Œé™å€¼(å•ä½ä¸º byte);</li>
<li>è¯¥å±æ€§ä»…é€‚ç”¨äº asset èµ„æºç±»å‹.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>  ç¤ºä¾‹:</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">      <span class="attr">rules</span>: [<span class="comment">//...</span></span><br><span class="line">      &#123;</span><br><span class="line">          <span class="attr">test</span>: <span class="regexp">/\.(bmp|gif|jpg|jpeg|gif)$/</span>,</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;asset&#x27;</span>,</span><br><span class="line">          <span class="attr">generator</span>: &#123;</span><br><span class="line">              <span class="attr">publicPath</span>: <span class="string">&#x27;./&#x27;</span>,</span><br><span class="line">              <span class="comment">// æ³¨æ„,è¿™é‡Œèµ„æºæ¨¡å—æ–‡ä»¶åç¼€[ext]ä¸å¼•å…¥ loader æ–¹å¼æ—¶æœ‰æ‰€ä¸åŒ,è¿™é‡Œä»£è¡¨.bmp .png .gif .jpg .jpeg,è€Œå¼•å…¥ loader æ—¶,[ext] æ˜¯ä¸å«æœ‰ &#x27;.&#x27; å­—ç¬¦çš„.</span></span><br><span class="line">              <span class="attr">filename</span>: <span class="string">&#x27;assets/images/[name].[contenthash:6][ext]&#x27;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">parser</span>: &#123;</span><br><span class="line">              <span class="attr">dataUrlCondition</span>: &#123;</span><br><span class="line">                  <span class="attr">maxSize</span>: <span class="number">5</span> * <span class="number">1024</span></span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//..</span></span><br><span class="line">      ]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>raw-loader</p>
</blockquote>
<p>  åœ¨ä¹‹å‰çš„ç§»åŠ¨ç«¯åˆ†è¾¨ç‡é€‚é…æ—¶,æ˜¯ä½¿ç”¨ç›¸å¯¹åƒç´ å€¼(rem)+åŠ¨æ€è®¡ç®—å…ƒèŠ‚ç‚¹ç»å¯¹åƒç´ å€¼çš„ç­–ç•¥,ä½†æ˜¯å´ä¼šå­˜åœ¨ raw-loader å†…è”èµ„æºå¿…é¡»ä¸‹è½½ä½ç‰ˆæœ¬ 0.5.1 çš„é™åˆ¶,ä¸ºä»€ä¹ˆå¿…é¡»è¦ä¸‹è½½ä½ç‰ˆæœ¬ 0.5.1 çš„ raw-loader å‘¢?</p>
<p>  è§£: é¦–å…ˆäº†è§£å‡ ä¸ªæ¦‚å¿µ: px2rem-loaderã€lib-flexible ä»¥åŠ raw-loader.</p>
<ul>
<li>px2rem-loader: ç”¨äºå°† px ç»å¯¹åƒç´ å€¼è½¬åŒ–ä¸º rem ç›¸å¯¹åƒç´ å€¼.</li>
<li>lib-flexible: ç”¨äºåŠ¨æ€è®¡ç®—å…ƒèŠ‚ç‚¹ç»å¯¹åƒç´ å€¼çš„å·¥å…·.</li>
<li>raw-loader: ç”¨äºå†…è”èµ„æºæ¨¡å—,å¯¼å‡ºæ–‡ä»¶èµ„æºçš„æºä»£ç .</li>
</ul>
<p>  æ–°ç‰ˆæœ¬çš„ raw-loader å­˜åœ¨ä¸€äº›é—®é¢˜,æŸ¥è¯¢äº†æºä»£ç åå‘ç°,å¯¼å‡ºçš„èµ„æºæ¨¡å—æºä»£ç æ¨¡å—å¯¼å‡ºç±»å‹ä¸º â€˜EsModuleâ€™,è½¬åŒ–æˆå­—ç¬¦ä¸²ä¸ºâ€™[object Object]â€˜,è¦å¯¹ raw-loader è¿›è¡Œå¤„ç†,å¯¹å…¶å±æ€§ esModule è®¾ç½®ä¸º false,å°±å¯è§£å†³å¿…é¡»ä¸‹è½½ä½ç‰ˆæœ¬ 0.5.1 çš„ raw-loader çš„é™åˆ¶.</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- ä½¿ç”¨ raw-loader å†…è”èµ„æºæ¨¡å—ä¹‹å‰  --&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">  &lt;html lang=&quot;zh-CN&quot;&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">      &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">      &lt;title&gt;Webpack Emulate&lt;/title&gt;</span><br><span class="line">      &lt;script type=&quot;text/javascript&quot;&gt;&lt;%= require(&quot;raw-loader?esModule=false!babel-loader!../node_modules/lib-flexible/flexible&quot;) %&gt;&lt;/script&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">  &lt;div id=&quot;root-webpack&quot;&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- ä½¿ç”¨ raw-loader å†…è”èµ„æºæ¨¡å—ä¹‹å  --&gt;</span><br><span class="line">&lt;!doctype html&gt;&lt;html lang=&quot;zh-CN&quot;&gt;&lt;head&gt;&lt;meta charset=&quot;UTF-8&quot;&gt;&lt;title&gt;Webpack Emulate&lt;/title&gt;</span><br><span class="line">  &lt;script&gt;;(function (win, lib) &#123;</span><br><span class="line">          var doc = win.document;</span><br><span class="line">          var docEl = doc.documentElement;</span><br><span class="line">          var metaEl = doc.querySelector(&#x27;meta[name=&quot;viewport&quot;]&#x27;);</span><br><span class="line">          var flexibleEl = doc.querySelector(&#x27;meta[name=&quot;flexible&quot;]&#x27;);</span><br><span class="line">          var dpr = 0;</span><br><span class="line">          var scale = 0;</span><br><span class="line">          var tid;</span><br><span class="line">          var flexible = lib.flexible || (lib.flexible = &#123;&#125;);</span><br><span class="line"></span><br><span class="line">          if (metaEl) &#123;</span><br><span class="line">              console.warn(&#x27;å°†æ ¹æ®å·²æœ‰çš„metaæ ‡ç­¾æ¥è®¾ç½®ç¼©æ”¾æ¯”ä¾‹&#x27;);</span><br><span class="line">              var match = metaEl.getAttribute(&#x27;content&#x27;).match(/initial\-scale=([\d\.]+)/);</span><br><span class="line"></span><br><span class="line">              if (match) &#123;</span><br><span class="line">                  scale = parseFloat(match[1]);</span><br><span class="line">                  dpr = parseInt(1 / scale);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; else if (flexibleEl) &#123;</span><br><span class="line">              var content = flexibleEl.getAttribute(&#x27;content&#x27;);</span><br><span class="line"></span><br><span class="line">              if (content) &#123;</span><br><span class="line">                  var initialDpr = content.match(/initial\-dpr=([\d\.]+)/);</span><br><span class="line">                  var maximumDpr = content.match(/maximum\-dpr=([\d\.]+)/);</span><br><span class="line"></span><br><span class="line">                  if (initialDpr) &#123;</span><br><span class="line">                      dpr = parseFloat(initialDpr[1]);</span><br><span class="line">                      scale = parseFloat((1 / dpr).toFixed(2));</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">                  if (maximumDpr) &#123;</span><br><span class="line">                      dpr = parseFloat(maximumDpr[1]);</span><br><span class="line">                      scale = parseFloat((1 / dpr).toFixed(2));</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          if (!dpr &amp;&amp; !scale) &#123;</span><br><span class="line">              var isAndroid = win.navigator.appVersion.match(/android/gi);</span><br><span class="line">              var isIPhone = win.navigator.appVersion.match(/iphone/gi);</span><br><span class="line">              var devicePixelRatio = win.devicePixelRatio;</span><br><span class="line"></span><br><span class="line">              if (isIPhone) &#123;</span><br><span class="line">                  // iOSä¸‹ï¼Œå¯¹äº2å’Œ3çš„å±ï¼Œç”¨2å€çš„æ–¹æ¡ˆï¼Œå…¶ä½™çš„ç”¨1å€æ–¹æ¡ˆ</span><br><span class="line">                  if (devicePixelRatio &gt;= 3 &amp;&amp; (!dpr || dpr &gt;= 3)) &#123;</span><br><span class="line">                      dpr = 3;</span><br><span class="line">                  &#125; else if (devicePixelRatio &gt;= 2 &amp;&amp; (!dpr || dpr &gt;= 2)) &#123;</span><br><span class="line">                      dpr = 2;</span><br><span class="line">                  &#125; else &#123;</span><br><span class="line">                      dpr = 1;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; else &#123;</span><br><span class="line">                  // å…¶ä»–è®¾å¤‡ä¸‹ï¼Œä»æ—§ä½¿ç”¨1å€çš„æ–¹æ¡ˆ</span><br><span class="line">                  dpr = 1;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              scale = 1 / dpr;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          docEl.setAttribute(&#x27;data-dpr&#x27;, dpr);</span><br><span class="line"></span><br><span class="line">          if (!metaEl) &#123;</span><br><span class="line">              metaEl = doc.createElement(&#x27;meta&#x27;);</span><br><span class="line">              metaEl.setAttribute(&#x27;name&#x27;, &#x27;viewport&#x27;);</span><br><span class="line">              metaEl.setAttribute(&#x27;content&#x27;, &#x27;initial-scale=&#x27; + scale + &#x27;, maximum-scale=&#x27; + scale + &#x27;, minimum-scale=&#x27; + scale + &#x27;, user-scalable=no&#x27;);</span><br><span class="line"></span><br><span class="line">              if (docEl.firstElementChild) &#123;</span><br><span class="line">                  docEl.firstElementChild.appendChild(metaEl);</span><br><span class="line">              &#125; else &#123;</span><br><span class="line">                  var wrap = doc.createElement(&#x27;div&#x27;);</span><br><span class="line">                  wrap.appendChild(metaEl);</span><br><span class="line">                  doc.write(wrap.innerHTML);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          function refreshRem() &#123;</span><br><span class="line">              var width = docEl.getBoundingClientRect().width;</span><br><span class="line"></span><br><span class="line">              if (width / dpr &gt; 540) &#123;</span><br><span class="line">                  width = 540 * dpr;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              var rem = width / 10;</span><br><span class="line">              docEl.style.fontSize = rem + &#x27;px&#x27;;</span><br><span class="line">              flexible.rem = win.rem = rem;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          win.addEventListener(&#x27;resize&#x27;, function () &#123;</span><br><span class="line">              clearTimeout(tid);</span><br><span class="line">              tid = setTimeout(refreshRem, 300);</span><br><span class="line">          &#125;, false);</span><br><span class="line">          win.addEventListener(&#x27;pageshow&#x27;, function (e) &#123;</span><br><span class="line">              if (e.persisted) &#123;</span><br><span class="line">                  clearTimeout(tid);</span><br><span class="line">                  tid = setTimeout(refreshRem, 300);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;, false);</span><br><span class="line"></span><br><span class="line">          if (doc.readyState === &#x27;complete&#x27;) &#123;</span><br><span class="line">              doc.body.style.fontSize = 12 * dpr + &#x27;px&#x27;;</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">              doc.addEventListener(&#x27;DOMContentLoaded&#x27;, function (e) &#123;</span><br><span class="line">                  doc.body.style.fontSize = 12 * dpr + &#x27;px&#x27;;</span><br><span class="line">              &#125;, false);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          refreshRem();</span><br><span class="line">          flexible.dpr = win.dpr = dpr;</span><br><span class="line">          flexible.refreshRem = refreshRem;</span><br><span class="line"></span><br><span class="line">          flexible.rem2px = function (d) &#123;</span><br><span class="line">              var val = parseFloat(d) * this.rem;</span><br><span class="line"></span><br><span class="line">              if (typeof d === &#x27;string&#x27; &amp;&amp; d.match(/rem$/)) &#123;</span><br><span class="line">                  val += &#x27;px&#x27;;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              return val;</span><br><span class="line">          &#125;;</span><br><span class="line"></span><br><span class="line">          flexible.px2rem = function (d) &#123;</span><br><span class="line">              var val = parseFloat(d) / this.rem;</span><br><span class="line"></span><br><span class="line">              if (typeof d === &#x27;string&#x27; &amp;&amp; d.match(/px$/)) &#123;</span><br><span class="line">                  val += &#x27;rem&#x27;;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              return val;</span><br><span class="line">          &#125;;</span><br><span class="line">      &#125;)(window, window[&#x27;lib&#x27;] || (window[&#x27;lib&#x27;] = &#123;&#125;));&lt;/script&gt;&lt;link href=&quot;./css/index.5c90e18c.css&quot; rel=&quot;stylesheet&quot;&gt;&lt;/head&gt;&lt;body&gt;&lt;div id=&quot;root-webpack&quot;&gt;&lt;/div&gt;&lt;script defer=&quot;defer&quot; src=&quot;./js/index_7b84cb4c006925aa2404.js&quot;&gt;&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>thread-loader</p>
</blockquote>
<p>  thread-loader çš„åŸç†æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: webpack æ¯ä¸€æ¬¡è§£æ loader æ¨¡å—æ—¶,thread-loader éƒ½ä¼šå°†å®ƒä»¥åŠå®ƒæ‰€ä¾èµ–çš„åŒ…åˆ†é…ç»™æ‰€å¯¹åº”çš„ worker çº¿ç¨‹.</p>
<blockquote>
<p>loader-runner</p>
</blockquote>
<p>  loader-runner çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: æ˜¯ç”¨äºæµ‹è¯•è‡ªå®šä¹‰çš„ loader è€Œå­˜åœ¨çš„,å¯ä»¥ä½¿ç”¨ <a href="mailto:&#x6c;&#x6f;&#x61;&#100;&#x65;&#x72;&#45;&#117;&#x74;&#105;&#108;&#x73;&#x40;&#x32;&#46;&#120;">&#x6c;&#x6f;&#x61;&#100;&#x65;&#x72;&#45;&#117;&#x74;&#105;&#108;&#x73;&#x40;&#x32;&#46;&#120;</a> ä¸­çš„ getOptions(this) è·å– loader &gt; options,ç”±äºä¸æ˜¯åœ¨çœŸå®çš„ webpack ç¯å¢ƒä¸‹,ä¸å¯ä½¿ç”¨ this.getOptions(è·å– loader -&gt; options),this.emitFile(ç”Ÿæˆæ–‡ä»¶) ç­‰ API,PS: getOptions(this) åœ¨ <a href="mailto:&#x6c;&#111;&#97;&#x64;&#x65;&#114;&#45;&#x75;&#x74;&#105;&#108;&#x73;&#64;&#51;&#x2e;&#120;">&#x6c;&#111;&#97;&#x64;&#x65;&#114;&#45;&#x75;&#x74;&#105;&#108;&#x73;&#64;&#51;&#x2e;&#120;</a> ä¸­å·²ç»è¢«å‰”é™¤,åœ¨è‡ªå®šä¹‰çš„ loader ä¸­ç›´æ¥ä½¿ç”¨ this.getOptions() å³å¯.</p>
<h4 id="devServer"><a href="#devServer" class="headerlink" title="devServer"></a>devServer</h4><blockquote>
<p>contentBase</p>
</blockquote>
<p>  ä¸ºä½•åœ¨ devServer è®¾ç½® contentBase å¤±æ•ˆ?</p>
<p>  è§£: contentBase æŒ‡çš„æ˜¯ devServer æœ¬åœ°ä»£ç†æœåŠ¡çš„ä½œç”¨ç›®å½•,ä¸€èˆ¬è®¾ç½®ä¸ºç»å¯¹è·¯å¾„,åœ¨ webpack 5.x ä¸­æ”¹ä¸º static,webpack 4.x åŠå…¶ä¹‹å‰ç‰ˆæœ¬ä¾ç„¶ç”Ÿæ•ˆ.</p>
<blockquote>
<p>historyApiFallback</p>
</blockquote>
<p>  devServer.historyApiFallback çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: devServer æœ¬åœ°ä»£ç†æœåŠ¡æŒ‡å®šé‡åˆ° 404 æˆ–è€… é”™è¯¯æ—¶é‡å®šå‘çš„é¡µé¢.</p>
<blockquote>
<p>allowedHosts</p>
</blockquote>
<p>  devServer.allowedHosts çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: devServer æœ¬åœ°ä»£ç†æœåŠ¡é¡µé¢è®¿é—®æ—¶ http è¯·æ±‚çš„ç™½åå•.</p>
<blockquote>
<p>https</p>
</blockquote>
<p>  devServer.https çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: devServer æœ¬åœ°ä»£ç†æœåŠ¡æ˜¯å¦å¼€å¯ https å®‰å…¨åè®®.</p>
<blockquote>
<p>compress</p>
</blockquote>
<p>  devServer.compress çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: devServer æœ¬åœ°ä»£ç†æœåŠ¡æ˜¯å¦å¼€å¯ Gzip å‹ç¼©.</p>
<blockquote>
<p>open</p>
</blockquote>
<p>  devServer.open çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: devServer æœ¬åœ°ä»£ç†æœåŠ¡é¦–æ¬¡æ„å»ºæ‰“åŒ…æ—¶,æ˜¯å¦è‡ªåŠ¨æ‰“å¼€è®¾å¤‡é»˜è®¤æµè§ˆå™¨å®è¡Œè®¿é—®.</p>
<blockquote>
<p>hot</p>
</blockquote>
<p>  çƒ­åŠ è½½çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆ?</p>
<p>  è§£: é¦–å…ˆè¦äº†è§£å‡ ä¸ªæ¦‚å¿µ: webpack compileã€bundle serverã€hmr server ä»¥åŠ hmr runtime.</p>
<ul>
<li>webpack compile: æ˜¯å°† js è½¬åŒ–æˆ bundleJs çš„ç¼–è¯‘å™¨,åŒæ—¶å¼€å¯ webpack â€“watch æ–‡ä»¶ç›‘å¬,å¹¶å†™å…¥å†…å­˜.</li>
<li>bundle server: æä¾›æ–‡ä»¶ç»™æµè§ˆå™¨å®è¡Œè®¿é—®.</li>
<li>hmr server: å°† Server ç«¯çƒ­åŠ è½½æ–‡ä»¶è¾“å‡ºç»™ Client ç«¯ hmr runtime.</li>
<li>hmr runtime: æ³¨å…¥è‡³æµè§ˆå™¨å†…å­˜ä¸­;æ¥å— hmr server è¾“å‡ºçš„çƒ­åŠ è½½æ–‡ä»¶å¹¶å®è¡Œæ›´æ–°.</li>
</ul>
<p>  å·¥ä½œåŸç†: é¦–æ¬¡ç¼–è¯‘,webpack compile å°† js ç¼–è¯‘ä¸º bundleJs,åŒæ—¶å¼€å¯ webpack â€“watch æ–‡ä»¶ç›‘å¬å¹¶å†™å…¥å†…å­˜,é€šè¿‡ bundler server æä¾›æ–‡ä»¶ç»™æµè§ˆå™¨å®è¡Œè®¿é—®,ä¸æ­¤å¹¶è¡Œçš„æ˜¯ hmr runtime æ³¨å…¥è‡³æµè§ˆå™¨å†…å­˜ä¸­;æ¥ç€æ–‡ä»¶ç›‘å¬è½®è¯¢å¯ç›‘å¬çš„ç¼–è¾‘æ–‡ä»¶æ˜¯å¦å‘ç”Ÿå˜åŒ–,å¦‚æœå‘ç”Ÿäº†å˜åŒ–,ä¸ä¼šç«‹å³å‘ŠçŸ¥ç›‘å¬è€…,å¼•èµ· webpack é‡æ–°æ„å»ºæ‰“åŒ…,è€Œæ˜¯ä¼šæ”¾å…¥è‡³ç¼“å­˜ä¸­,åœ¨ aggregateTimeout æ—¶é—´æ®µå†…é‡å¤æ­¤ç±»æ“ä½œ,ç­‰æ—¶é—´æ®µç»“æŸä¹‹å,å°†ç¼“å­˜ä¸­çš„æ–‡ä»¶åˆ—è¡¨ç»Ÿä¸€é‡æ–°æ„å»ºæ‰“åŒ…,ä¹‹åé€šè¿‡ hmr server å°†çƒ­åŠ è½½æ–‡ä»¶è¾“å‡ºç»™ hmr runtime,å…¶ä¸­çš„æ–‡ä»¶ä¼ è¾“åè®®ä¸º websocket,ä¼ è¾“æ•°æ®æ ¼å¼ä¸º JSON æ ¼å¼,hmr runtime æ¥æ”¶åˆ° hmr server çƒ­åŠ è½½æ–‡ä»¶å®è¡Œæ›´æ–°.</p>
<h4 id="plugins"><a href="#plugins" class="headerlink" title="plugins"></a>plugins</h4><blockquote>
<p>friendly-errors-webpack-plugin</p>
</blockquote>
<p>  ä¸ºä½• friendly-errors-webpack-plugin æ—¥å¿—ä¼˜åŒ–æ’ä»¶åœ¨ webpack 5.x ä¸­ä¸ç”Ÿæ•ˆ?</p>
<p>  è§£: friendly-errors-webpack-plugin æ—¥å¿—ä¼˜åŒ–æ’ä»¶ç›®å‰åœ¨ github ä¸Šå·²åœæ­¢ç»´æŠ¤,å…¶åªèƒ½ç”Ÿæ•ˆçš„ webpack ç‰ˆæœ¬ä¸º 4.x ä»¥åŠä¹‹å‰çš„ç‰ˆæœ¬,å¯¹äº webpack 5.x æ— æ³•ä¸‹è½½ä½¿ç”¨.</p>
<blockquote>
<p>clean-webpack-plugin</p>
</blockquote>
<p>  å¦‚ä½•é€‰æ‹©æ€§æ¸…ç©ºæ„å»ºæ‰“åŒ…å¯¼å‡ºçš„ä½ç½®ç›®å½•å†…å®¹?</p>
<p>  è§£: clean-webpack-plugin å­˜åœ¨ä¸€ä¸ªå‚æ•°å±æ€§ â€”â€” cleanOnceBeforeBuildPatterns.</p>
<ul>
<li>cleanOnceBeforeBuildPatterns: ç”¨äºç­›é€‰åœ¨ Webpack Compile ç¼–è¯‘å‰å®è¡Œæ¸…ç©ºçš„ä½ç½®ç›®å½•å†…å®¹.</li>
</ul>
<p>  ç”¨æ­¤å±æ€§å°±å¯é€‰æ‹©æ€§æ¸…ç©ºæ„å»ºæ‰“åŒ…å¯¼å‡ºçš„ä½ç½®ç›®å½•å†…å®¹.</p>
<h4 id="commit-rules"><a href="#commit-rules" class="headerlink" title="commit rules"></a>commit rules</h4><blockquote>
<p>è§„èŒƒè¯´æ˜</p>
</blockquote>
<p>  ç°é˜¶æ®µå¤§å¤šæ•°å‰ç«¯å¼€å‘è€…éµä»çš„ git commit message è§„èŒƒéƒ½æ˜¯ Angular å›¢é˜Ÿçš„ Angular commit message.</p>
  <figure class="highlight text"><table><tr><td class="code"><pre><span class="line">&lt;type&gt;(&lt;scope&gt;): &lt;subject&gt;  &lt;!-- è¿™ä¸€è¡Œä¸º header --&gt;</span><br><span class="line">&lt;breakLine&gt;</span><br><span class="line">&lt;body&gt;    </span><br><span class="line">&lt;breakLine&gt;</span><br><span class="line">&lt;footer&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>header: åˆ†ä¸ºä¸‰éƒ¨åˆ†,typeã€scope ä»¥åŠ subject.<ul>
<li>type: è¡¨ç¤ºæäº¤ç±»å‹.å¿…å¡«ä¸”å¿…é¡»ä¸ºä»¥ä¸‹æšä¸¾ä¹‹ä¸€: [â€˜buildâ€™, â€˜choreâ€™, â€˜featâ€™, â€˜fixâ€™, â€˜styleâ€™, â€˜perfâ€™, â€˜docsâ€™, â€˜ciâ€™, â€˜testâ€™, â€˜refactorâ€™].</li>
<li>scope: è¡¨ç¤ºé¡¹ç›®å†…æ–‡ä»¶ä¿®æ”¹çš„èŒƒå›´,æ¯”å¦‚è¯´ fix ä¿®å¤ bug æ—¶,é€‰æ‹© hooks éƒ¨åˆ†è¿˜æ˜¯ component éƒ¨åˆ†,é€‰å¡«.</li>
<li>subject: è¡¨ç¤ºç®€è¦æè¿°æœ¬æ¬¡æäº¤.å¿…é¡»éµå¾ªä¸¤ä¸ªè§„åˆ™: é¦–å­—æ¯ä¸èƒ½å¤§å†™,æœ«å°¾ä¸èƒ½æ·»åŠ  â€˜.â€™ å­—ç¬¦,å¿…å¡«.</li>
</ul>
</li>
<li>body: è¡¨ç¤ºå¯¹æœ¬æ¬¡æäº¤çš„è¯¦ç»†æè¿°,é€‰å¡«.</li>
<li>footer: åˆ†ä¸ºä¸¤ç§æƒ…å†µ,BREAKING CHANGES ä»¥åŠ åˆ é™¤ issue,é€‰å¡«.<ul>
<li>BREAKING CHANGES: ä¸å½“å‰ API äº§ç”Ÿäº†è¾ƒå¤§çš„ä¸å…¼å®¹æ—¶,å¦‚é‡æ„,ä¼šè¯¦ç»†æè¿°æœ¬æ¬¡æäº¤çš„ BREAKING CHANGES,å¿…é¡»ä»¥ BREAKING CHANGES å¼€å¤´.</li>
<li>delete issue: å½“éœ€è¦åˆ é™¤æœ¬æ¬¡ commit æ‰€å¯¹åº”çš„ issue æ—¶,ä¹Ÿå¯è¯¦ç»†æè¿°.</li>
</ul>
</li>
</ul>
<blockquote>
<p>type enum</p>
</blockquote>
<ul>
<li>Angular commit message type.<ul>
<li>build: åˆå§‹åŒ–æ‰“åŒ….</li>
<li>chore: æ„å»º/ä¾èµ–/å·¥å…·.</li>
<li>feat: æ–°åŠŸèƒ½.</li>
<li>fix: ä¿®å¤ Bug.</li>
<li>style: ä»£ç æ ·å¼ç¾åŒ–.</li>
<li>perf: æ€§èƒ½ä¼˜åŒ–.</li>
<li>docs: æ–‡æ¡£å˜æ›´.</li>
<li>test: æµ‹è¯•.</li>
<li>ci: CI related changes.</li>
<li>refactor: é‡æ„.</li>
</ul>
</li>
<li>gitmoji commit message type.<ul>
<li>éµä»ä¸”ç»§æ‰¿ Angular commit message type.</li>
<li>revert: å›æ»š.</li>
<li>wip: å»ºè®¾è¿›ç¨‹ä¸­(ä¸æ¨èä½¿ç”¨).</li>
</ul>
</li>
</ul>
<blockquote>
<p>è§„èŒƒåŒ–å·¥å…·</p>
</blockquote>
<p>  é€šå¸¸ä½¿ç”¨ commitizen + cz-customizable æ¥å®ç° gitmoji commit message è§„èŒƒåŒ–.</p>
  <figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;commitizen&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">&quot;paths&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node_modules/cz-customizable&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//.cz-config.js</span></span><br><span class="line"><span class="keyword">const</span> czConfig = &#123;</span><br><span class="line">    <span class="attr">types</span>: [&#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;ğŸ» build: åˆå§‹åŒ–æ‰“åŒ…&#x27;</span>,</span><br><span class="line">        <span class="attr">value</span>: <span class="string">&#x27;:beers: build&#x27;</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;ğŸ“¦ï¸chore: æ„å»º/ä¾èµ–/å·¥å…·&#x27;</span>,</span><br><span class="line">        <span class="attr">value</span>: <span class="string">&#x27;:package: chore&#x27;</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;âœ¨  feat: æ–°åŠŸèƒ½&#x27;</span>,</span><br><span class="line">        <span class="attr">value</span>: <span class="string">&#x27;:sparkles: feat&#x27;</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;ğŸ› fix: ä¿®å¤bug&#x27;</span>,</span><br><span class="line">        <span class="attr">value</span>: <span class="string">&#x27;:bug: fix&#x27;</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;ğŸ¨ style: ä»£ç æ ·å¼ä¼˜åŒ–&#x27;</span>,</span><br><span class="line">        <span class="attr">value</span>: <span class="string">&#x27;:art: style&#x27;</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;ğŸ“„ docs: å˜æ›´æ–‡æ¡£&#x27;</span>,</span><br><span class="line">        <span class="attr">value</span>: <span class="string">&#x27;:page_facing_up: docs&#x27;</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;ğŸš€ perf: æ€§èƒ½ä¼˜åŒ–&#x27;</span>,</span><br><span class="line">        <span class="attr">value</span>: <span class="string">&#x27;:rocket: perf&#x27;</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;âœ…  test: æµ‹è¯•&#x27;</span>,</span><br><span class="line">        <span class="attr">value</span>: <span class="string">&#x27;:white_check_mark: test&#x27;</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;ğŸ”¥ refactor: é‡æ„&#x27;</span>,</span><br><span class="line">        <span class="attr">value</span>: <span class="string">&#x27;:fire: refactor&#x27;</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;ğŸ‘· ci: CI related changes&#x27;</span>,</span><br><span class="line">        <span class="attr">value</span>: <span class="string">&#x27;:construction_worker: ci&#x27;</span></span><br><span class="line">    &#125;],</span><br><span class="line">    <span class="attr">messages</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;è¯·è¾“å…¥æ‚¨æœ¬æ¬¡æäº¤ç±»å‹(å¿…å¡«):&#x27;</span>,</span><br><span class="line">        <span class="attr">scope</span>: <span class="string">&#x27;è¯·è¾“å…¥æ‚¨æœ¬æ¬¡æäº¤ä¿®æ”¹èŒƒå›´:&#x27;</span>,</span><br><span class="line">        <span class="attr">customScope</span>: <span class="string">&#x27;è¯·é€‰æ‹©æ‚¨æœ¬æ¬¡æäº¤ä¿®æ”¹èŒƒå›´:&#x27;</span>,</span><br><span class="line">        <span class="attr">subject</span>: <span class="string">&#x27;è¯·ç®€è¦æè¿°æœ¬æ¬¡æäº¤(å¿…å¡«):&#x27;</span>,</span><br><span class="line">        <span class="attr">body</span>: <span class="string">&#x27;è¯·å¯¹æœ¬æ¬¡æäº¤ä½œè¯¦ç»†æè¿°:&#x27;</span>,</span><br><span class="line">        <span class="attr">breaking</span>: <span class="string">&#x27;è¯·å¯¹æœ¬æ¬¡æäº¤ä¸å½“å‰ API äº§ç”Ÿæ¯”è¾ƒå¤§çš„ä¸å…¼å®¹ä½œè¯¦ç»†æè¿°:&#x27;</span>,</span><br><span class="line">        <span class="attr">footer</span>: <span class="string">&#x27;è¯·å¯¹æœ¬æ¬¡æäº¤åˆ é™¤çš„æ‰€å¯¹åº”çš„ issue ä½œè¯¦ç»†æè¿°:&#x27;</span>,</span><br><span class="line">        <span class="attr">confirmCommit</span>: <span class="string">&#x27;æ˜¯å¦ç¡®è®¤æäº¤ä»¥ä¸Šé€‰æ‹©è¾“å…¥?&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">scopes</span>: [&#123;<span class="attr">name</span>: <span class="string">&#x27;components       [ç»„ä»¶éƒ¨åˆ†]&#x27;</span>&#125;, &#123;<span class="attr">name</span>: <span class="string">&#x27;hooks            [hookséƒ¨åˆ†]&#x27;</span>&#125;, &#123;<span class="attr">name</span>: <span class="string">&#x27;logics           [ä»£ç é€»è¾‘éƒ¨åˆ†]&#x27;</span>&#125;],</span><br><span class="line">    <span class="attr">allowCustomScopes</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">allowEmptyScopes</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">customScopesName</span>: <span class="string">&#x27;custom           [è‡ªå®šä¹‰]&#x27;</span>,</span><br><span class="line">    <span class="attr">emptyScopesName</span>: <span class="string">&#x27;empty            [ä¸æŒ‡å®š]&#x27;</span>,</span><br><span class="line">    <span class="attr">allowBreakingChanges</span>: [<span class="string">&#x27;:sparkles: feat&#x27;</span>, <span class="string">&#x27;:bug: fix&#x27;</span>],</span><br><span class="line">    <span class="attr">subjectLimit</span>: <span class="number">80</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¼ºåˆ¶æ ¡éªŒ gitmoji commit message</p>
</blockquote>
<p>  é€šå¸¸ä½¿ç”¨ commitlint + husky + commitlint-config-gitmoji æ¥å¼ºåˆ¶æ ¡éªŒ git æäº¤æ—¶çš„ gitmoji commit message è§„èŒƒ.</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// .commitlintrc.js</span></span><br><span class="line"><span class="keyword">const</span> commitlintrcConfig = &#123;</span><br><span class="line">  <span class="attr">extends</span>: [<span class="string">&#x27;gitmoji&#x27;</span>],</span><br><span class="line">&#125;;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = commitlintrcConfig;</span><br></pre></td></tr></table></figure>

  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">husky</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”Ÿæˆå¼ºåˆ¶æ ¡éªŒ git æ“ä½œçš„ hooks å®¹å™¨.</span></span><br><span class="line">npx husky install</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ å¼ºåˆ¶æ ¡éªŒ gitmoji commit message è§„èŒƒçš„ hooks,å¹¶å†™å…¥é»˜è®¤å‘½ä»¤.</span></span><br><span class="line">npx husky add .husky/commet-msg &quot;yarn run test&quot;</span><br></pre></td></tr></table></figure>

  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">husky</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/env sh</span></span><br><span class="line">. &quot;$(dirname -- &quot;$0&quot;)/_/husky.sh&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">commitlint --edit æ˜¯å¯¹ git æœ€åä¸€æ¬¡æœ¬åœ°æäº¤è¿›è¡Œå¼ºåˆ¶æ ¡éªŒ,å¦‚è‹¥æ ¡éªŒä¸é€šè¿‡åˆ™å®è¡Œå›é€€,æœ¬åœ°æäº¤ä¸æˆåŠŸ.</span></span><br><span class="line">npx --no-install commitlint --edit &quot;$1&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¼ºåˆ¶ç”Ÿæˆ CHANGELOG</p>
</blockquote>
<p>  é€šå¸¸ä½¿ç”¨ husky + standard-version + conventional-changelog-gitmoji-config æ¥å¼ºåˆ¶ç”Ÿæˆ CHANGELOG.md æ–‡ä»¶.</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ å¼ºåˆ¶æ ¡éªŒ gitmoji commit message è§„èŒƒçš„ hooks,å¹¶å†™å…¥é»˜è®¤å‘½ä»¤.</span></span><br><span class="line">npx husky add .husky/pre-push &quot;yarn run test&quot;</span><br></pre></td></tr></table></figure>

  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">husky</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/env sh</span></span><br><span class="line">. &quot;$(dirname -- &quot;$0&quot;)/_/husky.sh&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”Ÿæˆ CHANGELOG.md æ–‡ä»¶çš„è§„åˆ™éµå¾ª conventional-changelog-gitmoji-config,ä¸å¯è¿›è¡Œè‡ªå®šä¹‰.</span></span><br><span class="line">npx --no-install standard-version --preset gitmoji-config</span><br></pre></td></tr></table></figure>

<h4 id="speed-optimization"><a href="#speed-optimization" class="headerlink" title="speed optimization"></a>speed optimization</h4><blockquote>
<p>best answer</p>
</blockquote>
<p>  å®éªŒè¯æ˜, webpack 5.x ä¸­ä½¿ç”¨ splitChunks åˆ†å‰²è‡ªå®šä¹‰å…¬ç”¨æ¨¡å—,ä½¿ç”¨ DllPlugin + DllReferencePlugin æŠ½å–å…¬ç”¨ä¾èµ–è‡³ manifest.json æ–‡ä»¶å†…åšé¢„ç¼–è¯‘æ–‡ä»¶,åªéœ€è¦æ„å»ºæ‰“åŒ…ä¸€æ¬¡,åç»­åˆ™ä¸éœ€è¦é‡æ–°æ‰§è¡Œ,å¯ç”±æ­¤çœ‹å‡ºæ˜¯é€Ÿåº¦ä¼˜åŒ–çš„æœ€ä½³ç­”æ¡ˆ.</p>
<blockquote>
<p>BREAKING CHANGES</p>
</blockquote>
<p>åœ¨ webpack 4.x ä¸­åšäº†ä¸€äº›é€Ÿåº¦ä¼˜åŒ–å‡çº§:</p>
<ul>
<li>nodejs å¿…é¡»ä¸‹è½½ v8.5.0 ä»¥ä¸Šçš„ç¨³å®šç‰ˆæœ¬æ‰å¯ä½¿ç”¨,è€Œæ–°ç‰ˆæœ¬çš„ V8 å¸¦æ¥äº†ä¸€äº›è¯­æ³•ä¼˜åŒ–.<ul>
<li>for-of æ›¿ä»£ forEach.</li>
<li>Mapã€Set æ›¿ä»£ Object.</li>
<li>includes æ›¿ä»£ indexOf.</li>
</ul>
</li>
<li>ä½¿ç”¨æ›´å¿«çš„ md4 hash åŠ å¯†ç®—æ³•.</li>
<li>webpack AST å¯ä»¥ç›´æ¥é€šè¿‡ loader ä¼ é€’ç»™ AST,å‡å°‘è§£ææ—¶é—´.</li>
<li>ä½¿ç”¨å­—ç¬¦ä¸²æ–¹æ³•æ›¿ä»£æ­£åˆ™è¡¨è¾¾å¼.</li>
</ul>
]]></content>
      <categories>
        <category>webpack</category>
      </categories>
      <tags>
        <tag>webpack</tag>
      </tags>
  </entry>
  <entry>
    <title>unresolved problems</title>
    <url>/2022/09/20/unresolved-problems/</url>
    <content><![CDATA[<h1 id="webpack"><a href="#webpack" class="headerlink" title="webpack"></a>webpack</h1><h4 id="speed-measure-webpack-plugin"><a href="#speed-measure-webpack-plugin" class="headerlink" title="speed-measure-webpack-plugin"></a>speed-measure-webpack-plugin</h4><p>  ä¸ºä½• speed-measure-webpack-plugin é€Ÿåº¦åˆ†ææ’ä»¶å¯¹äº webpack 5.x çš„æ”¯æŒå¾ˆæœ‰é™åˆ¶,å¦‚ä½•å®Œç¾çš„è§£å†³è¿™äº›é™åˆ¶?</p>
<p>ç°é˜¶æ®µå¹¶æ²¡æœ‰å‘ç°è§£å†³çš„æœ€å®Œç¾çš„æ–¹å¼, speed-measure-webpack-plugin é€Ÿåº¦åˆ†ææ’ä»¶å¯¹äº webpack 5.x ä¼šå‡ºç°ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜:</p>
<p><img src="https://image.white-than-wood.zone/webpack/speed-measure-webpack-plugin-problem.png"></p>
<p>ä½¿ç”¨ .wrap åŒ…è£¹å,ä¼šç›´æ¥æŠ¥ TypeError ç±»å‹é”™è¯¯,ç»è¿‡æŸ¥è¯¢å¯çŸ¥,å®˜æ–¹ç»™å‡ºçš„è§£å†³æ–¹æ¡ˆæ˜¯,å°† optimization.minimizer çš„é»˜è®¤å€¼å»æ‰,ä¹Ÿå°±æ˜¯ â€˜â€¦â€™.<br>é‚£å°±æœ‰ç–‘é—®äº†,å¦‚æœä¸åˆå¹¶ minimizer é»˜è®¤å€¼,å¯¹äºprod ç”Ÿäº§ç¯å¢ƒçš„æ‰“åŒ…é€Ÿåº¦åˆ†ææ—¶,æˆ‘è¿˜éœ€è¦é¢å¤–ä¸‹è½½ terser-webpack-webpack å¯¹æ„å»ºæ‰“åŒ…æ–‡ä»¶å®è¡Œå‹ç¼©æ··æ·†,è¿˜éœ€è¦é¢å¤–å¼•å…¥ new webpack.optimize.ModuleConcatenationPlugin æ¥å¼€å¯ Scope Hoisting å—?è¿˜æ˜¯è¯´è¦æ”¾å¼ƒ css-minimizer-webpack-plugin å‹ç¼© css æ–‡ä»¶,ä½¿ç”¨å…¶ä»–çš„æ¯”è¾ƒéº»çƒ¦çš„æ–¹æ¡ˆå‘¢?è¿™äº›æ–¹å¼å‹‰å¼ºå¯ä»¥å¤„ç†,ä½†æ˜¯éƒ½å¤ªå¾—ä¸å¿å¤±.<br>å‚è€ƒé“¾æ¥: <a href='https://github.com/stephencookdev/speed-measure-webpack-plugin/issues/171'>Not working with Webpack 5: â€œTypeError: Cannot create proxy with a non-object as target or handlerâ€</a>.</p>
<p><img src="https://image.white-than-wood.zone/webpack/speed-measure-webpack-plugin-problem-ano.png"></p>
<p>å³ä½¿æŒ‰ç…§å®˜æ–¹çš„è§£å†³æ–¹æ¡ˆ,å»æ‰ optimization.minimizer çš„é»˜è®¤å€¼ â€˜â€¦â€™,ä¹Ÿä¼šæŠ¥ â€œYou forgot to add â€˜mini-css-extract-pluginâ€™ pluginâ€ è¿™ä¸ªé—®é¢˜,é’ˆå¯¹äºæ­¤å®˜æ–¹çš„è§£å†³æ–¹æ¡ˆæ˜¯,å…ˆè¯•ç”¨ speed-measure-webpack-plugin é€Ÿåº¦åˆ†æ,è€Œåå†å°† mini-css-extract-plugin æŠ½å– css æ–‡ä»¶æ’ä»¶æ·»åŠ åˆ° webpack plugins ä¸­.æ„Ÿè§‰è¿˜æ˜¯å¥½æ„šè ¢çš„åšæ³•,å¾ˆä¸ä¼˜é›…è€Œä¸”å¤šä½™.<br>å‚è€ƒé“¾æ¥: <a href='https://github.com/stephencookdev/speed-measure-webpack-plugin/issues/167#issuecomment-976836861'>â€œYou forgot to add â€˜mini-css-extract-pluginâ€™ pluginâ€</a>.</p>
]]></content>
      <categories>
        <category>unresolved</category>
      </categories>
      <tags>
        <tag>unresolved</tag>
      </tags>
  </entry>
  <entry>
    <title>create Simplepack</title>
    <url>/2022/10/14/create-simplepack/</url>
    <content><![CDATA[<h1 id="create-Simplepack"><a href="#create-Simplepack" class="headerlink" title="create Simplepack"></a>create Simplepack</h1><p>æ­å»ºä¸€ä¸ªç®€æ˜“çš„ webpack â€”â€” Simplepack.</p>
<blockquote>
<p>é…ç½®æ–‡ä»¶</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// simplepack.config.js</span></span><br><span class="line"><span class="keyword">const</span> &#123;resolve&#125; = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">OUTPUT_DIR</span> = <span class="title function_">resolve</span>(process.<span class="title function_">cwd</span>(), <span class="string">&#x27;./build&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> simplepackConfig = &#123;</span><br><span class="line">    <span class="comment">// å…¥å£</span></span><br><span class="line">    <span class="attr">entry</span>: <span class="string">&#x27;./src/index.js&#x27;</span>,</span><br><span class="line">    <span class="comment">// ä½œä¸º simplepack æ„å»ºæ‰“åŒ…çš„å‡ºå£</span></span><br><span class="line">    <span class="attr">output</span>: &#123;</span><br><span class="line">        <span class="comment">// ä½œä¸º simplepack æ„å»ºæ‰“åŒ…æ–‡ä»¶å¯¼å‡ºçš„ä½ç½®ç›®å½•</span></span><br><span class="line">        <span class="attr">path</span>: <span class="variable constant_">OUTPUT_DIR</span>,</span><br><span class="line">        <span class="comment">// ä½œä¸º simplepack æ„å»ºæ‰“åŒ…å¯¼å‡ºæ–‡ä»¶çš„åç§°</span></span><br><span class="line">        <span class="attr">filename</span>: <span class="string">&#x27;main.js&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = simplepackConfig;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ç›®å½•</p>
</blockquote>
<p><img src="https://image.white-than-wood.zone/webpack/simplepack_path.png"></p>
<blockquote>
<p>Simplepack</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;resolve&#125; = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;writeFileSync&#125; = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>); </span><br><span class="line">    </span><br><span class="line"><span class="keyword">const</span> utils = <span class="built_in">require</span>(<span class="string">&#x27;../utils&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Simplepack</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">options</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">options</span> = options;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">resources</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿è¡Œ</span></span><br><span class="line">    <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;entry = <span class="string">&#x27;&#x27;</span>&#125; = <span class="variable language_">this</span>.<span class="property">options</span>;</span><br><span class="line">        <span class="keyword">if</span> (entry) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;æ‰¾ä¸åˆ° webpack æ„å»ºæ‰“åŒ…çš„å…¥å£!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é€’å½’è·å–èµ„æºåˆ—è¡¨</span></span><br><span class="line">        (<span class="keyword">function</span> <span class="title function_">getResources</span>(<span class="params">path, sourcePath</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> compile = <span class="variable language_">this</span>.<span class="title function_">compile</span>(path);</span><br><span class="line">            compile.<span class="property">filename</span> = sourcePath ? sourcePath : path;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">resources</span>.<span class="title function_">push</span>(compile);</span><br><span class="line">            <span class="keyword">const</span> &#123;dependencies = []&#125; = compile;</span><br><span class="line">            <span class="keyword">if</span> (dependencies.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// è·¯å¾„ä¸­æ˜¯å¦å­˜åœ¨ç±»å‹æ–‡ä»¶</span></span><br><span class="line">                <span class="keyword">const</span> hasFile = <span class="regexp">/\.js$/</span>;</span><br><span class="line">                dependencies.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> sourcePath = item;</span><br><span class="line">                    <span class="comment">// æ‹¼æ¥çˆ¶å­ä¾èµ–ç›®å½•</span></span><br><span class="line">                    <span class="keyword">if</span> (hasFile.<span class="title function_">test</span>(path)) &#123;</span><br><span class="line">                        path = path.<span class="title function_">slice</span>(<span class="number">0</span>, path.<span class="title function_">lastIndexOf</span>(<span class="string">&#x27;/&#x27;</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!hasFile.<span class="title function_">test</span>(item)) &#123;</span><br><span class="line">                        item += <span class="string">&#x27;/index.js&#x27;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    path = <span class="title function_">resolve</span>(path, item);</span><br><span class="line">                    <span class="comment">// å°†æ‹¼æ¥å¥½çš„å­ä¾èµ–ç›®å½•å†æ¬¡è§£æ</span></span><br><span class="line">                    getResources.<span class="title function_">call</span>(<span class="variable language_">this</span>, path, sourcePath);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.<span class="title function_">bind</span>(<span class="variable language_">this</span>))(entry);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">emitFile</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æ</span></span><br><span class="line">    <span class="title function_">compile</span>(<span class="params">path</span>) &#123;</span><br><span class="line">        <span class="comment">// å¯¹ç›¸å¯¹è·¯å¾„è¿›è¡Œæ ¡éªŒ,å°†ç›¸å¯¹è·¯å¾„è½¬åŒ–ä¸ºç»å¯¹è·¯å¾„</span></span><br><span class="line">        <span class="keyword">const</span> isRelative = <span class="regexp">/\.\/|\.\\/</span>;</span><br><span class="line">        <span class="keyword">if</span> (isRelative.<span class="title function_">test</span>(path)) &#123;</span><br><span class="line">            path = <span class="title function_">resolve</span>(process.<span class="title function_">cwd</span>(), path);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è·å–å…¥å£æˆ–è€…ä¾èµ–æ¨¡å—çš„ AST æŠ½è±¡è¯­æ³•æ ‘</span></span><br><span class="line">        <span class="keyword">const</span> ast = utils.<span class="title function_">getAST</span>(path);</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="comment">// è·å–ç›¸å…³ä¾èµ–åˆ—è¡¨</span></span><br><span class="line">            <span class="attr">dependencies</span>: utils.<span class="title function_">getDependencies</span>(ast),</span><br><span class="line">            <span class="comment">// è·å–ç›¸å…³ä»£ç </span></span><br><span class="line">            <span class="attr">source</span>: utils.<span class="title function_">getTransformFromAST</span>(ast)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”Ÿæˆæ–‡ä»¶</span></span><br><span class="line">    <span class="title function_">emitFile</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;entry = <span class="string">&#x27;&#x27;</span>, <span class="attr">output</span>: &#123;filename = <span class="string">&#x27;&#x27;</span>, path = <span class="string">&#x27;&#x27;</span>&#125;&#125; = <span class="variable language_">this</span>.<span class="property">options</span>;</span><br><span class="line">        <span class="keyword">const</span> outputPath = <span class="title function_">resolve</span>(path, filename);</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿ webpack IIFE è‡ªæ‰§è¡Œå‡½æ•°è¡¨è¾¾å¼é—­åŒ…,å°†æ¯ä¸€ä¸ªæ¨¡å—å¤–åŠ ä¸€å±‚åŒ…è£¹,å¹¶å°† import è½¬åŒ–ä¸º __WEBPACK_REQUIRE__</span></span><br><span class="line">        <span class="keyword">const</span> <span class="variable language_">module</span> = <span class="variable language_">this</span>.<span class="property">resources</span>.<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> <span class="string">`&#x27;<span class="subst">$&#123;item.filename&#125;</span>&#x27;: function(require, modules, exports) &#123;<span class="subst">$&#123;item.source&#125;</span>`</span>).<span class="title function_">join</span>(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">        <span class="keyword">const</span> bundle = <span class="string">`(function (module) &#123;</span></span><br><span class="line"><span class="string">            function require(filename) &#123;</span></span><br><span class="line"><span class="string">                var fn = module[filename];</span></span><br><span class="line"><span class="string">                var modules = &#123;exports: &#123;&#125;&#125;;</span></span><br><span class="line"><span class="string">                fn(require, modules, modules.exports);</span></span><br><span class="line"><span class="string">                return modules.exports;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            require(&#x27;<span class="subst">$&#123;entry&#125;</span>&#x27;);</span></span><br><span class="line"><span class="string">        &#125;)(&#123;<span class="subst">$&#123;<span class="variable language_">module</span>&#125;</span>&#125;)`</span>;</span><br><span class="line">        <span class="title function_">writeFileSync</span>(outputPath, bundle);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Simplepack Parse è§£æå·¥å…·</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;readFileSync&#125; = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;parse&#125; = <span class="built_in">require</span>(<span class="string">&#x27;babylon&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;traverse, transformFromAST&#125; = <span class="built_in">require</span>(<span class="string">&#x27;@babel/core&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> utils = &#123;</span><br><span class="line">    <span class="comment">// é€šè¿‡ babylon è§£æå…¥å£æˆ–è€…ä¾èµ–æ¨¡å—çš„æŠ½è±¡è¯­æ³•æ ‘</span></span><br><span class="line">    <span class="title function_">getAST</span>(<span class="params">path</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> content = <span class="title function_">readFileSync</span>(path, <span class="string">&#x27;utf-8&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">parse</span>(content, &#123;</span><br><span class="line">            <span class="attr">sourceType</span>: <span class="string">&#x27;module&#x27;</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// é€šè¿‡ traverse éå†è·å– import å¯¼å…¥çš„ä¾èµ–æ¨¡å—</span></span><br><span class="line">    <span class="title function_">getDependencies</span>(<span class="params">ast</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> dependencies = [];</span><br><span class="line">        <span class="title function_">traverse</span>(ast, &#123;</span><br><span class="line">            <span class="title class_">ImportDeclaration</span>(&#123;node&#125;) &#123;</span><br><span class="line">                dependencies.<span class="title function_">push</span>(node.<span class="property">source</span>.<span class="property">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> dependencies;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// é€šè¿‡ transformFromAST è·å–è¢« babel å¤„ç†åçš„ä»£ç </span></span><br><span class="line">    <span class="title function_">getTransformFromAST</span>(<span class="params">ast</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;code&#125; = <span class="title function_">transformFromAST</span>(ast, <span class="literal">null</span>, &#123;</span><br><span class="line">            <span class="attr">presets</span>: [<span class="string">&#x27;@babel/preset-env&#x27;</span>]</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = utils;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Result</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">function</span>(<span class="params"><span class="variable language_">module</span></span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">require</span>(<span class="params">filename</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> fn = <span class="variable language_">module</span>[filename];</span><br><span class="line">        <span class="keyword">var</span> modules = &#123;<span class="attr">exports</span>: &#123;&#125;&#125;;</span><br><span class="line">        <span class="title function_">fn</span>(<span class="built_in">require</span>, modules, <span class="built_in">exports</span>);</span><br><span class="line">        <span class="keyword">return</span> modules.<span class="property">exports</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">&#x27;./src/index.js&#x27;</span>);</span><br><span class="line">&#125;)(&#123;</span><br><span class="line">    <span class="string">&#x27;./src/index.js&#x27;</span>: <span class="keyword">function</span> (<span class="params"><span class="built_in">require</span>, modules, <span class="built_in">exports</span></span>) &#123;<span class="string">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> _modules = <span class="built_in">require</span>(<span class="string">&quot;./modules&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> wtw = (<span class="number">0</span>, _modules.<span class="property">getName</span>)(<span class="string">&#x27;wtw&#x27;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;wtw&#x27;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(wtw);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;./modules&#x27;</span>: <span class="keyword">function</span> (<span class="params"><span class="built_in">require</span>, modules, <span class="built_in">exports</span></span>) &#123;<span class="string">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="built_in">exports</span>, <span class="string">&quot;__esModule&quot;</span>, &#123;</span><br><span class="line">            <span class="attr">value</span>: <span class="literal">true</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="built_in">exports</span>.<span class="property">getName</span> = getName;</span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">getName</span>(<span class="params">name</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;My name is &quot;</span>.<span class="title function_">concat</span>(name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>webpack</category>
      </categories>
      <tags>
        <tag>webpack</tag>
      </tags>
  </entry>
  <entry>
    <title>think of tapable</title>
    <url>/2022/10/15/think-of-tapable/</url>
    <content><![CDATA[<h1 id="Tapable"><a href="#Tapable" class="headerlink" title="Tapable"></a>Tapable</h1><blockquote>
<p>ä»€ä¹ˆæ˜¯ Tapable</p>
</blockquote>
<p>  ç®€å•æ¥è¯´,ç±»ä¼¼äº EventEmitter çš„ä¸€ç§å‘å¸ƒè®¢é˜…æ¨¡å¼,ä¹Ÿå°±æ˜¯è§‚å¯Ÿè€…æ¨¡å¼,ä½†ä¸åŒçš„æ˜¯,Tapable çš„æµç¨‹ä»¥åŠåº”ç”¨åœºæ™¯è¦å¹¿æ³›å¤æ‚çš„å¤š.Tapable ä½œä¸º Webpack çš„ä¸»è¦éª¨æ¶è€Œæµè¡Œ,å› æ­¤ä¹Ÿå—åˆ°å‰ç«¯å¼€å‘çˆ±å¥½è€…çš„ç ”ç©¶.</p>
<blockquote>
<p>è®¢é˜…æ¨¡å¼ç±»å‹ â€”â€” Hook</p>
</blockquote>
<p>  åœ¨ Tapable ä¸­è®¢é˜…æ¨¡å¼ç±»å‹è¢«ç§°ä¸º Hook,ä¹Ÿå°±æ˜¯ â€œé’©å­â€,åŸºæœ¬åˆ†ä¸ºå››ç§.</p>
<ul>
<li>æ™®é€šé’©å­</li>
<li>ç†”æ–­é’©å­</li>
<li>ç€‘å¸ƒé’©å­</li>
<li>å¾ªç¯é’©å­</li>
</ul>
<p>  åœ¨æ­¤åˆ†ç±»åŸºç¡€ä¸Š,å†æ·»åŠ å‘å¸ƒæ—¶åŒæ­¥(Sync)ã€å¼‚æ­¥(Async)ä»¥åŠ Promise çš„åŒºåˆ†.</p>
<blockquote>
<p>æ•´ä½“æºç åˆ†æ</p>
</blockquote>
<p>  å…ˆæŒ‰ç…§æ•´ä½“æµç¨‹å¤§ä½“çœ‹ä¸€éæºç ,å†å…·ä½“åˆ†æå„ä¸ªåˆ†ç±»,å°±å…ˆæ‹¿æœ€ç®€å• SyncHook åŒæ­¥æ™®é€šé’©å­ä¸¾ä¾‹.</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    MIT License http://www.opensource.org/licenses/mit-license.php</span></span><br><span class="line"><span class="comment">    Author Tobias Koppers @sokra</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Hook</span> = <span class="built_in">require</span>(<span class="string">&quot;./Hook&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">HookCodeFactory</span> = <span class="built_in">require</span>(<span class="string">&quot;./HookCodeFactory&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†…å®¹åˆ™æ˜¯ç”± HookCodeFactory ç”Ÿæˆ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SyncHookCodeFactory</span> <span class="keyword">extends</span> <span class="title class_ inherited__">HookCodeFactory</span> &#123;</span><br><span class="line">    <span class="title function_">content</span>(<span class="params">&#123; onError, onDone, rethrowIfPossible &#125;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">callTapsSeries</span>(&#123;</span><br><span class="line">            <span class="attr">onError</span>: <span class="function">(<span class="params">i, err</span>) =&gt;</span> <span class="title function_">onError</span>(err),</span><br><span class="line">            onDone,</span><br><span class="line">            rethrowIfPossible</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> factory = <span class="keyword">new</span> <span class="title class_">SyncHookCodeFactory</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»§æ‰¿è‡ª Hook æºç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SyncHook</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Hook</span> &#123;</span><br><span class="line">    <span class="comment">// åŒæ­¥çš„è®¢é˜…æ¨¡å¼ç±»å‹ Hook ä¸èƒ½è°ƒç”¨ tapAsyncã€tapPromise å¼‚æ­¥è®¢é˜…æ–¹æ³•</span></span><br><span class="line">    <span class="title function_">tapAsync</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;tapAsync is not supported on a SyncHook&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">tapPromise</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;tapPromise is not supported on a SyncHook&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç¼–è¯‘æ–¹æ³•ç”Ÿæˆå¹¶å¯¼å‡ºæœ€ç»ˆçš„å‡½æ•°</span></span><br><span class="line">    <span class="title function_">compile</span>(<span class="params">options</span>) &#123;</span><br><span class="line">        factory.<span class="title function_">setup</span>(<span class="variable language_">this</span>, options);</span><br><span class="line">        <span class="keyword">return</span> factory.<span class="title function_">create</span>(options);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">SyncHook</span>;</span><br></pre></td></tr></table></figure>

<p>  å¯ä»¥çœ‹å‡ºæ¯ä¸€ç§è®¢é˜…æ¨¡å¼ç±»å‹ Hook æ˜¯ç»§æ‰¿è‡ª Hook æºç±»,è€Œå†…å®¹åˆ™æ˜¯ç”± HookCodeFactory ç”Ÿæˆçš„,ç‰¹å®šçš„è®¢é˜…æ¨¡å¼ç±»å‹ä¹Ÿä¼šåšå¯¹åº”çš„é™åˆ¶,å¦‚åŒæ­¥è®¢é˜…ç±»å‹çš„ Hook åªèƒ½è°ƒç”¨ tap åŒæ­¥è®¢é˜…æ–¹æ³•,å´ä¸èƒ½è°ƒç”¨å…¶ä»–å¼‚æ­¥è®¢é˜…æ–¹æ³•.ç»§ç»­çœ‹ Hook æºç±»,å¤‡æ³¨ä¼šè¯¦ç»†è¯´æ˜æ¯ä¸ªä¸»è¦çš„æ–¹æ³•åšçš„äº‹æƒ….</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    MIT License http://www.opensource.org/licenses/mit-license.php</span></span><br><span class="line"><span class="comment">    Author Tobias Koppers @sokra</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Hook</span> &#123;</span><br><span class="line">    <span class="comment">// æ„é€ å¯¹è±¡æ‹¥æœ‰çš„å±æ€§</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">args</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title class_">Array</span>.<span class="title function_">isArray</span>(args)) args = [];</span><br><span class="line">        <span class="comment">// æ„é€ æ—¶æŒ‡å®šçš„å‚æ•°åç§°å’Œä¸ªæ•°</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_args</span> = args;</span><br><span class="line">        <span class="comment">// è®¢é˜…çš„æ–¹æ³•é›†åˆ</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">taps</span> = [];</span><br><span class="line">        <span class="comment">// æ‹¦æˆªå™¨é›†åˆ</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">interceptors</span> = [];</span><br><span class="line">        <span class="comment">// ä¸åŒç±»å‹çš„å‘å¸ƒæ–¹æ³•æ‹¥æœ‰ä¸åŒå¤„ç†è®¢é˜…æ¨¡å¼çš„æ–¹å¼</span></span><br><span class="line">        <span class="comment">// call å¯¹åº” sync (åŒæ­¥)</span></span><br><span class="line">        <span class="comment">// promise å¯¹åº” promise å¤„ç†</span></span><br><span class="line">        <span class="comment">// callAsync å¯¹åº” async (å¼‚æ­¥)</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">call</span> = <span class="variable language_">this</span>.<span class="property">_call</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">promise</span> = <span class="variable language_">this</span>.<span class="property">_promise</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">callAsync</span> = <span class="variable language_">this</span>.<span class="property">_callAsync</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_x</span> = <span class="literal">undefined</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">compile</span>(<span class="params">options</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Abstract: should be overriden&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†æ ¹æ®å‘å¸ƒæ—¶çš„ç±»å‹ã€æ„é€ æ—¶æŒ‡å®šçš„å‚æ•°åç§°ã€æ‹¦æˆªå™¨ä»¥åŠè®¢é˜…çš„æ–¹æ³•é›†åˆç¼–è¯‘ç”Ÿæˆ</span></span><br><span class="line">    <span class="title function_">_createCall</span>(<span class="params">type</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">compile</span>(&#123;</span><br><span class="line">            <span class="attr">taps</span>: <span class="variable language_">this</span>.<span class="property">taps</span>,</span><br><span class="line">            <span class="attr">interceptors</span>: <span class="variable language_">this</span>.<span class="property">interceptors</span>,</span><br><span class="line">            <span class="attr">args</span>: <span class="variable language_">this</span>.<span class="property">_args</span>,</span><br><span class="line">            <span class="attr">type</span>: type</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒæ­¥è®¢é˜…æ¨¡å¼ç±»å‹å¤„ç†æ–¹æ³•</span></span><br><span class="line">    <span class="title function_">tap</span>(<span class="params">options, fn</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">&quot;string&quot;</span>) options = &#123; <span class="attr">name</span>: options &#125;;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        options = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123; <span class="attr">type</span>: <span class="string">&quot;sync&quot;</span>, <span class="attr">fn</span>: fn &#125;, options);</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_insert</span>(options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼‚æ­¥è®¢é˜…æ¨¡å¼ç±»å‹å¤„ç†æ–¹æ³•</span></span><br><span class="line">    <span class="title function_">tapAsync</span>(<span class="params">options, fn</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">&quot;string&quot;</span>) options = &#123; <span class="attr">name</span>: options &#125;;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        options = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123; <span class="attr">type</span>: <span class="string">&quot;async&quot;</span>, <span class="attr">fn</span>: fn &#125;, options);</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_insert</span>(options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// promise è®¢é˜…æ¨¡å¼ç±»å‹å¤„ç†æ–¹æ³•</span></span><br><span class="line">    <span class="title function_">tapPromise</span>(<span class="params">options, fn</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> options === <span class="string">&quot;string&quot;</span>) options = &#123; <span class="attr">name</span>: options &#125;;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        options = <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123; <span class="attr">type</span>: <span class="string">&quot;promise&quot;</span>, <span class="attr">fn</span>: fn &#125;, options);</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_insert</span>(options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸åŒç±»å‹çš„å‘å¸ƒæ–¹æ³•æ‹¥æœ‰ä¸åŒå¤„ç†è®¢é˜…æ¨¡å¼çš„æ–¹å¼</span></span><br><span class="line">    <span class="comment">// call å¯¹åº” sync (åŒæ­¥)</span></span><br><span class="line">    <span class="comment">// promise å¯¹åº” promise å¤„ç†</span></span><br><span class="line">    <span class="comment">// callAsync å¯¹åº” async (å¼‚æ­¥)</span></span><br><span class="line">    <span class="title function_">_resetCompilation</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">call</span> = <span class="variable language_">this</span>.<span class="property">_call</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">callAsync</span> = <span class="variable language_">this</span>.<span class="property">_callAsync</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">promise</span> = <span class="variable language_">this</span>.<span class="property">_promise</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€ç»ˆä¼šæŒ‰ç…§ &#123;type: string, name: string, fn: Function&#125; çš„æ–¹å¼æ·»åŠ è‡³è®¢é˜…æ–¹æ³•é›†åˆä¸­.</span></span><br><span class="line">    <span class="comment">//           type: å¿…å¡«,å¿…é¡»ä¸º &#x27;sync&#x27;ã€&#x27;async&#x27; å’Œ &#x27;promise&#x27; ä¸‰ç§æšä¸¾é€‰é¡¹ä¹‹ä¸€.</span></span><br><span class="line">    <span class="comment">//           name: å¿…å¡«,æ·»åŠ è®¢é˜…æ–¹æ³•æ—¶åšçš„ç®€è¦æè¿°.</span></span><br><span class="line">    <span class="comment">//           fn: å¿…å¡«,æ·»åŠ çš„è®¢é˜…æ–¹æ³•æœ¬èº«.</span></span><br><span class="line">    <span class="title function_">_insert</span>(<span class="params">item</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_resetCompilation</span>();</span><br><span class="line">        <span class="keyword">let</span> i = <span class="variable language_">this</span>.<span class="property">taps</span>.<span class="property">length</span>;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">taps</span>[i] = item;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›ä¸€ä¸ªå‡½æ•°,è€Œè¿™ä¸ªå‡½æ•°ä¹Ÿå°±æ˜¯å‘å¸ƒæ—¶è°ƒç”¨çš„ call(args1), callAsync(args1, callback), promise(args1)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createCompileDelegate</span>(<span class="params">name, type</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">lazyCompileHook</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>[name] = <span class="variable language_">this</span>.<span class="title function_">_createCall</span>(type);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>[name](...args);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hook æºç±»åŸå‹é“¾è‡ªå¸¦ _callã€_promiseã€_callAsync æ–¹æ³•.</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperties</span>(<span class="title class_">Hook</span>.<span class="property"><span class="keyword">prototype</span></span>, &#123;</span><br><span class="line">    <span class="attr">_call</span>: &#123;</span><br><span class="line">        <span class="attr">value</span>: <span class="title function_">createCompileDelegate</span>(<span class="string">&quot;call&quot;</span>, <span class="string">&quot;sync&quot;</span>),</span><br><span class="line">        <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">writable</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">_promise</span>: &#123;</span><br><span class="line">        <span class="attr">value</span>: <span class="title function_">createCompileDelegate</span>(<span class="string">&quot;promise&quot;</span>, <span class="string">&quot;promise&quot;</span>),</span><br><span class="line">        <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">writable</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">_callAsync</span>: &#123;</span><br><span class="line">        <span class="attr">value</span>: <span class="title function_">createCompileDelegate</span>(<span class="string">&quot;callAsync&quot;</span>, <span class="string">&quot;async&quot;</span>),</span><br><span class="line">        <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">writable</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">Hook</span>;</span><br></pre></td></tr></table></figure>

<p>  å¯ä»¥çœ‹å‡º Hook çš„æºç±»ç»è¿‡ä¸€ç•ªæ•´åˆå¤„ç†,å°†æ ¹æ®å‘å¸ƒæ—¶çš„ç±»å‹ã€æ„é€ æ—¶æŒ‡å®šçš„å‚æ•°åç§°ã€æ‹¦æˆªå™¨ä»¥åŠè®¢é˜…çš„æ–¹æ³•é›†åˆé€šè¿‡ç¼–è¯‘ç”Ÿæˆ,æœ€ç»ˆéƒ½æŒ‡å‘äº† compile æ–¹æ³•å†…çš„ HookCodeFactory æ„é€ å¯¹è±¡.é‚£ä¹ˆæœ€ç»ˆéœ€è¦å…‹æœçš„å°±æ˜¯ HookCodeFactory ç±»,å¤‡æ³¨ä¼šè¯¦ç»†è¯´æ˜æ¯ä¸ªä¸»è¦çš„æ–¹æ³•åšçš„äº‹æƒ….</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    MIT License http://www.opensource.org/licenses/mit-license.php</span></span><br><span class="line"><span class="comment">    Author Tobias Koppers @sokra</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HookCodeFactory</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">config</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">config</span> = config;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">options</span> = <span class="literal">undefined</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_args</span> = <span class="literal">undefined</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å,æ ¹æ®ä¸åŒçš„å‘å¸ƒæ—¶çš„ç±»å‹,è¿”å›å¡«å……ä¸åŒçš„å†…å®¹çš„åŒ¿åå‡½æ•°.</span></span><br><span class="line">    <span class="title function_">create</span>(<span class="params">options</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">init</span>(options);</span><br><span class="line">        <span class="keyword">let</span> fn;</span><br><span class="line">        <span class="keyword">switch</span> (<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">type</span>) &#123;</span><br><span class="line">            <span class="comment">// è¿™é‡Œåç»­ä¼šæ›´åŠ è¯¦å°½å¯¹æ¯”çš„åšè®²è§£</span></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å°†æ„é€ å¯¹è±¡å±æ€§é‡ç½®</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">deinit</span>();</span><br><span class="line">        <span class="keyword">return</span> fn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†å¤„ç†åè®¢é˜…æ–¹æ³•çš„é›†åˆæŒ‡å‘æ„é€ å¯¹è±¡æœ¬èº«,ç›¸å½“äº this._x = [fn1, fn2, fn3, fn4, ...]</span></span><br><span class="line">    <span class="title function_">setup</span>(<span class="params">instance, options</span>) &#123;</span><br><span class="line">        instance.<span class="property">_x</span> = options.<span class="property">taps</span>.<span class="title function_">map</span>(<span class="function"><span class="params">t</span> =&gt;</span> t.<span class="property">fn</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">&#123; type: &quot;sync&quot; | &quot;promise&quot; | &quot;async&quot;, taps: Array&lt;Tap&gt;, interceptors: Array&lt;Interceptor&gt; </span>&#125;&#125; options</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// å®è¡Œåˆå§‹åŒ–,å°†ä¼ å…¥çš„å‚æ•°ä»¥åŠå‚æ•°ä¸­æ„é€ æ—¶æŒ‡å®šçš„å‚æ•°åç§°è¿›è¡Œæ„é€ å¯¹è±¡å±æ€§èµ‹å€¼</span></span><br><span class="line">    <span class="comment">// this.options = &#123;taps: [&#123;type: string, fn: Function, name: string&#125;], type: string, interceptors: Array&lt;Interceptor&gt;, args: Array&lt;String&gt;&#125;</span></span><br><span class="line">    <span class="comment">// this.args = Array&lt;String&gt;</span></span><br><span class="line">    <span class="title function_">init</span>(<span class="params">options</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">options</span> = options;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_args</span> = options.<span class="property">args</span>.<span class="title function_">slice</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†æ„é€ å¯¹è±¡å±æ€§é‡ç½®</span></span><br><span class="line">    <span class="title function_">deinit</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">options</span> = <span class="literal">undefined</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_args</span> = <span class="literal">undefined</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œåç»­ä¼šæ›´åŠ è¯¦å°½å¯¹æ¯”çš„åšè®²è§£</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">HookCodeFactory</span>;</span><br></pre></td></tr></table></figure>
<p>  ç”±ä¸Šé¢çš„æµç¨‹,å¯ä»¥åŸºæœ¬ç†æ¸… Tapable Hook å‘å¸ƒè®¢é˜…æ¨¡å¼çš„å…³ç³»å›¾,å…¶å®è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„:</p>
<p>  <img src="https://image.white-than-wood.zone/webpack/tapable.png"></p>
<p>  æ¥ä¸‹æ¥å°†æ˜¯é‡å¤´æˆ,å°†æ ¹æ®ä¸åŒçš„è®¢é˜…æ¨¡å¼ç±»å‹ã€ä¸åŒçš„å‘å¸ƒç±»å‹ä»¥åŠæ„é€ æ—¶æŒ‡å®šçš„å‚æ•°åç§°ç¼–è¯‘ç”Ÿæˆæ‹¼æ¥å¥½ä¸åŒçš„å†…å®¹çš„åŒ¿åå‡½æ•°.</p>
<ul>
<li><p>é¦–å…ˆæ˜¯æ ¹æ®ä¸åŒçš„å‘å¸ƒç±»å‹ä»¥åŠæ„é€ æ—¶æŒ‡å®šçš„å‚æ•°åç§°å®è¡Œç¬¬ä¸€æ­¥æ‹¼æ¥.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">switch</span> (<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">type</span>) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;sync&quot;</span>:</span><br><span class="line">      fn = <span class="keyword">new</span> <span class="title class_">Function</span>(</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">args</span>(),</span><br><span class="line">          <span class="string">&#x27;&quot;use strict&quot;;\n&#x27;</span> +</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">header</span>() +</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">content</span>(&#123;</span><br><span class="line">              <span class="attr">onError</span>: <span class="function"><span class="params">err</span> =&gt;</span> <span class="string">`throw <span class="subst">$&#123;err&#125;</span>;\n`</span>,</span><br><span class="line">              <span class="attr">onResult</span>: <span class="function"><span class="params">result</span> =&gt;</span> <span class="string">`return <span class="subst">$&#123;result&#125;</span>;\n`</span>,</span><br><span class="line">              <span class="attr">resultReturns</span>: <span class="literal">true</span>,</span><br><span class="line">              <span class="attr">onDone</span>: <span class="function">() =&gt;</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">              <span class="attr">rethrowIfPossible</span>: <span class="literal">true</span></span><br><span class="line">          &#125;)</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;async&quot;</span>:</span><br><span class="line">      fn = <span class="keyword">new</span> <span class="title class_">Function</span>(</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">args</span>(&#123;</span><br><span class="line">              <span class="attr">after</span>: <span class="string">&quot;_callback&quot;</span></span><br><span class="line">          &#125;),</span><br><span class="line">          <span class="string">&#x27;&quot;use strict&quot;;\n&#x27;</span> +</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">header</span>() +</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">content</span>(&#123;</span><br><span class="line">              <span class="attr">onError</span>: <span class="function"><span class="params">err</span> =&gt;</span> <span class="string">`_callback(<span class="subst">$&#123;err&#125;</span>);\n`</span>,</span><br><span class="line">              <span class="attr">onResult</span>: <span class="function"><span class="params">result</span> =&gt;</span> <span class="string">`_callback(null, <span class="subst">$&#123;result&#125;</span>);\n`</span>,</span><br><span class="line">              <span class="attr">onDone</span>: <span class="function">() =&gt;</span> <span class="string">&quot;_callback();\n&quot;</span></span><br><span class="line">          &#125;)</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;promise&quot;</span>:</span><br><span class="line">      <span class="keyword">let</span> errorHelperUsed = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">const</span> content = <span class="variable language_">this</span>.<span class="title function_">content</span>(&#123;</span><br><span class="line">          <span class="attr">onError</span>: <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">              errorHelperUsed = <span class="literal">true</span>;</span><br><span class="line">              <span class="keyword">return</span> <span class="string">`_error(<span class="subst">$&#123;err&#125;</span>);\n`</span>;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">onResult</span>: <span class="function"><span class="params">result</span> =&gt;</span> <span class="string">`_resolve(<span class="subst">$&#123;result&#125;</span>);\n`</span>,</span><br><span class="line">          <span class="attr">onDone</span>: <span class="function">() =&gt;</span> <span class="string">&quot;_resolve();\n&quot;</span></span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">let</span> code = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      code += <span class="string">&#x27;&quot;use strict&quot;;\n&#x27;</span>;</span><br><span class="line">      code += <span class="string">&quot;return new Promise((_resolve, _reject) =&gt; &#123;\n&quot;</span>;</span><br><span class="line">      <span class="keyword">if</span> (errorHelperUsed) &#123;</span><br><span class="line">          code += <span class="string">&quot;var _sync = true;\n&quot;</span>;</span><br><span class="line">          code += <span class="string">&quot;function _error(_err) &#123;\n&quot;</span>;</span><br><span class="line">          code += <span class="string">&quot;if(_sync)\n&quot;</span>;</span><br><span class="line">          code += <span class="string">&quot;_resolve(Promise.resolve().then(() =&gt; &#123; throw _err; &#125;));\n&quot;</span>;</span><br><span class="line">          code += <span class="string">&quot;else\n&quot;</span>;</span><br><span class="line">          code += <span class="string">&quot;_reject(_err);\n&quot;</span>;</span><br><span class="line">          code += <span class="string">&quot;&#125;;\n&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      code += <span class="variable language_">this</span>.<span class="title function_">header</span>();</span><br><span class="line">      code += content;</span><br><span class="line">      <span class="keyword">if</span> (errorHelperUsed) &#123;</span><br><span class="line">          code += <span class="string">&quot;_sync = false;\n&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      code += <span class="string">&quot;&#125;);\n&quot;</span>;</span><br><span class="line">      fn = <span class="keyword">new</span> <span class="title class_">Function</span>(<span class="variable language_">this</span>.<span class="title function_">args</span>(), code);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">      MIT License http://www.opensource.org/licenses/mit-license.php</span></span><br><span class="line"><span class="comment">      Author Tobias Koppers @sokra</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HookCodeFactory</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="title function_">header</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> code = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">needContext</span>()) &#123;</span><br><span class="line">            code += <span class="string">&quot;var _context = &#123;&#125;;\n&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            code += <span class="string">&quot;var _context;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        code += <span class="string">&quot;var _x = this._x;\n&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">interceptors</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            code += <span class="string">&quot;var _taps = this.taps;\n&quot;</span>;</span><br><span class="line">            code += <span class="string">&quot;var _interceptors = this.interceptors;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">interceptors</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> interceptor = <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">interceptors</span>[i];</span><br><span class="line">            <span class="keyword">if</span> (interceptor.<span class="property">call</span>) &#123;</span><br><span class="line">                code += <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.getInterceptor(i)&#125;</span>.call(<span class="subst">$&#123;<span class="variable language_">this</span>.args(&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">                    before: interceptor.context ? <span class="string">&quot;_context&quot;</span> : <span class="literal">undefined</span></span></span></span><br><span class="line"><span class="subst"><span class="string">                &#125;)&#125;</span>);\n`</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">      MIT License http://www.opensource.org/licenses/mit-license.php</span></span><br><span class="line"><span class="comment">      Author Tobias Koppers @sokra</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HookCodeFactory</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="title function_">args</span>(<span class="params">&#123;before, after&#125; = &#123;&#125;</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> allArgs = <span class="variable language_">this</span>.<span class="property">_args</span>;</span><br><span class="line">        <span class="keyword">if</span> (before) allArgs = [before].<span class="title function_">concat</span>(allArgs);</span><br><span class="line">        <span class="keyword">if</span> (after) allArgs = allArgs.<span class="title function_">concat</span>(after);</span><br><span class="line">        <span class="keyword">if</span> (allArgs.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> allArgs.<span class="title function_">join</span>(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ·»åŠ ä¸Š header ä»¥åŠ args éƒ¨åˆ†,ä¹çœ‹èµ·æ¥æ˜¯æœ‰ç‚¹å¤šçš„,å¯ä»¥ä½¿ç”¨ä¼ªä»£ç æ¥ç®€åŒ–æµç¨‹:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">fn</span><br><span class="line">if &#x27;sync&#x27;</span><br><span class="line">  fn = args + header + content</span><br><span class="line">if &#x27;async&#x27;</span><br><span class="line">  fn = args with _callback + header + content</span><br><span class="line">if &#x27;promise&#x27;</span><br><span class="line">  fn = (args + header + content) with new Promise</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥è½¬åŒ–ä¸ºå®é™…æ‹¼æ¥å¥½çš„ JS ä»£ç æ¥è¡¨ç¤ºæµç¨‹:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">call</span> = <span class="keyword">function</span> <span class="title function_">lazyCompileHook</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">function</span> (<span class="params">args1, args2</span>) &#123;</span><br><span class="line">      <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line">      <span class="keyword">var</span> _context;</span><br><span class="line">      <span class="keyword">var</span> _x = <span class="variable language_">this</span>.<span class="property">_x</span>;</span><br><span class="line">      <span class="comment">// content(&#123;onError, onResult, resultReturns, onDone, rethrowIfPossible&#125;);</span></span><br><span class="line">  &#125;)(...args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">callAsync</span> = <span class="keyword">function</span> <span class="title function_">lazyCompileHook</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">function</span> (<span class="params">args1, args2, _callback</span>) &#123;</span><br><span class="line">      <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line">      <span class="keyword">var</span> _context;</span><br><span class="line">      <span class="keyword">var</span> _x = <span class="variable language_">this</span>.<span class="property">_x</span>;</span><br><span class="line">      <span class="comment">// content(&#123;onError, onResult, onDone&#125;);</span></span><br><span class="line">  &#125;)(...args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">promise</span> = <span class="keyword">function</span> <span class="title function_">lazyCompileHook</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">function</span> (<span class="params">args1, args2, _callback</span>) &#123;</span><br><span class="line">      <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">_resolve, _reject</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">var</span> _context;</span><br><span class="line">          <span class="keyword">var</span> _x = <span class="variable language_">this</span>.<span class="property">x</span>;</span><br><span class="line">          <span class="comment">// content(&#123;onError, onResult, onDone&#125;);</span></span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;)(...args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>æ¥ç€ç€é‡çœ‹ä¸‹ä¸€ä¸ªéƒ¨åˆ†,ä¹Ÿå°±æ˜¯æ ¹æ®ä¸åŒçš„è®¢é˜…æ¨¡å¼ç±»å‹å®è¡Œæœ€åçš„æ‹¼æ¥.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å…ˆçœ‹ SyncxxxHook éƒ¨åˆ†,é™¤äº†å¾ªç¯é’©å­,è°ƒç”¨çš„éƒ½æ˜¯ callTapsSeries æ–¹æ³•</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HookCodeFactory</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="title function_">callTapsSeries</span>(<span class="params">&#123;</span></span><br><span class="line"><span class="params">                       onError,</span></span><br><span class="line"><span class="params">                       onResult,</span></span><br><span class="line"><span class="params">                       resultReturns,</span></span><br><span class="line"><span class="params">                       onDone,</span></span><br><span class="line"><span class="params">                       doneReturns,</span></span><br><span class="line"><span class="params">                       rethrowIfPossible</span></span><br><span class="line"><span class="params">                   &#125;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">taps</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span> <span class="title function_">onDone</span>();</span><br><span class="line">        <span class="keyword">const</span> firstAsync = <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">taps</span>.<span class="title function_">findIndex</span>(<span class="function"><span class="params">t</span> =&gt;</span> t.<span class="property">type</span> !== <span class="string">&quot;sync&quot;</span>);</span><br><span class="line">        <span class="keyword">const</span> somethingReturns = resultReturns || doneReturns || <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">let</span> code = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">let</span> current = onDone;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">taps</span>.<span class="property">length</span> - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">            <span class="keyword">const</span> i = j;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">            <span class="keyword">const</span> done = current;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">            <span class="keyword">const</span> content = <span class="variable language_">this</span>.<span class="title function_">callTap</span>(i, &#123;</span><br><span class="line">                <span class="attr">onError</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="title function_">onError</span>(i, error, done, doneBreak),</span><br><span class="line">                <span class="attr">onResult</span>:</span><br><span class="line">                    onResult &amp;&amp;</span><br><span class="line">                    (<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="title function_">onResult</span>(i, result, done, doneBreak);</span><br><span class="line">                    &#125;),</span><br><span class="line">                <span class="attr">onDone</span>: !onResult &amp;&amp; done,</span><br><span class="line">                <span class="attr">rethrowIfPossible</span>:</span><br><span class="line">                    rethrowIfPossible &amp;&amp; (firstAsync &lt; <span class="number">0</span> || i &lt; firstAsync)</span><br><span class="line">            &#125;);</span><br><span class="line">            current = <span class="function">() =&gt;</span> content;</span><br><span class="line">        &#125;</span><br><span class="line">        code += <span class="title function_">current</span>();</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±ä¸Šè¿°éƒ¨åˆ†å¯ä»¥çœ‹å‡º,é€†å¾ªç¯è®¢é˜…æ–¹æ³•é›†åˆ,æœ¬æ¬¡æ‹¼æ¥çš„ç»“æœä¼šä½œä¸ºä¸‹ä¸€æ¬¡æ‹¼æ¥çš„ onDone æˆ–è€… onResult ä¼ å…¥è‡³ callTap æ–¹æ³•ä¸­.é‚£å°±ç»§ç»­æŸ¥çœ‹ callTap æ–¹æ³•.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç›¸å¯¹åº”çš„,è¿˜æ˜¯æŸ¥çœ‹ &#x27;sync&#x27; éƒ¨åˆ†</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HookCodeFactory</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="title function_">callTap</span>(<span class="params">tapIndex, &#123;onError, onResult, onDone, rethrowIfPossible&#125;</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> code = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        code += <span class="string">`var _fn<span class="subst">$&#123;tapIndex&#125;</span> = <span class="subst">$&#123;<span class="variable language_">this</span>.getTapFn(tapIndex)&#125;</span>;\n`</span>;</span><br><span class="line">        <span class="keyword">const</span> tap = <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">taps</span>[tapIndex];</span><br><span class="line">        <span class="keyword">switch</span> (tap.<span class="property">type</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;sync&quot;</span>:</span><br><span class="line">                <span class="keyword">if</span> (!rethrowIfPossible) &#123;</span><br><span class="line">                    code += <span class="string">`var _hasError<span class="subst">$&#123;tapIndex&#125;</span> = false;\n`</span>;</span><br><span class="line">                    code += <span class="string">&quot;try &#123;\n&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (onResult) &#123;</span><br><span class="line">                    code += <span class="string">`var _result<span class="subst">$&#123;tapIndex&#125;</span> = _fn<span class="subst">$&#123;tapIndex&#125;</span>(<span class="subst">$&#123;<span class="variable language_">this</span>.args(&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">                        before: tap.context ? <span class="string">&quot;_context&quot;</span> : <span class="literal">undefined</span></span></span></span><br><span class="line"><span class="subst"><span class="string">                    &#125;)&#125;</span>);\n`</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    code += <span class="string">`_fn<span class="subst">$&#123;tapIndex&#125;</span>(<span class="subst">$&#123;<span class="variable language_">this</span>.args(&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">                        before: tap.context ? <span class="string">&quot;_context&quot;</span> : <span class="literal">undefined</span></span></span></span><br><span class="line"><span class="subst"><span class="string">                    &#125;)&#125;</span>);\n`</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!rethrowIfPossible) &#123;</span><br><span class="line">                    code += <span class="string">&quot;&#125; catch(_err) &#123;\n&quot;</span>;</span><br><span class="line">                    code += <span class="string">`_hasError<span class="subst">$&#123;tapIndex&#125;</span> = true;\n`</span>;</span><br><span class="line">                    code += <span class="title function_">onError</span>(<span class="string">&quot;_err&quot;</span>);</span><br><span class="line">                    code += <span class="string">&quot;&#125;\n&quot;</span>;</span><br><span class="line">                    code += <span class="string">`if(!_hasError<span class="subst">$&#123;tapIndex&#125;</span>) &#123;\n`</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (onResult) &#123;</span><br><span class="line">                    code += <span class="title function_">onResult</span>(<span class="string">`_result<span class="subst">$&#123;tapIndex&#125;</span>`</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (onDone) &#123;</span><br><span class="line">                    code += <span class="title function_">onDone</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!rethrowIfPossible) &#123;</span><br><span class="line">                    code += <span class="string">&quot;&#125;\n&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HookCodeFactory</span> &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="title function_">getTapFn</span>(<span class="params">idx</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">`_x[<span class="subst">$&#123;idx&#125;</span>]`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤,åŸºæœ¬å¯ä»¥å¾—åˆ°ç»“è®º,åœ¨ callTap æ–¹æ³•ä¸­,â€™syncâ€™ éƒ¨åˆ†æ˜¯æ ¹æ®æœ‰æ—  onResult ä»¥åŠæœ‰æ—  onDone æ¥åˆ¤æ–­å¹¶æ‹¼æ¥å†…å®¹çš„.é‚£æœ€åå†ç®€åŒ–ä¸€ä¸‹.</p>
<div style="display: flex;justify-content: space-between;align-items: center;">
  <div style="width: 49%;">
      <img src="https://image.white-than-wood.zone/webpack/on_result.png" alt="on_result">
  </div>
  <div style="width: 48%;">
      <img src="https://image.white-than-wood.zone/webpack/on_done.png" alt="on_done">
  </div>
</div>

<p>å¯¹äº SyncxxxHook éƒ¨åˆ†,é™¤äº†å¾ªç¯é’©å­,æœ€ç»ˆå¾—å‡ºäº†ç­”æ¡ˆ.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SyncHook,åœ¨è¿™é‡Œéƒ½ä½¿ç”¨å¤šå‚æ•°åç§°ã€å¤šè®¢é˜…æ–¹æ³•é›†åˆæ¥å±•ç¤ºæœ€ç»ˆæ‹¼æ¥ç»“æœ.</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">call</span> = <span class="keyword">function</span> <span class="title function_">lazyCompileHook</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">function</span> (<span class="params">args1, args2</span>) &#123;</span><br><span class="line">        <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line">        <span class="keyword">var</span> _context;</span><br><span class="line">        <span class="keyword">var</span> _x = <span class="variable language_">this</span>.<span class="property">_x</span>;</span><br><span class="line">        <span class="keyword">var</span> _fn0 = <span class="variable language_">this</span>.<span class="property">_x</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="title function_">_fn0</span>(args1, args2);</span><br><span class="line">        <span class="keyword">var</span> _fn1 = <span class="variable language_">this</span>.<span class="property">_x</span>[<span class="number">1</span>];</span><br><span class="line">        <span class="title function_">_fn1</span>(args1, args2);</span><br><span class="line">    &#125;)(...args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SyncBailHook,åœ¨è¿™é‡Œéƒ½ä½¿ç”¨å¤šå‚æ•°åç§°ã€å¤šè®¢é˜…æ–¹æ³•é›†åˆæ¥å±•ç¤ºæœ€ç»ˆæ‹¼æ¥ç»“æœ.</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">call</span> = <span class="keyword">function</span> <span class="title function_">lazyCompileHook</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">function</span> (<span class="params">args1, args2</span>) &#123;</span><br><span class="line">        <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line">        <span class="keyword">var</span> _context;</span><br><span class="line">        <span class="keyword">var</span> _x = <span class="variable language_">this</span>.<span class="property">_x</span>;</span><br><span class="line">        <span class="keyword">var</span> _fn0 = <span class="variable language_">this</span>.<span class="property">_x</span>[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">var</span> _result0 = <span class="title function_">_fn0</span>(args1, args2);</span><br><span class="line">        <span class="keyword">if</span> (_result0 !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> _result0;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> _fn1 = <span class="variable language_">this</span>.<span class="property">_x</span>[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">var</span> _result1 = <span class="title function_">_fn1</span>(args1, args2);</span><br><span class="line">            <span class="keyword">if</span> (_result1 !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> _result1;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)(...args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SyncWarterfallHook,åœ¨è¿™é‡Œéƒ½ä½¿ç”¨å¤šå‚æ•°åç§°ã€å¤šè®¢é˜…æ–¹æ³•é›†åˆæ¥å±•ç¤ºæœ€ç»ˆæ‹¼æ¥ç»“æœ.</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">call</span> = <span class="keyword">function</span> <span class="title function_">lazyCompileHook</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">function</span> (<span class="params">args1, args2</span>) &#123;</span><br><span class="line">        <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line">        <span class="keyword">var</span> _context;</span><br><span class="line">        <span class="keyword">var</span> _x = <span class="variable language_">this</span>.<span class="property">_x</span>;</span><br><span class="line">        <span class="keyword">var</span> _fn0 = _x[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">var</span> _result0 = <span class="title function_">_fn0</span>(args1, args2);</span><br><span class="line">        <span class="keyword">if</span> (_result0 !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">            args1 = _result0;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> _fn1 = _x[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">var</span> _result1 = <span class="title function_">_fn1</span>(args1, args2);</span><br><span class="line">        <span class="keyword">if</span> (_result1 !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">            args1 = _result1;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> args1;</span><br><span class="line">    &#125;)(...args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥æ­¤ç±»æ¨,å¼‚æ­¥ AsyncSeriesxxxHook éƒ¨åˆ†,é™¤äº†å¾ªç¯é’©å­,è°ƒç”¨çš„ä¹Ÿéƒ½æ˜¯ callTapsSeries æ–¹æ³•.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HookCodeFactory</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="title function_">callTapsSeries</span>(<span class="params">&#123;</span></span><br><span class="line"><span class="params">                       onError,</span></span><br><span class="line"><span class="params">                       onResult,</span></span><br><span class="line"><span class="params">                       resultReturns,</span></span><br><span class="line"><span class="params">                       onDone,</span></span><br><span class="line"><span class="params">                       doneReturns,</span></span><br><span class="line"><span class="params">                       rethrowIfPossible</span></span><br><span class="line"><span class="params">                   &#125;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">taps</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span> <span class="title function_">onDone</span>();</span><br><span class="line">        <span class="keyword">const</span> firstAsync = <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">taps</span>.<span class="title function_">findIndex</span>(<span class="function"><span class="params">t</span> =&gt;</span> t.<span class="property">type</span> !== <span class="string">&quot;sync&quot;</span>);</span><br><span class="line">        <span class="keyword">const</span> somethingReturns = resultReturns || doneReturns || <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">let</span> code = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">let</span> current = onDone;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">taps</span>.<span class="property">length</span> - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">            <span class="keyword">const</span> i = j;</span><br><span class="line">            <span class="keyword">if</span> (unroll) &#123;</span><br><span class="line">                code += <span class="string">`function _next<span class="subst">$&#123;i&#125;</span>() &#123;\n`</span>;</span><br><span class="line">                code += <span class="title function_">current</span>();</span><br><span class="line">                code += <span class="string">`&#125;\n`</span>;</span><br><span class="line">                current = <span class="function">() =&gt;</span> <span class="string">`<span class="subst">$&#123;somethingReturns ? <span class="string">&quot;return &quot;</span> : <span class="string">&quot;&quot;</span>&#125;</span>_next<span class="subst">$&#123;i&#125;</span>();\n`</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">const</span> done = current;</span><br><span class="line">            <span class="keyword">const</span> <span class="title function_">doneBreak</span> = skipDone =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (skipDone) <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="title function_">onDone</span>();</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">const</span> content = <span class="variable language_">this</span>.<span class="title function_">callTap</span>(i, &#123;</span><br><span class="line">                <span class="attr">onError</span>: <span class="function"><span class="params">error</span> =&gt;</span> <span class="title function_">onError</span>(i, error, done, doneBreak),</span><br><span class="line">                <span class="attr">onResult</span>:</span><br><span class="line">                    onResult &amp;&amp;</span><br><span class="line">                    (<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="title function_">onResult</span>(i, result, done, doneBreak);</span><br><span class="line">                    &#125;),</span><br><span class="line">                <span class="attr">onDone</span>: !onResult &amp;&amp; done,</span><br><span class="line">                <span class="attr">rethrowIfPossible</span>:</span><br><span class="line">                    rethrowIfPossible &amp;&amp; (firstAsync &lt; <span class="number">0</span> || i &lt; firstAsync)</span><br><span class="line">            &#125;);</span><br><span class="line">            current = <span class="function">() =&gt;</span> content;</span><br><span class="line">        &#125;</span><br><span class="line">        code += <span class="title function_">current</span>();</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŒç†,å¼‚æ­¥ AsyncSeriesxxxHook éƒ¨åˆ†è¿˜æ˜¯é€†å¾ªç¯è®¢é˜…æ–¹æ³•é›†åˆ,æœ¬æ¬¡æ‹¼æ¥çš„ç»“æœä¼šä½œä¸ºä¸‹ä¸€æ¬¡æ‹¼æ¥çš„ onDone æˆ–è€… onResult ä¼ å…¥è‡³ callTap æ–¹æ³•ä¸­,ä½†æ˜¯æœ¬æ¬¡æ‹¼æ¥çš„ç»“æœä¼šåŠ ä¸€å±‚ next åŒ…è£¹,æ¥ç€è¿˜æ˜¯æŸ¥çœ‹ callTap æ–¹æ³•.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç›¸å¯¹åº”çš„,æŸ¥çœ‹ &#x27;async&#x27; éƒ¨åˆ†</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HookCodeFactory</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="title function_">callTap</span>(<span class="params">tapIndex, &#123;onError, onResult, onDone, rethrowIfPossible&#125;</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> code = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        code += <span class="string">`var _fn<span class="subst">$&#123;tapIndex&#125;</span> = <span class="subst">$&#123;<span class="variable language_">this</span>.getTapFn(tapIndex)&#125;</span>;\n`</span>;</span><br><span class="line">        <span class="keyword">const</span> tap = <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">taps</span>[tapIndex];</span><br><span class="line">        <span class="keyword">switch</span> (tap.<span class="property">type</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;async&quot;</span>:</span><br><span class="line">                <span class="keyword">let</span> cbCode = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                <span class="keyword">if</span> (onResult) cbCode += <span class="string">`(_err<span class="subst">$&#123;tapIndex&#125;</span>, _result<span class="subst">$&#123;tapIndex&#125;</span>) =&gt; &#123;\n`</span>;</span><br><span class="line">                <span class="keyword">else</span> cbCode += <span class="string">`_err<span class="subst">$&#123;tapIndex&#125;</span> =&gt; &#123;\n`</span>;</span><br><span class="line">                cbCode += <span class="string">`if(_err<span class="subst">$&#123;tapIndex&#125;</span>) &#123;\n`</span>;</span><br><span class="line">                cbCode += <span class="title function_">onError</span>(<span class="string">`_err<span class="subst">$&#123;tapIndex&#125;</span>`</span>);</span><br><span class="line">                cbCode += <span class="string">&quot;&#125; else &#123;\n&quot;</span>;</span><br><span class="line">                <span class="keyword">if</span> (onResult) &#123;</span><br><span class="line">                    cbCode += <span class="title function_">onResult</span>(<span class="string">`_result<span class="subst">$&#123;tapIndex&#125;</span>`</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (onDone) &#123;</span><br><span class="line">                    cbCode += <span class="title function_">onDone</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                cbCode += <span class="string">&quot;&#125;\n&quot;</span>;</span><br><span class="line">                cbCode += <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">                code += <span class="string">`_fn<span class="subst">$&#123;tapIndex&#125;</span>(<span class="subst">$&#123;<span class="variable language_">this</span>.args(&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">                    before: tap.context ? <span class="string">&quot;_context&quot;</span> : <span class="literal">undefined</span>,</span></span></span><br><span class="line"><span class="subst"><span class="string">                    after: cbCode</span></span></span><br><span class="line"><span class="subst"><span class="string">                &#125;)&#125;</span>);\n`</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HookCodeFactory</span> &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="title function_">getTapFn</span>(<span class="params">idx</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">`_x[<span class="subst">$&#123;idx&#125;</span>]`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤,ä¹ŸåŸºæœ¬å¯ä»¥å¾—åˆ°ç»“è®º,åœ¨ callTap æ–¹æ³•ä¸­,â€™asyncâ€™ éƒ¨åˆ†æ˜¯æ ¹æ® onErrorã€æœ‰æ—  onResult ä»¥åŠæœ‰æ—  onDone æ¥åˆ¤æ–­å¹¶æ‹¼æ¥å†…å®¹çš„.æœ€åä¹Ÿå†ç®€åŒ–ä¸€ä¸‹.</p>
<div style="display: flex;justify-content: space-between;align-items: center;">
  <div style="width: 49%;">
      <img src="https://image.white-than-wood.zone/webpack/async_on_result.png" alt="async_on_result">
  </div>
  <div style="width: 49%;">
      <img src="https://image.white-than-wood.zone/webpack/async_on_done.png" alt="async_on_done">
  </div>
</div>

<p>å¯¹äºå¼‚æ­¥ AsyncSeriesxxxHook éƒ¨åˆ†,é™¤äº†å¾ªç¯é’©å­,æœ€ç»ˆä¹Ÿå¾—å‡ºäº†ç­”æ¡ˆ.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AsyncSeriesHook,åœ¨è¿™é‡Œéƒ½ä½¿ç”¨å¤šå‚æ•°åç§°ã€å¤šå¼‚æ­¥è®¢é˜…æ–¹æ³•é›†åˆæ¥å±•ç¤ºæœ€ç»ˆæ‹¼æ¥ç»“æœ.</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">callAsync</span> = <span class="keyword">function</span> <span class="title function_">lazyCompileHook</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">function</span> (<span class="params">args1, args2, _callback</span>) &#123;</span><br><span class="line">        <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line">        <span class="keyword">var</span> _context;</span><br><span class="line">        <span class="keyword">var</span> _x = <span class="variable language_">this</span>.<span class="property">_x</span>;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">_next0</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> _fn1 = _x[<span class="number">1</span>];</span><br><span class="line">            <span class="title function_">_fn1</span>(args1, args2, <span class="function">(<span class="params">_err1</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (_err1) &#123;</span><br><span class="line">                    <span class="title function_">_callback</span>(_err1);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="title function_">_callback</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">var</span> _fn0 = _x[<span class="number">0</span>];</span><br><span class="line">        <span class="title function_">_fn0</span>(args1, args2, <span class="function">(<span class="params">_err0</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (_err0) &#123;</span><br><span class="line">                <span class="title function_">_callback</span>(_err0);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">_next0</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)(...args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AsyncSeriesBailHook,åœ¨è¿™é‡Œéƒ½ä½¿ç”¨å¤šå‚æ•°åç§°ã€å¤šå¼‚æ­¥è®¢é˜…æ–¹æ³•é›†åˆæ¥å±•ç¤ºæœ€ç»ˆæ‹¼æ¥ç»“æœ.</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">callAsync</span> = <span class="keyword">function</span> <span class="title function_">lazyCompileHook</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">function</span> (<span class="params">args1, args2, _callback</span>) &#123;</span><br><span class="line">        <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line">        <span class="keyword">var</span> _context;</span><br><span class="line">        <span class="keyword">var</span> _x = <span class="variable language_">this</span>.<span class="property">_x</span>;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">_next0</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> _fn1 = _x[<span class="number">1</span>];</span><br><span class="line">            <span class="title function_">_fn1</span>(args1, args2, <span class="function">(<span class="params">_err1, _result1</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (_err1) &#123;</span><br><span class="line">                    <span class="title function_">_callback</span>(_err1);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (_result1 !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                        <span class="title function_">_callback</span>(<span class="literal">null</span>, _result1);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="title function_">_callback</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">var</span> _fn0 = _x[<span class="number">0</span>];</span><br><span class="line">        <span class="title function_">_fn0</span>(args1, args2, <span class="function">(<span class="params">_err0, _result0</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (_err0) &#123;</span><br><span class="line">                <span class="title function_">_callback</span>(_err0);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (_result0 !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                    <span class="title function_">_callback</span>(<span class="literal">null</span>, _result0);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="title function_">_next0</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)(...args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AsyncSeriesWaterfallHook,åœ¨è¿™é‡Œéƒ½ä½¿ç”¨å¤šå‚æ•°åç§°ã€å¤šå¼‚æ­¥è®¢é˜…æ–¹æ³•é›†åˆæ¥å±•ç¤ºæœ€ç»ˆæ‹¼æ¥ç»“æœ.</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">callAsync</span> = <span class="keyword">function</span> <span class="title function_">lazyCompileHook</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">function</span> (<span class="params">args1, args2, _callback</span>) &#123;</span><br><span class="line">        <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line">        <span class="keyword">var</span> _context;</span><br><span class="line">        <span class="keyword">var</span> _x = <span class="variable language_">this</span>.<span class="property">_x</span>;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">_next0</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> _fn1 = _x[<span class="number">1</span>];</span><br><span class="line">            <span class="title function_">_fn1</span>(args1, args2, <span class="function">(<span class="params">_err1, _result1</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (_err1) &#123;</span><br><span class="line">                    <span class="title function_">_callback</span>(_err1);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (_result1 !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                        args1 = _result1;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="title function_">_callback</span>(<span class="literal">null</span>, args1);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">var</span> _fn0 = _x[<span class="number">0</span>];</span><br><span class="line">        <span class="title function_">_fn0</span>(args1, args2, <span class="function">(<span class="params">_err0, _result0</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (_err0) &#123;</span><br><span class="line">                <span class="title function_">_callback</span>(_err0);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (_result0 !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                    args1 = _result0;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="title function_">_next0</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)(...args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŒæ ·,Promise AsyncSeriesxxxHook éƒ¨åˆ†,é™¤äº†å¾ªç¯é’©å­,è°ƒç”¨çš„ä¹Ÿéƒ½æ˜¯ callTapsSeries æ–¹æ³•,è€Œ callTap æ–¹æ³•åˆ™ä¾ç„¶æ˜¯é€†å¾ªç¯è®¢é˜…æ–¹æ³•é›†åˆ,æœ¬æ¬¡æ‹¼æ¥çš„ç»“æœä¼šä½œä¸ºä¸‹ä¸€æ¬¡æ‹¼æ¥çš„ onDone æˆ–è€… onResult ä¼ å…¥å…¶ä¸­,æœ€å¤§çš„ä¸åŒå°±æ˜¯ç›¸å¯¹äºå¼‚æ­¥æ¥è¯´ç»“æ„æœ‰äº†æ¯”è¾ƒå¤§çš„æ”¹å˜.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æŸ¥çœ‹ &#x27;promise&#x27; éƒ¨åˆ†</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HookCodeFactory</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="title function_">callTap</span>(<span class="params">tapIndex, &#123;onError, onResult, onDone, rethrowIfPossible&#125;</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> code = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        code += <span class="string">`var _fn<span class="subst">$&#123;tapIndex&#125;</span> = <span class="subst">$&#123;<span class="variable language_">this</span>.getTapFn(tapIndex)&#125;</span>;\n`</span>;</span><br><span class="line">        <span class="keyword">const</span> tap = <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">taps</span>[tapIndex];</span><br><span class="line">        <span class="keyword">switch</span> (tap.<span class="property">type</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;promise&quot;</span>:</span><br><span class="line">                code += <span class="string">`var _hasResult<span class="subst">$&#123;tapIndex&#125;</span> = false;\n`</span>;</span><br><span class="line">                code += <span class="string">`var _promise<span class="subst">$&#123;tapIndex&#125;</span> = _fn<span class="subst">$&#123;tapIndex&#125;</span>(<span class="subst">$&#123;<span class="variable language_">this</span>.args(&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">                    before: tap.context ? <span class="string">&quot;_context&quot;</span> : <span class="literal">undefined</span></span></span></span><br><span class="line"><span class="subst"><span class="string">                &#125;)&#125;</span>);\n`</span>;</span><br><span class="line">                code += <span class="string">`if (!_promise<span class="subst">$&#123;tapIndex&#125;</span> || !_promise<span class="subst">$&#123;tapIndex&#125;</span>.then)\n`</span>;</span><br><span class="line">                code += <span class="string">`  throw new Error(&#x27;Tap function (tapPromise) did not return promise (returned &#x27; + _promise<span class="subst">$&#123;tapIndex&#125;</span> + &#x27;)&#x27;);\n`</span>;</span><br><span class="line">                code += <span class="string">`_promise<span class="subst">$&#123;tapIndex&#125;</span>.then(_result<span class="subst">$&#123;tapIndex&#125;</span> =&gt; &#123;\n`</span>;</span><br><span class="line">                code += <span class="string">`_hasResult<span class="subst">$&#123;tapIndex&#125;</span> = true;\n`</span>;</span><br><span class="line">                <span class="keyword">if</span> (onResult) &#123;</span><br><span class="line">                    code += <span class="title function_">onResult</span>(<span class="string">`_result<span class="subst">$&#123;tapIndex&#125;</span>`</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (onDone) &#123;</span><br><span class="line">                    code += <span class="title function_">onDone</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                code += <span class="string">`&#125;, _err<span class="subst">$&#123;tapIndex&#125;</span> =&gt; &#123;\n`</span>;</span><br><span class="line">                code += <span class="string">`if(_hasResult<span class="subst">$&#123;tapIndex&#125;</span>) throw _err<span class="subst">$&#123;tapIndex&#125;</span>;\n`</span>;</span><br><span class="line">                code += <span class="title function_">onError</span>(<span class="string">`_err<span class="subst">$&#123;tapIndex&#125;</span>`</span>);</span><br><span class="line">                code += <span class="string">&quot;&#125;);\n&quot;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HookCodeFactory</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="title function_">getTapFn</span>(<span class="params">idx</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`_x[<span class="subst">$&#123;idx&#125;</span>]`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆå¯ä»¥å¾—å‡ºç»“è®º,åœ¨ callTap æ–¹æ³•ä¸­,â€™promiseâ€™ éƒ¨åˆ†æ˜¯æ ¹æ® onErrorã€æœ‰æ—  onResult ä»¥åŠæœ‰æ—  onDone æ¥åˆ¤æ–­å¹¶æ‹¼æ¥å†…å®¹çš„.æœ€åä¹Ÿå†ç®€åŒ–ä¸€ä¸‹.</p>
<div style="display: flex;justify-content: space-between;align-items: center;">
    <div style="width: 49%;">
        <img src="https://image.white-than-wood.zone/webpack/promise_on_result.png" alt="promise_on_result">
    </div>
    <div style="width: 49%;">
        <img src="https://image.white-than-wood.zone/webpack/promise_on_done.png" alt="promise_on_done">
    </div>
</div>

<p>å¯¹äº Promise AsyncSeriesxxxHook éƒ¨åˆ†,é™¤äº†å¾ªç¯é’©å­,æœ€ç»ˆå¾—å‡ºäº†ç­”æ¡ˆ.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AsyncSeriesHook,åœ¨è¿™é‡Œéƒ½ä½¿ç”¨å¤šå‚æ•°åç§°ã€å¤š Promise è®¢é˜…æ–¹æ³•é›†åˆæ¥å±•ç¤ºæœ€ç»ˆæ‹¼æ¥ç»“æœ.</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">promise</span> = <span class="keyword">function</span> <span class="title function_">lazyCompileHook</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">function</span> (<span class="params">args1, args2</span>) &#123;</span><br><span class="line">        <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">_resolve, _reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> _sync = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">function</span> <span class="title function_">_error</span>(<span class="params">_err</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (_sync)</span><br><span class="line">                    <span class="title function_">_resolve</span>(<span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="keyword">throw</span> _err));</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="title function_">_reject</span>(_err);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> _context;</span><br><span class="line">            <span class="keyword">var</span> _x = <span class="variable language_">this</span>.<span class="property">_x</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">function</span> <span class="title function_">_next0</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> _fn1 = _x[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">var</span> _hasResult1 = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">var</span> _promise1 = <span class="title function_">_fn1</span>(args1, args2);</span><br><span class="line">                <span class="keyword">if</span> (!_promise1 || !_promise1.<span class="property">then</span>)</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Tap function (tapPromise) did not return promise (returned &#x27;</span> + _promise1 + <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">                _promise1.<span class="title function_">then</span>(<span class="function"><span class="params">_result1</span> =&gt;</span> &#123;</span><br><span class="line">                    _hasResult1 = <span class="literal">true</span>;</span><br><span class="line">                    <span class="title function_">_resolve</span>();</span><br><span class="line">                &#125;, <span class="function"><span class="params">_err1</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (_hasResult1) <span class="keyword">throw</span> _err1;</span><br><span class="line">                    <span class="title function_">_error</span>(_err1);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> _fn0 = _x[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">var</span> _hasResult0 = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">var</span> _promise0 = <span class="title function_">_fn0</span>(args1, args2);</span><br><span class="line">            <span class="keyword">if</span> (!_promise0 || !_promise0.<span class="property">then</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Tap function (tapPromise) did not return promise (returned &#x27;</span> + _promise0 + <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">            _promise0.<span class="title function_">then</span>(<span class="function"><span class="params">_result0</span> =&gt;</span> &#123;</span><br><span class="line">                _hasResult0 = <span class="literal">true</span>;</span><br><span class="line">                <span class="title function_">_next0</span>();</span><br><span class="line">            &#125;, <span class="function"><span class="params">_err0</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (_hasResult0) <span class="keyword">throw</span> _err0;</span><br><span class="line">                <span class="title function_">_error</span>(_err0);</span><br><span class="line">            &#125;);</span><br><span class="line">            _sync = <span class="literal">false</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)(...args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AsyncSeriesBailHook,åœ¨è¿™é‡Œéƒ½ä½¿ç”¨å¤šå‚æ•°åç§°ã€å¤š Promise è®¢é˜…æ–¹æ³•é›†åˆæ¥å±•ç¤ºæœ€ç»ˆæ‹¼æ¥ç»“æœ.</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">promise</span> = <span class="keyword">function</span> <span class="title function_">lazyCompileHook</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">function</span> (<span class="params">args1, args2</span>) &#123;</span><br><span class="line">        <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">_resolve, _reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> _sync = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">function</span> <span class="title function_">_error</span>(<span class="params">_err</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (_sync)</span><br><span class="line">                    <span class="title function_">_resolve</span>(<span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">throw</span> _err;</span><br><span class="line">                    &#125;));</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="title function_">_reject</span>(_err);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> _context;</span><br><span class="line">            <span class="keyword">var</span> _x = <span class="variable language_">this</span>.<span class="property">_x</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">function</span> <span class="title function_">_next0</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> _fn1 = _x[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">var</span> _hasResult1 = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">var</span> _promise1 = <span class="title function_">_fn1</span>(args1, args2);</span><br><span class="line">                <span class="keyword">if</span> (!_promise1 || !_promise1.<span class="property">then</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Tap function (tapPromise) did not return promise (returned &#x27;</span> + _promise1 + <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                _promise1.<span class="title function_">then</span>(<span class="function"><span class="params">_result1</span> =&gt;</span> &#123;</span><br><span class="line">                    _hasResult1 = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (_result1 !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                        <span class="title function_">_resolve</span>(_result1);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="title function_">_resolve</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="function"><span class="params">_err1</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (_hasResult1) <span class="keyword">throw</span>  _err1;</span><br><span class="line">                    <span class="title function_">_error</span>(_err1);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> _fn0 = _x[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">var</span> _hasResult0 = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">var</span> _promise0 = <span class="title function_">_fn0</span>(args1, args2);</span><br><span class="line">            <span class="keyword">if</span> (!_promise0 || !_promise0.<span class="property">then</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Tap function (tapPromise) did not return promise (returned &#x27;</span> + _promise0 + <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            _promise0.<span class="title function_">then</span>(<span class="function"><span class="params">_result0</span> =&gt;</span> &#123;</span><br><span class="line">                _hasResult0 = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (_result0 !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                    <span class="title function_">_resolve</span>(_result0);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="title function_">_next0</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="function"><span class="params">_err0</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (_hasResult0) <span class="keyword">throw</span>  _err0;</span><br><span class="line">                <span class="title function_">_error</span>(_err0);</span><br><span class="line">            &#125;);</span><br><span class="line">            _sync = <span class="literal">false</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)(...args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AsyncSeriesWaterfallHook,åœ¨è¿™é‡Œéƒ½ä½¿ç”¨å¤šå‚æ•°åç§°ã€å¤š Promise è®¢é˜…æ–¹æ³•é›†åˆæ¥å±•ç¤ºæœ€ç»ˆæ‹¼æ¥ç»“æœ.</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">promise</span> = <span class="keyword">function</span> <span class="title function_">lazyCompileHook</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">function</span> (<span class="params">args1, args2</span>) &#123;</span><br><span class="line">        <span class="string">&#x27;use strict&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">_resolve, _reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> _sync = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">function</span> <span class="title function_">_error</span>(<span class="params">_err</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (_sync)</span><br><span class="line">                    <span class="title function_">_resolve</span>(<span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">throw</span> _err;</span><br><span class="line">                    &#125;));</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="title function_">_reject</span>(_err);</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">var</span> _context;</span><br><span class="line">            <span class="keyword">var</span> _x = <span class="variable language_">this</span>.<span class="property">_x</span>;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">function</span> <span class="title function_">_next0</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> _fn1 = _x[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">var</span> _hasResult1 = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">var</span> _promise1 = <span class="title function_">_fn1</span>(args1, args2);</span><br><span class="line">                <span class="keyword">if</span> (!_promise1 || !_promise1.<span class="property">then</span>)</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Tap function (tapPromise) did not return promise (returned &#x27;</span> + _promise1 + <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">                _promise1.<span class="title function_">then</span>(<span class="function"><span class="params">_result1</span> =&gt;</span> &#123;</span><br><span class="line">                    _hasResult1 = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (_result1 !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                        args1 = _result1;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="title function_">_resolve</span>(args1);</span><br><span class="line">                &#125;, <span class="function"><span class="params">_err1</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (_hasResult1) <span class="keyword">throw</span> _err1;</span><br><span class="line">                    <span class="title function_">_error</span>(_err1);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">var</span> _fn0 = _x[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">var</span> _hasResult0 = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">var</span> _promise0 = <span class="title function_">_fn0</span>(args1, args2);</span><br><span class="line">            <span class="keyword">if</span> (!_promise0 || !_promise0.<span class="property">then</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Tap function (tapPromise) did not return promise (returned &#x27;</span> + _promise0 + <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">            _promise0.<span class="title function_">then</span>(<span class="function"><span class="params">_result0</span> =&gt;</span> &#123;</span><br><span class="line">                _hasResult0 = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (_result0 !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                    args1 = _result0;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="title function_">_next0</span>();</span><br><span class="line">            &#125;, <span class="function"><span class="params">_err0</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (_hasResult0) <span class="keyword">throw</span> _err0;</span><br><span class="line">                <span class="title function_">_error</span>(_err0);</span><br><span class="line">            &#125;);</span><br><span class="line">            _sync = <span class="literal">false</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)(...args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>webpack</category>
      </categories>
      <tags>
        <tag>webpack</tag>
        <tag>tapable</tag>
      </tags>
  </entry>
  <entry>
    <title>javascript outline</title>
    <url>/2022/10/25/javascript-outline/</url>
    <content><![CDATA[<h1 id="var"><a href="#var" class="headerlink" title="var"></a>var</h1><ul>
<li>å˜é‡æå‡</li>
<li>é‡å¤å£°æ˜</li>
<li>å…¨å±€ä½œç”¨åŸŸç»‘å®š</li>
</ul>
<h1 id="letã€const"><a href="#letã€const" class="headerlink" title="letã€const"></a>letã€const</h1><ul>
<li>ä¸å†æ‹¥æœ‰ var çš„ç¼ºé™·ç‰¹æ€§</li>
<li>TDZ(ä¸´æ—¶æ­»åŒº)</li>
<li>å—çº§ä½œç”¨åŸŸç»‘å®š</li>
</ul>
<h1 id="let"><a href="#let" class="headerlink" title="let"></a>let</h1><ul>
<li>å˜é‡å£°æ˜</li>
</ul>
<h1 id="const"><a href="#const" class="headerlink" title="const"></a>const</h1><ul>
<li>å¸¸é‡å£°æ˜</li>
<li>ä¼˜å…ˆå£°æ˜æœ€ä½³å®è·µ</li>
</ul>
]]></content>
      <categories>
        <category>javascript</category>
      </categories>
      <tags>
        <tag>javascript</tag>
        <tag>es6</tag>
        <tag>outline</tag>
      </tags>
  </entry>
</search>
